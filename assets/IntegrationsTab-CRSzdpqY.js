import{c as K,s as b,a4 as O,a5 as $,r as N,u as U,a6 as P,j as e,C as S,a as C,b as k,d as W,e as _,a7 as T,g as y,a8 as G,w as ae,x as te,y as B,z as L,A as ne,E as q,S as re,B as R,f as ie,a9 as le,aa as de,ab as ce,ac as oe,ad as me,ae as ue,af as he,ag as xe,ah as pe,ai as ge,aj as je,ak as fe,al as ye,am as ve,an as be,ao as Ne,ap as we,aq as J,ar as h,as as E,I as z,at as Se,au as Ce,av as ke,K as Q,aw as X,ax as Z,ay as _e,az as Me,aA as Ae,M,aB as ee,p as Pe,q as qe,t as H,v as V}from"./index-Do_w4LOL.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=K("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=K("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=K("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=K("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=K("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=K("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=K("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=K("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Ue=async s=>{const{data:a,error:t}=await b.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(t)throw t;return a},Re=async(s,a)=>{const{data:t,error:l}=await b.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(l)throw l;return t},Oe=async(s,a)=>{const{data:t,error:l}=await b.from("api_keys").update({status:a}).eq("id",s).select().single();if(l)throw l;return t},Be=({apiKey:s})=>{const[a,t]=N.useState(!1),l=()=>{navigator.clipboard.writeText(s),t(!0),h({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>t(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(y,{variant:"ghost",size:"icon",onClick:l,children:a?e.jsx(J,{className:"h-4 w-4 text-green-500"}):e.jsx(se,{className:"h-4 w-4"})})]})},Qe=()=>{const{organization:s}=O(),a=$(),[t,l]=N.useState(""),[u,d]=N.useState(null),g=["apiKeys",s==null?void 0:s.id],{data:x,isLoading:f}=U({queryKey:g,queryFn:()=>Ue(s.id),enabled:!!s}),i=P({mutationFn:n=>Re(s.id,n),onSuccess:n=>{h({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),d(n),l(""),a.invalidateQueries({queryKey:g})},onError:n=>{h({title:"Error",description:n.message,variant:"destructive"})}}),r=P({mutationFn:({keyId:n,status:j})=>Oe(n,j),onSuccess:()=>{h({title:"Status Updated"}),a.invalidateQueries({queryKey:g})},onError:n=>{h({title:"Error",description:n.message,variant:"destructive"})}}),o=n=>{n.preventDefault(),t.trim()&&s&&i.mutate(t.trim())};return e.jsxs(S,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Ke,{})," API Keys"]}),e.jsx(W,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(_,{children:[e.jsxs("form",{onSubmit:o,className:"flex items-center gap-2 mb-6",children:[e.jsx(T,{placeholder:"New key name (e.g., 'SMS Integration')",value:t,onChange:n=>l(n.target.value),disabled:i.isPending}),e.jsxs(y,{type:"submit",disabled:!t.trim()||i.isPending,children:[i.isPending?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Te,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(ae,{children:[e.jsx(te,{children:e.jsxs(B,{children:[e.jsx(L,{children:"Name"}),e.jsx(L,{children:"Key Prefix"}),e.jsx(L,{children:"Status"}),e.jsx(L,{children:"Last Used"}),e.jsx(L,{children:"Created"}),e.jsx(L,{className:"text-right",children:"Actions"})]})}),e.jsx(ne,{children:f?Array.from({length:3}).map((n,j)=>e.jsx(B,{children:e.jsx(q,{colSpan:6,children:e.jsx(re,{className:"h-8 w-full"})})},j)):x&&x.length>0?x.map(n=>e.jsxs(B,{children:[e.jsx(q,{className:"font-medium",children:n.key_name}),e.jsx(q,{children:e.jsxs("code",{children:[n.key_prefix,"..."]})}),e.jsx(q,{children:e.jsx(R,{variant:n.status==="active"?"default":"secondary",children:n.status})}),e.jsx(q,{children:n.last_used_at?`${ie(new Date(n.last_used_at))} ago`:"Never"}),e.jsx(q,{children:le(new Date(n.created_at),"MMM d, yyyy")}),e.jsx(q,{className:"text-right",children:e.jsxs(de,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",disabled:r.isPending,children:n.status==="active"?e.jsx(Ie,{className:"h-4 w-4"}):e.jsx(Le,{className:"h-4 w-4"})})}),e.jsxs(oe,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Are you sure?"}),e.jsxs(he,{children:["This will ",n.status==="active"?"deactivate":"activate"," the API key.",n.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(xe,{children:[e.jsx(pe,{children:"Cancel"}),e.jsx(ge,{onClick:()=>r.mutate({keyId:n.id,status:n.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},n.id)):e.jsx(B,{children:e.jsx(q,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(je,{open:!!u,onOpenChange:n=>!n&&d(null),children:e.jsxs(fe,{children:[e.jsxs(ye,{children:[e.jsx(ve,{children:"API Key Created Successfully"}),e.jsx(be,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Be,{apiKey:u||""}),e.jsx(Ne,{children:e.jsx(we,{asChild:!0,children:e.jsx(y,{children:"Close"})})})]})})]})]})},Ye=({organization:s,currentSettings:a,onSettingsUpdate:t})=>{var o,n,j,v;const[l,u]=N.useState(((o=a==null?void 0:a.sms_settings)==null?void 0:o.username)||""),[d,g]=N.useState(""),[x,f]=N.useState((a==null?void 0:a.sms_sender_id)||""),i=P({mutationFn:async()=>{const{data:m,error:p}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:x.trim(),username:l.trim(),apiKey:d.trim()}});if(p)throw p;return m},onSuccess:()=>{h({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),g(""),t()},onError:m=>{h({title:"Error saving settings",description:m.message,variant:"destructive"})}}),r=m=>{var p;if(m.preventDefault(),!l.trim()){h({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!d.trim()&&!((p=a==null?void 0:a.sms_settings)!=null&&p.apiKey)){h({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}i.mutate()};return e.jsxs(S,{className:"mt-4",children:[e.jsx(C,{children:e.jsx(k,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(_,{children:e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-username",children:"Username *"}),e.jsx(T,{id:"at-username",value:l,onChange:m=>u(m.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(T,{id:"at-sender-id",value:x,onChange:m=>f(m.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(T,{id:"at-api-key",type:"password",value:d,onChange:m=>g(m.target.value),placeholder:(n=a==null?void 0:a.sms_settings)!=null&&n.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((j=a==null?void 0:a.sms_settings)!=null&&j.apiKey)}),((v=a==null?void 0:a.sms_settings)==null?void 0:v.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(z,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{type:"submit",disabled:i.isPending,className:"flex items-center gap-2",children:[i.isPending?e.jsx(G,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(y,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},$e=({enabled:s,onToggle:a,isLoading:t})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(Se,{checked:s,onCheckedChange:a,disabled:t})]}),ze=({webhookSecret:s,isVisible:a})=>{const[t,l]=N.useState(!1),d=`https://rigurrwjiaucodxuuzeh.supabase.co/functions/v1/handle-sms-webhook?secret=${s}`,g=async()=>{try{await navigator.clipboard.writeText(d),h({title:"Webhook URL copied to clipboard"})}catch(x){console.error("Failed to copy webhook URL:",x),h({title:"Failed to copy URL",description:"Please copy the URL manually",variant:"destructive"})}};return!a||!s?null:e.jsxs(S,{children:[e.jsx(C,{children:e.jsx(k,{className:"text-sm font-medium",children:"SMS Webhook URL"})}),e.jsxs(_,{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use this URL in your SMS provider's webhook configuration to receive incoming SMS messages."}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{value:t?d:"•".repeat(50),readOnly:!0,className:"font-mono text-xs"}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>l(!t),children:t?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(ke,{className:"w-4 h-4"})}),e.jsx(y,{variant:"outline",size:"sm",onClick:g,children:e.jsx(se,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," POST"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Content-Type:"})," application/x-www-form-urlencoded or application/json"]})]})]})]})},He=({providers:s,selectedProvider:a,onProviderSelect:t})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(l=>{const u=l.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===l.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>l.status==="available"&&t(a===l.id?null:l.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:l.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:l.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(R,{variant:"default",children:"Available"}),a===l.id&&e.jsx(J,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(R,{variant:"secondary",children:"Coming Soon"})})]})},l.id)})]}),Ve=()=>{const{organization:s}=O(),a=$(),[t,l]=N.useState(""),[u,d]=N.useState(""),[g,x]=N.useState(""),[f,i]=N.useState(!1),{data:r,isLoading:o}=U({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:c,error:w}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(w)throw w;return c},enabled:!!(s!=null&&s.id)}),n=P({mutationFn:async({phoneNumber:c,name:w})=>{const{data:A,error:I}=await b.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:c.trim(),name:(w==null?void 0:w.trim())||null}).select().single();if(I)throw I;return A},onSuccess:()=>{h({title:"Phone number added successfully"}),l(""),d(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:c=>{h({title:"Error adding phone number",description:c.message,variant:"destructive"})}}),j=P({mutationFn:async c=>{const{data:w,error:A}=await b.from("sms_phone_numbers").insert(c.map(({phoneNumber:I,name:D})=>({organization_id:s.id,phone_number:I.trim(),name:(D==null?void 0:D.trim())||null})));if(A)throw A;return w},onSuccess:()=>{h({title:"Phone numbers added successfully"}),x(""),i(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:c=>{h({title:"Error adding phone numbers",description:c.message,variant:"destructive"})}}),v=P({mutationFn:async c=>{const{error:w}=await b.from("sms_phone_numbers").delete().eq("id",c);if(w)throw w},onSuccess:()=>{h({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:c=>{h({title:"Error removing phone number",description:c.message,variant:"destructive"})}}),m=c=>{c.preventDefault(),t.trim()&&n.mutate({phoneNumber:t,name:u})},p=()=>{const w=g.split(`
`).filter(A=>A.trim()).map(A=>{const I=A.split(",").map(D=>D.trim());return{phoneNumber:I[0],name:I[1]||void 0}}).filter(A=>A.phoneNumber);if(w.length===0){h({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}j.mutate(w)},F=c=>c.startsWith("+")?c:`+${c}`;return o?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers (",(r==null?void 0:r.length)||0,")"]})}),e.jsxs(_,{className:"space-y-6",children:[e.jsx("form",{onSubmit:m,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(T,{id:"phone-number",value:t,onChange:c=>l(c.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(T,{id:"name",value:u,onChange:c=>d(c.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{type:"submit",disabled:n.isPending,className:"w-full",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{variant:"outline",onClick:()=>i(!f),children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),f&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(Z,{id:"bulk-numbers",value:g,onChange:c=>x(c.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{onClick:p,disabled:j.isPending,children:"Add All Numbers"}),e.jsx(y,{variant:"outline",onClick:()=>i(!1),children:"Cancel"})]})]}),r&&r.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:r.map(c=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:F(c.phone_number)}),c.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:c.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(R,{variant:c.status==="active"?"default":"secondary",children:c.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(c.created_at).toLocaleDateString()]})]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>v.mutate(c.id),disabled:v.isPending,children:e.jsx(_e,{className:"w-4 h-4"})})]},c.id))})]}):e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]})]})]})},We=()=>{const{organization:s}=O(),a=$(),{data:t,isLoading:l,error:u}=U({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS campaigns for organization:",s.id);const{data:r,error:o}=await b.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(o)throw console.error("Error fetching SMS campaigns:",o),o;return console.log("SMS campaigns fetched:",(r==null?void 0:r.length)||0),r||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),{data:d,isLoading:g,error:x}=U({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS phone numbers for organization:",s.id);const{data:r,error:o}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(o)throw console.error("Error fetching SMS phone numbers:",o),o;return console.log("SMS phone numbers fetched:",(r==null?void 0:r.length)||0),r||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),f=P({mutationFn:async({name:r,template:o})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!r.trim())throw new Error("Campaign name is required");if(!o.trim())throw new Error("Message template is required");console.log("Creating SMS campaign:",{name:r,template:o,orgId:s.id});const{data:n,error:j}=await b.from("sms_campaigns").insert({organization_id:s.id,name:r.trim(),message_template:o.trim(),total_recipients:(d==null?void 0:d.length)||0}).select().single();if(j)throw console.error("Error creating SMS campaign:",j),j;return console.log("SMS campaign created:",n),n},onSuccess:()=>{h({title:"Campaign created successfully"}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:r=>{console.error("Create campaign error:",r),h({title:"Error creating campaign",description:r.message||"An unexpected error occurred",variant:"destructive"})}}),i=P({mutationFn:async({campaignId:r,isResend:o=!1})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!d||d.length===0)throw new Error("No active phone numbers found");const n=t==null?void 0:t.find(p=>p.id===r);if(!n)throw new Error("Campaign not found");console.log("Sending SMS campaign:",{campaignId:r,isResend:o,recipientCount:d.length}),await b.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",r);let j=d.map(p=>p.phone_number);if(o){const{data:p}=await b.from("sms_sends").select("phone_number").eq("campaign_id",r).eq("status","failed");if(p&&p.length>0)j=p.map(F=>F.phone_number);else throw new Error("No failed sends to retry for this campaign")}const{data:v,error:m}=await b.functions.invoke("send-sms",{body:{phoneNumbers:j,message:n.message_template,organizationId:s.id,campaignId:r}});if(m)throw console.error("Error sending SMS campaign:",m),new Error(m.message||"Failed to send campaign");return console.log("SMS campaign sent successfully:",v),v},onSuccess:(r,o)=>{const n=o.isResend?"Resent":"Sent";h({title:`Campaign ${n.toLowerCase()} successfully`,description:`${n} to ${r.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:r=>{console.error("Send campaign error:",r),h({title:"Error sending campaign",description:r.message||"An unexpected error occurred",variant:"destructive"})}});return{campaigns:t||[],campaignsLoading:l,campaignsError:u,phoneNumbers:d||[],phoneNumbersLoading:g,phoneNumbersError:x,createCampaignMutation:f,sendCampaignMutation:i,organization:s}},Ge=({onSubmit:s,onCancel:a,isLoading:t,phoneNumbersCount:l,organizationName:u})=>{const[d,g]=N.useState(""),[x,f]=N.useState(""),i=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${u||"Your Company"}`,r=o=>{o.preventDefault(),!(!d.trim()||!x.trim())&&(s(d,x),g(""),f(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:r,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(T,{id:"campaign-name",value:d,onChange:o=>g(o.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(Z,{id:"message-template",value:x,onChange:o=>f(o.target.value),placeholder:i,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",l," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:t,children:"Create Campaign"}),e.jsx(y,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},Je=({campaign:s,onSend:a,onResend:t,isLoading:l})=>{const u=d=>{switch(d){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:u(s.status),children:s.status}),s.status==="draft"&&e.jsxs(y,{size:"sm",onClick:()=>a(s.id),disabled:l,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>t(s.id),disabled:l,children:[e.jsx(Me,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:s.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:s.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:s.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]})},Xe=({campaigns:s,onSend:a,onResend:t,isLoading:l})=>s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),s.map(u=>e.jsx(Je,{campaign:u,onSend:a,onResend:t,isLoading:l},u.id))]}),Ze=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),es=()=>{const[s,a]=N.useState(!1),{campaigns:t,campaignsLoading:l,campaignsError:u,phoneNumbers:d,phoneNumbersLoading:g,phoneNumbersError:x,createCampaignMutation:f,sendCampaignMutation:i,organization:r}=We(),o=(v,m)=>{f.mutate({name:v,template:m},{onSuccess:()=>{a(!1)}})},n=v=>{i.mutate({campaignId:v})},j=v=>{i.mutate({campaignId:v,isResend:!0})};return l||g?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):u||x?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(z,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(u==null?void 0:u.message)||(x==null?void 0:x.message)||"An unexpected error occurred"})]})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns (",t.length,")"]}),e.jsxs(y,{onClick:()=>a(!0),disabled:d.length===0,children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(_,{className:"space-y-6",children:d.length===0?e.jsx(Ze,{}):e.jsxs(e.Fragment,{children:[s&&e.jsx(Ge,{onSubmit:o,onCancel:()=>a(!1),isLoading:f.isPending,phoneNumbersCount:d.length,organizationName:r==null?void 0:r.name}),e.jsx(Xe,{campaigns:t,onSend:n,onResend:j,isLoading:i.isPending})]})})]})},ss=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:M,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:M,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:M,status:"coming_soon"}],Y=(s,a)=>{if(!s||typeof s!="object")return"";const t=s[a];return typeof t=="string"?t:""},as=s=>{if(!s||typeof s!="object")return!1;const a=Y(s,"username"),t=Y(s,"apiKey");return a.length>0&&t.length>0},ts=()=>{const{organization:s,isLoading:a,error:t}=O(),{isAdmin:l,isOrgAdmin:u}=ee(),d=$(),[g,x]=N.useState(null),f=l||u;if(a)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});if(t||!s)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(z,{className:"w-5 h-5 text-red-500"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Organization not found or failed to load"}),e.jsx("p",{className:"text-xs text-gray-500",children:(t==null?void 0:t.message)||"Unable to load organization data"})]})})]});const{data:i,isLoading:r,error:o}=U({queryKey:["organization-sms-settings",s.id],queryFn:async()=>{console.log("Fetching SMS settings for organization:",s.id);const{data:m,error:p}=await b.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(p)throw console.error("Error fetching organization SMS settings:",p),p;return console.log("Organization SMS settings fetched:",m),m},enabled:!!(s!=null&&s.id)&&f,retry:3,retryDelay:1e3}),n=P({mutationFn:async m=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:m,orgId:s.id});const{data:p,error:F}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:m,senderId:(i==null?void 0:i.sms_sender_id)||"",username:Y(i==null?void 0:i.sms_settings,"username"),apiKey:Y(i==null?void 0:i.sms_settings,"apiKey")}});if(F)throw console.error("SMS status update error:",F),new Error(F.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",p),p},onSuccess:()=>{h({title:"SMS status updated successfully"}),d.invalidateQueries({queryKey:["organization-sms-settings",s.id]})},onError:m=>{console.error("SMS toggle error:",m),h({title:"Error updating SMS status",description:m.message||"An unexpected error occurred",variant:"destructive"})}}),j=m=>{if(!f){h({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}if(!(s!=null&&s.id)){h({title:"Error",description:"Organization not found",variant:"destructive"});return}n.mutate(m)};if(!f)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]});if(r)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});if(o)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Failed to load SMS settings"}),e.jsx("button",{onClick:()=>d.invalidateQueries({queryKey:["organization-sms-settings",s.id]}),className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]});const v=(i==null?void 0:i.sms_enabled)&&as(i==null?void 0:i.sms_settings);return e.jsxs(S,{children:[e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(W,{children:"Enable SMS feedback collection from your customers"})]}),e.jsxs(_,{className:"space-y-6",children:[e.jsx($e,{enabled:(i==null?void 0:i.sms_enabled)||!1,onToggle:j,isLoading:n.isPending}),(i==null?void 0:i.sms_enabled)&&e.jsx(ze,{webhookSecret:(i==null?void 0:i.webhook_secret)||"",isVisible:!0}),e.jsx(He,{providers:ss,selectedProvider:g,onProviderSelect:x}),g==="africastalking"&&e.jsx(Ye,{organization:s,currentSettings:i,onSettingsUpdate:()=>{d.invalidateQueries({queryKey:["organization-sms-settings",s.id]})}}),v&&e.jsx("div",{className:"mt-6",children:e.jsxs(Pe,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(qe,{className:"grid w-full grid-cols-2",children:[e.jsx(H,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx(H,{value:"campaigns",children:"Campaigns"})]}),e.jsx(V,{value:"phone-numbers",className:"mt-6",children:e.jsx(Ve,{})}),e.jsx(V,{value:"campaigns",className:"mt-6",children:e.jsx(es,{})})]})})]})]})},rs=()=>{const{isAdmin:s,isOrgAdmin:a}=ee();return O(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ts,{}),e.jsx(Qe,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{rs as IntegrationsTab,rs as default};
