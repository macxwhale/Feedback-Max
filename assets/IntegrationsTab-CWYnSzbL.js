import{c as E,s as g,a4 as B,a5 as $,r as b,u as R,a6 as K,j as e,C as _,a as M,b as q,d as H,e as A,a7 as L,g as y,a8 as G,w as ae,x as te,y as O,z as D,A as ne,E as T,S as ie,B as U,f as re,a9 as le,aa as de,ab as ce,ac as oe,ad as me,ae as ue,af as he,ag as xe,ah as pe,ai as je,aj as ge,ak as ye,al as fe,am as ve,an as be,ao as Ne,ap as we,aq as J,ar as o,as as I,I as X,at as Ce,K as Y,au as Z,av as z,aw as ke,M as F,ax as _e,ay as Ae,az as ee,p as Se,q as Pe,t as V,v as W,aA as Me}from"./index-DS28eXWk.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=E("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=E("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=E("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=E("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=E("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=E("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=E("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=E("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Re=async s=>{const{data:a,error:d}=await g.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(d)throw d;return a},Ue=async(s,a)=>{const{data:d,error:l}=await g.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(l)throw l;return d},Be=async(s,a)=>{const{data:d,error:l}=await g.from("api_keys").update({status:a}).eq("id",s).select().single();if(l)throw l;return d},Oe=({apiKey:s})=>{const[a,d]=b.useState(!1),l=()=>{navigator.clipboard.writeText(s),d(!0),o({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>d(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(y,{variant:"ghost",size:"icon",onClick:l,children:a?e.jsx(J,{className:"h-4 w-4 text-green-500"}):e.jsx(Ke,{className:"h-4 w-4"})})]})},Qe=()=>{const{organization:s}=B(),a=$(),[d,l]=b.useState(""),[x,v]=b.useState(null),p=["apiKeys",s==null?void 0:s.id],{data:r,isLoading:u}=R({queryKey:p,queryFn:()=>Re(s.id),enabled:!!s}),h=K({mutationFn:t=>Ue(s.id,t),onSuccess:t=>{o({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),v(t),l(""),a.invalidateQueries({queryKey:p})},onError:t=>{o({title:"Error",description:t.message,variant:"destructive"})}}),c=K({mutationFn:({keyId:t,status:j})=>Be(t,j),onSuccess:()=>{o({title:"Status Updated"}),a.invalidateQueries({queryKey:p})},onError:t=>{o({title:"Error",description:t.message,variant:"destructive"})}}),k=t=>{t.preventDefault(),d.trim()&&s&&h.mutate(d.trim())};return e.jsxs(_,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(M,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(Ie,{})," API Keys"]}),e.jsx(H,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(A,{children:[e.jsxs("form",{onSubmit:k,className:"flex items-center gap-2 mb-6",children:[e.jsx(L,{placeholder:"New key name (e.g., 'SMS Integration')",value:d,onChange:t=>l(t.target.value),disabled:h.isPending}),e.jsxs(y,{type:"submit",disabled:!d.trim()||h.isPending,children:[h.isPending?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(ae,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(D,{children:"Name"}),e.jsx(D,{children:"Key Prefix"}),e.jsx(D,{children:"Status"}),e.jsx(D,{children:"Last Used"}),e.jsx(D,{children:"Created"}),e.jsx(D,{className:"text-right",children:"Actions"})]})}),e.jsx(ne,{children:u?Array.from({length:3}).map((t,j)=>e.jsx(O,{children:e.jsx(T,{colSpan:6,children:e.jsx(ie,{className:"h-8 w-full"})})},j)):r&&r.length>0?r.map(t=>e.jsxs(O,{children:[e.jsx(T,{className:"font-medium",children:t.key_name}),e.jsx(T,{children:e.jsxs("code",{children:[t.key_prefix,"..."]})}),e.jsx(T,{children:e.jsx(U,{variant:t.status==="active"?"default":"secondary",children:t.status})}),e.jsx(T,{children:t.last_used_at?`${re(new Date(t.last_used_at))} ago`:"Never"}),e.jsx(T,{children:le(new Date(t.created_at),"MMM d, yyyy")}),e.jsx(T,{className:"text-right",children:e.jsxs(de,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",disabled:c.isPending,children:t.status==="active"?e.jsx(Ee,{className:"h-4 w-4"}):e.jsx(Le,{className:"h-4 w-4"})})}),e.jsxs(oe,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Are you sure?"}),e.jsxs(he,{children:["This will ",t.status==="active"?"deactivate":"activate"," the API key.",t.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(xe,{children:[e.jsx(pe,{children:"Cancel"}),e.jsx(je,{onClick:()=>c.mutate({keyId:t.id,status:t.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},t.id)):e.jsx(O,{children:e.jsx(T,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(ge,{open:!!x,onOpenChange:t=>!t&&v(null),children:e.jsxs(ye,{children:[e.jsxs(fe,{children:[e.jsx(ve,{children:"API Key Created Successfully"}),e.jsx(be,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Oe,{apiKey:x||""}),e.jsx(Ne,{children:e.jsx(we,{asChild:!0,children:e.jsx(y,{children:"Close"})})})]})})]})]})},Ye=({organization:s,currentSettings:a,onSettingsUpdate:d})=>{var k,t,j,S;const[l,x]=b.useState(((k=a==null?void 0:a.sms_settings)==null?void 0:k.username)||""),[v,p]=b.useState(""),[r,u]=b.useState((a==null?void 0:a.sms_sender_id)||""),h=K({mutationFn:async()=>{const{data:f,error:n}=await g.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:r.trim(),username:l.trim(),apiKey:v.trim()}});if(n)throw n;return f},onSuccess:()=>{o({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),p(""),d()},onError:f=>{o({title:"Error saving settings",description:f.message,variant:"destructive"})}}),c=f=>{var n;if(f.preventDefault(),!l.trim()){o({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!v.trim()&&!((n=a==null?void 0:a.sms_settings)!=null&&n.apiKey)){o({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}h.mutate()};return e.jsxs(_,{className:"mt-4",children:[e.jsx(M,{children:e.jsx(q,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(A,{children:e.jsxs("form",{onSubmit:c,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"at-username",children:"Username *"}),e.jsx(L,{id:"at-username",value:l,onChange:f=>x(f.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(L,{id:"at-sender-id",value:r,onChange:f=>u(f.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(L,{id:"at-api-key",type:"password",value:v,onChange:f=>p(f.target.value),placeholder:(t=a==null?void 0:a.sms_settings)!=null&&t.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((j=a==null?void 0:a.sms_settings)!=null&&j.apiKey)}),((S=a==null?void 0:a.sms_settings)==null?void 0:S.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(X,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{type:"submit",disabled:h.isPending,className:"flex items-center gap-2",children:[h.isPending?e.jsx(G,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(y,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},$e=({enabled:s,onToggle:a,isLoading:d})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(Ce,{checked:s,onCheckedChange:a,disabled:d})]}),He=({webhookSecret:s,isVisible:a})=>a?e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(X,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium",children:"SMS Webhook URL:"})]}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-md",children:e.jsx("code",{className:"text-sm break-all",children:`${window.location.origin}/functions/v1/handle-sms-webhook/${s}`})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use this URL as your SMS webhook endpoint in your provider's dashboard"})]}):null,Ve=({providers:s,selectedProvider:a,onProviderSelect:d})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(l=>{const x=l.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===l.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>l.status==="available"&&d(a===l.id?null:l.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(x,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:l.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:l.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(U,{variant:"default",children:"Available"}),a===l.id&&e.jsx(J,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(U,{variant:"secondary",children:"Coming Soon"})})]})},l.id)})]}),We=()=>{const{organization:s}=B(),a=$(),[d,l]=b.useState(""),[x,v]=b.useState(""),[p,r]=b.useState(""),[u,h]=b.useState(!1),{data:c,isLoading:k}=R({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:i,error:m}=await g.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(m)throw m;return i},enabled:!!(s!=null&&s.id)}),t=K({mutationFn:async({phoneNumber:i,name:m})=>{const{data:C,error:P}=await g.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:i.trim(),name:(m==null?void 0:m.trim())||null}).select().single();if(P)throw P;return C},onSuccess:()=>{o({title:"Phone number added successfully"}),l(""),v(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:i=>{o({title:"Error adding phone number",description:i.message,variant:"destructive"})}}),j=K({mutationFn:async i=>{const{data:m,error:C}=await g.from("sms_phone_numbers").insert(i.map(({phoneNumber:P,name:w})=>({organization_id:s.id,phone_number:P.trim(),name:(w==null?void 0:w.trim())||null})));if(C)throw C;return m},onSuccess:()=>{o({title:"Phone numbers added successfully"}),r(""),h(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:i=>{o({title:"Error adding phone numbers",description:i.message,variant:"destructive"})}}),S=K({mutationFn:async i=>{const{error:m}=await g.from("sms_phone_numbers").delete().eq("id",i);if(m)throw m},onSuccess:()=>{o({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:i=>{o({title:"Error removing phone number",description:i.message,variant:"destructive"})}}),f=i=>{i.preventDefault(),d.trim()&&t.mutate({phoneNumber:d,name:x})},n=()=>{const m=p.split(`
`).filter(C=>C.trim()).map(C=>{const P=C.split(",").map(w=>w.trim());return{phoneNumber:P[0],name:P[1]||void 0}}).filter(C=>C.phoneNumber);if(m.length===0){o({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}j.mutate(m)},N=i=>i.startsWith("+")?i:`+${i}`;return k?e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(Y,{className:"w-5 h-5"}),"Phone Numbers (",(c==null?void 0:c.length)||0,")"]})}),e.jsxs(A,{className:"space-y-6",children:[e.jsx("form",{onSubmit:f,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(L,{id:"phone-number",value:d,onChange:i=>l(i.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(L,{id:"name",value:x,onChange:i=>v(i.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{type:"submit",disabled:t.isPending,className:"w-full",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{variant:"outline",onClick:()=>h(!u),children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),u&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(z,{id:"bulk-numbers",value:p,onChange:i=>r(i.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{onClick:n,disabled:j.isPending,children:"Add All Numbers"}),e.jsx(y,{variant:"outline",onClick:()=>h(!1),children:"Cancel"})]})]}),c&&c.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:c.map(i=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:N(i.phone_number)}),i.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:i.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(U,{variant:i.status==="active"?"default":"secondary",children:i.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(i.created_at).toLocaleDateString()]})]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>S.mutate(i.id),disabled:S.isPending,children:e.jsx(ke,{className:"w-4 h-4"})})]},i.id))})]}):e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Y,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]})]})]})},Ge=()=>{const{organization:s}=B(),a=$(),[d,l]=b.useState(!1),[x,v]=b.useState(""),[p,r]=b.useState(""),{data:u,isLoading:h}=R({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{const{data:n,error:N}=await g.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(N)throw N;return n},enabled:!!(s!=null&&s.id)}),{data:c}=R({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:n,error:N}=await g.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(N)throw N;return n},enabled:!!(s!=null&&s.id)}),k=K({mutationFn:async({name:n,template:N})=>{const{data:i,error:m}=await g.from("sms_campaigns").insert({organization_id:s.id,name:n.trim(),message_template:N.trim(),total_recipients:(c==null?void 0:c.length)||0}).select().single();if(m)throw m;return i},onSuccess:()=>{o({title:"Campaign created successfully"}),v(""),r(""),l(!1),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:n=>{o({title:"Error creating campaign",description:n.message,variant:"destructive"})}}),t=K({mutationFn:async({campaignId:n,isResend:N=!1})=>{if(!c||c.length===0)throw new Error("No active phone numbers found");const i=u==null?void 0:u.find(w=>w.id===n);if(!i)throw new Error("Campaign not found");await g.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",n);let m=c.map(w=>w.phone_number);if(N){const{data:w}=await g.from("sms_sends").select("phone_number").eq("campaign_id",n).eq("status","failed");if(w&&w.length>0)m=w.map(se=>se.phone_number);else throw new Error("No failed sends to retry for this campaign")}const{data:C,error:P}=await g.functions.invoke("send-sms",{body:{phoneNumbers:m,message:i.message_template,organizationId:s.id,campaignId:n}});if(P)throw P;return C},onSuccess:(n,N)=>{const i=N.isResend?"Resent":"Sent";o({title:`Campaign ${i.toLowerCase()} successfully`,description:`${i} to ${n.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:n=>{o({title:"Error sending campaign",description:n.message,variant:"destructive"})}}),j=n=>{n.preventDefault(),!(!x.trim()||!p.trim())&&k.mutate({name:x,template:p})},S=n=>{switch(n){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};if(h)return e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});const f=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${(s==null?void 0:s.name)||"Your Company"}`;return e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"SMS Campaigns (",(u==null?void 0:u.length)||0,")"]}),e.jsxs(y,{onClick:()=>l(!0),disabled:!c||c.length===0,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(A,{className:"space-y-6",children:!c||c.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Y,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}):e.jsxs(e.Fragment,{children:[d&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:j,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(I,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(L,{id:"campaign-name",value:x,onChange:n=>v(n.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(I,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(z,{id:"message-template",value:p,onChange:n=>r(n.target.value),placeholder:f,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",c.length," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:k.isPending,children:"Create Campaign"}),e.jsx(y,{type:"button",variant:"outline",onClick:()=>l(!1),children:"Cancel"})]})]})]}),u&&u.length>0?e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),u.map(n=>e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:n.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(n.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{variant:S(n.status),children:n.status}),n.status==="draft"&&e.jsxs(y,{size:"sm",onClick:()=>t.mutate({campaignId:n.id}),disabled:t.isPending,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),n.status==="completed"&&n.failed_count>0&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>t.mutate({campaignId:n.id,isResend:!0}),disabled:t.isPending,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:n.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:n.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:n.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:n.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:n.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]},n.id))]}):e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Ae,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]})]})})]})},Je=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:F,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:F,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:F,status:"coming_soon"}],Q=(s,a)=>s&&typeof s=="object"&&!Array.isArray(s)&&s[a]||"",Xe=()=>{const{organization:s}=B(),{isAdmin:a,isOrgAdmin:d}=ee(),l=$(),[x,v]=b.useState(null),p=a||d,{data:r,isLoading:u}=R({queryKey:["organization-sms",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return null;const{data:t,error:j}=await g.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(j)throw j;return t},enabled:!!(s!=null&&s.id)&&p}),h=K({mutationFn:async t=>{const{data:j,error:S}=await g.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:t,senderId:(r==null?void 0:r.sms_sender_id)||"",username:Q(r==null?void 0:r.sms_settings,"username"),apiKey:Q(r==null?void 0:r.sms_settings,"apiKey")}});if(S)throw S;return j},onSuccess:()=>{o({title:"SMS status updated successfully"}),l.invalidateQueries({queryKey:["organization-sms",s==null?void 0:s.id]})},onError:t=>{o({title:"Error updating SMS status",description:t.message,variant:"destructive"})}}),c=t=>{h.mutate(t)};if(!p)return e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(A,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]});if(u)return e.jsxs(_,{children:[e.jsx(M,{children:e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});const k=(r==null?void 0:r.sms_enabled)&&Q(r==null?void 0:r.sms_settings,"username")&&Q(r==null?void 0:r.sms_settings,"apiKey");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(_,{children:[e.jsxs(M,{children:[e.jsxs(q,{className:"flex items-center gap-2",children:[e.jsx(F,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(H,{children:"Enable SMS feedback collection from your customers"})]}),e.jsxs(A,{className:"space-y-4",children:[e.jsx($e,{enabled:(r==null?void 0:r.sms_enabled)||!1,onToggle:c,isLoading:h.isPending}),e.jsx(He,{webhookSecret:(r==null?void 0:r.webhook_secret)||"",isVisible:(r==null?void 0:r.sms_enabled)||!1}),e.jsx(Ve,{providers:Je,selectedProvider:x,onProviderSelect:v}),x==="africastalking"&&e.jsx(Ye,{organization:s,currentSettings:r,onSettingsUpdate:()=>{l.invalidateQueries({queryKey:["organization-sms",s==null?void 0:s.id]})}})]})]}),k&&e.jsx(_,{children:e.jsx(A,{className:"p-0",children:e.jsxs(Se,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsx("div",{className:"px-6 pt-6",children:e.jsxs(Pe,{className:"grid w-full grid-cols-2",children:[e.jsx(V,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx(V,{value:"campaigns",children:"Campaigns"})]})}),e.jsx(W,{value:"phone-numbers",className:"px-6 pb-6",children:e.jsx(We,{})}),e.jsx(W,{value:"campaigns",className:"px-6 pb-6",children:e.jsx(Ge,{})})]})})})]})},Ze=()=>e.jsxs(_,{children:[e.jsxs(M,{children:[e.jsx(q,{children:"CRM Integration"}),e.jsx(H,{children:"Connect to your favorite CRM."})]}),e.jsx(A,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"CRM integrations are coming soon."})})]}),es=()=>{const{isAdmin:s,isOrgAdmin:a}=ee();return B(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(Xe,{}),e.jsx(Me,{}),e.jsx(Qe,{}),e.jsx(Ze,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{es as IntegrationsTab,es as default};
