import{c as K,s as g,a4 as U,a5 as Y,r as b,u as R,a6 as A,j as e,C as N,a as _,b as S,d as $,e as w,a7 as F,g as y,a8 as W,w as se,x as ae,y as B,z as E,A as te,E as P,S as ne,B as D,f as ie,a9 as re,aa as le,ab as de,ac as ce,ad as oe,ae as me,af as ue,ag as he,ah as xe,ai as pe,aj as je,ak as ge,al as ye,am as fe,an as be,ao as ve,ap as Ne,aq as G,ar as p,as as M,I as J,at as we,K as Q,au as X,av as Z,aw as Ce,ax as ke,ay as _e,M as q,az as z,p as Se,q as Ae,t as H,v as V,aA as Pe}from"./index-Bcb6WQ5i.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Me=K("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=K("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=K("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=K("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=K("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=K("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=K("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=K("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Re=async s=>{const{data:a,error:i}=await g.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(i)throw i;return a},De=async(s,a)=>{const{data:i,error:r}=await g.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(r)throw r;return i},Ue=async(s,a)=>{const{data:i,error:r}=await g.from("api_keys").update({status:a}).eq("id",s).select().single();if(r)throw r;return i},Be=({apiKey:s})=>{const[a,i]=b.useState(!1),r=()=>{navigator.clipboard.writeText(s),i(!0),p({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>i(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(y,{variant:"ghost",size:"icon",onClick:r,children:a?e.jsx(G,{className:"h-4 w-4 text-green-500"}):e.jsx(qe,{className:"h-4 w-4"})})]})},Oe=()=>{const{organization:s}=U(),a=Y(),[i,r]=b.useState(""),[d,u]=b.useState(null),j=["apiKeys",s==null?void 0:s.id],{data:t,isLoading:o}=R({queryKey:j,queryFn:()=>Re(s.id),enabled:!!s}),c=A({mutationFn:n=>De(s.id,n),onSuccess:n=>{p({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),u(n),r(""),a.invalidateQueries({queryKey:j})},onError:n=>{p({title:"Error",description:n.message,variant:"destructive"})}}),m=A({mutationFn:({keyId:n,status:x})=>Ue(n,x),onSuccess:()=>{p({title:"Status Updated"}),a.invalidateQueries({queryKey:j})},onError:n=>{p({title:"Error",description:n.message,variant:"destructive"})}}),h=n=>{n.preventDefault(),i.trim()&&s&&c.mutate(i.trim())};return e.jsxs(N,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(_,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(Te,{})," API Keys"]}),e.jsx($,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(w,{children:[e.jsxs("form",{onSubmit:h,className:"flex items-center gap-2 mb-6",children:[e.jsx(F,{placeholder:"New key name (e.g., 'SMS Integration')",value:i,onChange:n=>r(n.target.value),disabled:c.isPending}),e.jsxs(y,{type:"submit",disabled:!i.trim()||c.isPending,children:[c.isPending?e.jsx(W,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Me,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(B,{children:[e.jsx(E,{children:"Name"}),e.jsx(E,{children:"Key Prefix"}),e.jsx(E,{children:"Status"}),e.jsx(E,{children:"Last Used"}),e.jsx(E,{children:"Created"}),e.jsx(E,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:o?Array.from({length:3}).map((n,x)=>e.jsx(B,{children:e.jsx(P,{colSpan:6,children:e.jsx(ne,{className:"h-8 w-full"})})},x)):t&&t.length>0?t.map(n=>e.jsxs(B,{children:[e.jsx(P,{className:"font-medium",children:n.key_name}),e.jsx(P,{children:e.jsxs("code",{children:[n.key_prefix,"..."]})}),e.jsx(P,{children:e.jsx(D,{variant:n.status==="active"?"default":"secondary",children:n.status})}),e.jsx(P,{children:n.last_used_at?`${ie(new Date(n.last_used_at))} ago`:"Never"}),e.jsx(P,{children:re(new Date(n.created_at),"MMM d, yyyy")}),e.jsx(P,{className:"text-right",children:e.jsxs(le,{children:[e.jsx(de,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",disabled:m.isPending,children:n.status==="active"?e.jsx(Fe,{className:"h-4 w-4"}):e.jsx(Ee,{className:"h-4 w-4"})})}),e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(me,{children:"Are you sure?"}),e.jsxs(ue,{children:["This will ",n.status==="active"?"deactivate":"activate"," the API key.",n.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(he,{children:[e.jsx(xe,{children:"Cancel"}),e.jsx(pe,{onClick:()=>m.mutate({keyId:n.id,status:n.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},n.id)):e.jsx(B,{children:e.jsx(P,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(je,{open:!!d,onOpenChange:n=>!n&&u(null),children:e.jsxs(ge,{children:[e.jsxs(ye,{children:[e.jsx(fe,{children:"API Key Created Successfully"}),e.jsx(be,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Be,{apiKey:d||""}),e.jsx(ve,{children:e.jsx(Ne,{asChild:!0,children:e.jsx(y,{children:"Close"})})})]})})]})]})},Qe=({organization:s,currentSettings:a,onSettingsUpdate:i})=>{var h,n,x,C;const[r,d]=b.useState(((h=a==null?void 0:a.sms_settings)==null?void 0:h.username)||""),[u,j]=b.useState(""),[t,o]=b.useState((a==null?void 0:a.sms_sender_id)||""),c=A({mutationFn:async()=>{const{data:v,error:T}=await g.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:t.trim(),username:r.trim(),apiKey:u.trim()}});if(T)throw T;return v},onSuccess:()=>{p({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),j(""),i()},onError:v=>{p({title:"Error saving settings",description:v.message,variant:"destructive"})}}),m=v=>{var T;if(v.preventDefault(),!r.trim()){p({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!u.trim()&&!((T=a==null?void 0:a.sms_settings)!=null&&T.apiKey)){p({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}c.mutate()};return e.jsxs(N,{className:"mt-4",children:[e.jsx(_,{children:e.jsx(S,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(w,{children:e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"at-username",children:"Username *"}),e.jsx(F,{id:"at-username",value:r,onChange:v=>d(v.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(F,{id:"at-sender-id",value:t,onChange:v=>o(v.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(F,{id:"at-api-key",type:"password",value:u,onChange:v=>j(v.target.value),placeholder:(n=a==null?void 0:a.sms_settings)!=null&&n.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((x=a==null?void 0:a.sms_settings)!=null&&x.apiKey)}),((C=a==null?void 0:a.sms_settings)==null?void 0:C.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(J,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{type:"submit",disabled:c.isPending,className:"flex items-center gap-2",children:[c.isPending?e.jsx(W,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(y,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Ke,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},Ye=({enabled:s,onToggle:a,isLoading:i})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(we,{checked:s,onCheckedChange:a,disabled:i})]}),$e=({webhookSecret:s,isVisible:a})=>a?e.jsxs("div",{className:"space-y-4 pt-4 border-t",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium",children:"SMS Webhook URL:"})]}),e.jsx("div",{className:"p-3 bg-gray-50 rounded-md",children:e.jsx("code",{className:"text-sm break-all",children:`${window.location.origin}/functions/v1/handle-sms-webhook/${s}`})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use this URL as your SMS webhook endpoint in your provider's dashboard"})]}):null,He=({providers:s,selectedProvider:a,onProviderSelect:i})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(r=>{const d=r.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===r.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>r.status==="available"&&i(a===r.id?null:r.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(d,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:r.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:r.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(D,{variant:"default",children:"Available"}),a===r.id&&e.jsx(G,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(D,{variant:"secondary",children:"Coming Soon"})})]})},r.id)})]}),Ve=()=>{const{organization:s}=U(),a=Y(),[i,r]=b.useState(""),[d,u]=b.useState(""),[j,t]=b.useState(""),[o,c]=b.useState(!1),{data:m,isLoading:h}=R({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:l,error:f}=await g.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(f)throw f;return l},enabled:!!(s!=null&&s.id)}),n=A({mutationFn:async({phoneNumber:l,name:f})=>{const{data:k,error:I}=await g.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:l.trim(),name:(f==null?void 0:f.trim())||null}).select().single();if(I)throw I;return k},onSuccess:()=>{p({title:"Phone number added successfully"}),r(""),u(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:l=>{p({title:"Error adding phone number",description:l.message,variant:"destructive"})}}),x=A({mutationFn:async l=>{const{data:f,error:k}=await g.from("sms_phone_numbers").insert(l.map(({phoneNumber:I,name:L})=>({organization_id:s.id,phone_number:I.trim(),name:(L==null?void 0:L.trim())||null})));if(k)throw k;return f},onSuccess:()=>{p({title:"Phone numbers added successfully"}),t(""),c(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:l=>{p({title:"Error adding phone numbers",description:l.message,variant:"destructive"})}}),C=A({mutationFn:async l=>{const{error:f}=await g.from("sms_phone_numbers").delete().eq("id",l);if(f)throw f},onSuccess:()=>{p({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:l=>{p({title:"Error removing phone number",description:l.message,variant:"destructive"})}}),v=l=>{l.preventDefault(),i.trim()&&n.mutate({phoneNumber:i,name:d})},T=()=>{const f=j.split(`
`).filter(k=>k.trim()).map(k=>{const I=k.split(",").map(L=>L.trim());return{phoneNumber:I[0],name:I[1]||void 0}}).filter(k=>k.phoneNumber);if(f.length===0){p({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}x.mutate(f)},ee=l=>l.startsWith("+")?l:`+${l}`;return h?e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(w,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers (",(m==null?void 0:m.length)||0,")"]})}),e.jsxs(w,{className:"space-y-6",children:[e.jsx("form",{onSubmit:v,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(F,{id:"phone-number",value:i,onChange:l=>r(l.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(F,{id:"name",value:d,onChange:l=>u(l.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{type:"submit",disabled:n.isPending,className:"w-full",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{variant:"outline",onClick:()=>c(!o),children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),o&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(Z,{id:"bulk-numbers",value:j,onChange:l=>t(l.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{onClick:T,disabled:x.isPending,children:"Add All Numbers"}),e.jsx(y,{variant:"outline",onClick:()=>c(!1),children:"Cancel"})]})]}),m&&m.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:m.map(l=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:ee(l.phone_number)}),l.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:l.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(D,{variant:l.status==="active"?"default":"secondary",children:l.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(l.created_at).toLocaleDateString()]})]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>C.mutate(l.id),disabled:C.isPending,children:e.jsx(Ce,{className:"w-4 h-4"})})]},l.id))})]}):e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]})]})]})},We=()=>{const{organization:s}=U(),a=Y(),{data:i,isLoading:r}=R({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{const{data:t,error:o}=await g.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(o)throw o;return t},enabled:!!(s!=null&&s.id)}),{data:d}=R({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:t,error:o}=await g.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(o)throw o;return t},enabled:!!(s!=null&&s.id)}),u=A({mutationFn:async({name:t,template:o})=>{const{data:c,error:m}=await g.from("sms_campaigns").insert({organization_id:s.id,name:t.trim(),message_template:o.trim(),total_recipients:(d==null?void 0:d.length)||0}).select().single();if(m)throw m;return c},onSuccess:()=>{p({title:"Campaign created successfully"}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:t=>{p({title:"Error creating campaign",description:t.message,variant:"destructive"})}}),j=A({mutationFn:async({campaignId:t,isResend:o=!1})=>{if(!d||d.length===0)throw new Error("No active phone numbers found");const c=i==null?void 0:i.find(x=>x.id===t);if(!c)throw new Error("Campaign not found");await g.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",t);let m=d.map(x=>x.phone_number);if(o){const{data:x}=await g.from("sms_sends").select("phone_number").eq("campaign_id",t).eq("status","failed");if(x&&x.length>0)m=x.map(C=>C.phone_number);else throw new Error("No failed sends to retry for this campaign")}const{data:h,error:n}=await g.functions.invoke("send-sms",{body:{phoneNumbers:m,message:c.message_template,organizationId:s.id,campaignId:t}});if(n)throw n;return h},onSuccess:(t,o)=>{const c=o.isResend?"Resent":"Sent";p({title:`Campaign ${c.toLowerCase()} successfully`,description:`${c} to ${t.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:t=>{p({title:"Error sending campaign",description:t.message,variant:"destructive"})}});return{campaigns:i,campaignsLoading:r,phoneNumbers:d,createCampaignMutation:u,sendCampaignMutation:j,organization:s}},Ge=({onSubmit:s,onCancel:a,isLoading:i,phoneNumbersCount:r,organizationName:d})=>{const[u,j]=b.useState(""),[t,o]=b.useState(""),c=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${d||"Your Company"}`,m=h=>{h.preventDefault(),!(!u.trim()||!t.trim())&&(s(u,t),j(""),o(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(M,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(F,{id:"campaign-name",value:u,onChange:h=>j(h.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(M,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(Z,{id:"message-template",value:t,onChange:h=>o(h.target.value),placeholder:c,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",r," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:i,children:"Create Campaign"}),e.jsx(y,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},Je=({campaign:s,onSend:a,onResend:i,isLoading:r})=>{const d=u=>{switch(u){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{variant:d(s.status),children:s.status}),s.status==="draft"&&e.jsxs(y,{size:"sm",onClick:()=>a(s.id),disabled:r,children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:r,children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:s.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:s.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:s.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]})},Xe=({campaigns:s,onSend:a,onResend:i,isLoading:r})=>s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(_e,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),s.map(d=>e.jsx(Je,{campaign:d,onSend:a,onResend:i,isLoading:r},d.id))]}),Ze=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),ze=()=>{const[s,a]=b.useState(!1),{campaigns:i,campaignsLoading:r,phoneNumbers:d,createCampaignMutation:u,sendCampaignMutation:j,organization:t}=We(),o=(h,n)=>{u.mutate({name:h,template:n},{onSuccess:()=>{a(!1)}})},c=h=>{j.mutate({campaignId:h})},m=h=>{j.mutate({campaignId:h,isResend:!0})};return r?e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(w,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"SMS Campaigns (",(i==null?void 0:i.length)||0,")"]}),e.jsxs(y,{onClick:()=>a(!0),disabled:!d||d.length===0,children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(w,{className:"space-y-6",children:!d||d.length===0?e.jsx(Ze,{}):e.jsxs(e.Fragment,{children:[s&&e.jsx(Ge,{onSubmit:o,onCancel:()=>a(!1),isLoading:u.isPending,phoneNumbersCount:d.length,organizationName:t==null?void 0:t.name}),i&&e.jsx(Xe,{campaigns:i,onSend:c,onResend:m,isLoading:j.isPending})]})})]})},es=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:q,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:q,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:q,status:"coming_soon"}],O=(s,a)=>s&&typeof s=="object"&&!Array.isArray(s)&&s[a]||"",ss=()=>{const{organization:s}=U(),{isAdmin:a,isOrgAdmin:i}=z(),r=Y(),[d,u]=b.useState(null),j=a||i,{data:t,isLoading:o}=R({queryKey:["organization-sms",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return null;const{data:n,error:x}=await g.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(x)throw x;return n},enabled:!!(s!=null&&s.id)&&j}),c=A({mutationFn:async n=>{const{data:x,error:C}=await g.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:n,senderId:(t==null?void 0:t.sms_sender_id)||"",username:O(t==null?void 0:t.sms_settings,"username"),apiKey:O(t==null?void 0:t.sms_settings,"apiKey")}});if(C)throw C;return x},onSuccess:()=>{p({title:"SMS status updated successfully"}),r.invalidateQueries({queryKey:["organization-sms",s==null?void 0:s.id]})},onError:n=>{p({title:"Error updating SMS status",description:n.message,variant:"destructive"})}}),m=n=>{c.mutate(n)};if(!j)return e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(w,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]});if(o)return e.jsxs(N,{children:[e.jsx(_,{children:e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(w,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});const h=(t==null?void 0:t.sms_enabled)&&O(t==null?void 0:t.sms_settings,"username")&&O(t==null?void 0:t.sms_settings,"apiKey");return e.jsxs("div",{className:"space-y-6",children:[e.jsxs(N,{children:[e.jsxs(_,{children:[e.jsxs(S,{className:"flex items-center gap-2",children:[e.jsx(q,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx($,{children:"Enable SMS feedback collection from your customers"})]}),e.jsxs(w,{className:"space-y-4",children:[e.jsx(Ye,{enabled:(t==null?void 0:t.sms_enabled)||!1,onToggle:m,isLoading:c.isPending}),e.jsx($e,{webhookSecret:(t==null?void 0:t.webhook_secret)||"",isVisible:(t==null?void 0:t.sms_enabled)||!1}),e.jsx(He,{providers:es,selectedProvider:d,onProviderSelect:u}),d==="africastalking"&&e.jsx(Qe,{organization:s,currentSettings:t,onSettingsUpdate:()=>{r.invalidateQueries({queryKey:["organization-sms",s==null?void 0:s.id]})}})]})]}),h&&e.jsx(N,{children:e.jsx(w,{className:"p-0",children:e.jsxs(Se,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsx("div",{className:"px-6 pt-6",children:e.jsxs(Ae,{className:"grid w-full grid-cols-2",children:[e.jsx(H,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx(H,{value:"campaigns",children:"Campaigns"})]})}),e.jsx(V,{value:"phone-numbers",className:"px-6 pb-6",children:e.jsx(Ve,{})}),e.jsx(V,{value:"campaigns",className:"px-6 pb-6",children:e.jsx(ze,{})})]})})})]})},as=()=>e.jsxs(N,{children:[e.jsxs(_,{children:[e.jsx(S,{children:"CRM Integration"}),e.jsx($,{children:"Connect to your favorite CRM."})]}),e.jsx(w,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"CRM integrations are coming soon."})})]}),ns=()=>{const{isAdmin:s,isOrgAdmin:a}=z();return U(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ss,{}),e.jsx(Pe,{}),e.jsx(Oe,{}),e.jsx(as,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{ns as IntegrationsTab,ns as default};
