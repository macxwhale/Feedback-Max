import{c as P,s as C,_ as z,$ as W,r as N,a as V,a0 as q,j as e,C as M,b as F,d as D,e as de,f as A,a1 as E,h as j,a2 as ke,x as _e,y as Me,z as H,A as $,E as Ae,F as U,S as Pe,B as O,g as Fe,a3 as De,a4 as oe,a5 as me,a6 as ue,a7 as he,a8 as xe,a9 as pe,aa as je,ab as ge,ac as fe,ad as Te,ae as qe,af as Ee,ag as Ie,ah as Ke,ai as Le,aj as Re,ak as ye,al as x,M as I,am as K,an as Ue,ao as Be,ap as Oe,aq as ve,ar as $e,J as Ne,as as X,at as be,L as Q,au as we,av as Z,P as Se,T as Ve,H as Ce,k as Qe,aw as ze,ax as se,ay as We,az as He,aA as Ye,aB as Y,aC as Je,aD as Ge,aE as Xe,aF as te,aG as ae,aH as re,aI as ne,aJ as R,q as Ze,t as es,v as ie,w as le}from"./index-BHtc7_0q.js";import{S as ss}from"./switch-SLWl0huE.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=P("ArrowDownWideNarrow",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M11 4h10",key:"1w87gc"}],["path",{d:"M11 8h7",key:"djye34"}],["path",{d:"M11 12h4",key:"q8tih4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=P("ArrowUpNarrowWide",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M11 12h4",key:"q8tih4"}],["path",{d:"M11 16h7",key:"uosisv"}],["path",{d:"M11 20h10",key:"jvxblo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=P("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const J=P("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=P("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=P("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=P("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ce=P("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=P("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=P("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=P("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=P("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=P("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),hs=async s=>{const{data:t,error:a}=await C.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(a)throw a;return t},xs=async(s,t)=>{const{data:a,error:i}=await C.rpc("create_api_key",{p_organization_id:s,p_key_name:t});if(i)throw i;return a},ps=async(s,t)=>{const{data:a,error:i}=await C.from("api_keys").update({status:t}).eq("id",s).select().single();if(i)throw i;return a},js=({apiKey:s})=>{const[t,a]=N.useState(!1),i=()=>{navigator.clipboard.writeText(s),a(!0),x({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>a(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(j,{variant:"ghost",size:"icon",onClick:i,children:t?e.jsx(ye,{className:"h-4 w-4 text-green-500"}):e.jsx(J,{className:"h-4 w-4"})})]})},gs=()=>{const{organization:s}=z(),t=W(),[a,i]=N.useState(""),[n,m]=N.useState(null),c=["apiKeys",s==null?void 0:s.id],{data:d,isLoading:o}=V({queryKey:c,queryFn:()=>hs(s.id),enabled:!!s}),h=q({mutationFn:r=>xs(s.id,r),onSuccess:r=>{x({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),m(r),i(""),t.invalidateQueries({queryKey:c})},onError:r=>{x({title:"Error",description:r.message,variant:"destructive"})}}),l=q({mutationFn:({keyId:r,status:g})=>ps(r,g),onSuccess:()=>{x({title:"Status Updated"}),t.invalidateQueries({queryKey:c})},onError:r=>{x({title:"Error",description:r.message,variant:"destructive"})}}),u=r=>{r.preventDefault(),a.trim()&&s&&h.mutate(a.trim())};return e.jsxs(M,{className:"w-full",children:[e.jsxs(F,{children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(ls,{})," API Keys"]}),e.jsx(de,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(A,{children:[e.jsxs("form",{onSubmit:u,className:"flex items-center gap-2 mb-6",children:[e.jsx(E,{placeholder:"New key name (e.g., 'SMS Integration')",value:a,onChange:r=>i(r.target.value),disabled:h.isPending}),e.jsxs(j,{type:"submit",disabled:!a.trim()||h.isPending,children:[h.isPending?e.jsx(ke,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(rs,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(_e,{children:[e.jsx(Me,{children:e.jsxs(H,{children:[e.jsx($,{children:"Name"}),e.jsx($,{children:"Key Prefix"}),e.jsx($,{children:"Status"}),e.jsx($,{children:"Last Used"}),e.jsx($,{children:"Created"}),e.jsx($,{className:"text-right",children:"Actions"})]})}),e.jsx(Ae,{children:o?Array.from({length:3}).map((r,g)=>e.jsx(H,{children:e.jsx(U,{colSpan:6,children:e.jsx(Pe,{className:"h-8 w-full"})})},g)):d&&d.length>0?d.map(r=>e.jsxs(H,{children:[e.jsx(U,{className:"font-medium",children:r.key_name}),e.jsx(U,{children:e.jsxs("code",{children:[r.key_prefix,"..."]})}),e.jsx(U,{children:e.jsx(O,{variant:r.status==="active"?"default":"secondary",children:r.status})}),e.jsx(U,{children:r.last_used_at?`${Fe(new Date(r.last_used_at))} ago`:"Never"}),e.jsx(U,{children:De(new Date(r.created_at),"MMM d, yyyy")}),e.jsx(U,{className:"text-right",children:e.jsxs(oe,{children:[e.jsx(me,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"icon",disabled:l.isPending,children:r.status==="active"?e.jsx(cs,{className:"h-4 w-4"}):e.jsx(ds,{className:"h-4 w-4"})})}),e.jsxs(ue,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Are you sure?"}),e.jsxs(pe,{children:["This will ",r.status==="active"?"deactivate":"activate"," the API key.",r.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(je,{children:[e.jsx(ge,{children:"Cancel"}),e.jsx(fe,{onClick:()=>l.mutate({keyId:r.id,status:r.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},r.id)):e.jsx(H,{children:e.jsx(U,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(Te,{open:!!n,onOpenChange:r=>!r&&m(null),children:e.jsxs(qe,{children:[e.jsxs(Ee,{children:[e.jsx(Ie,{children:"API Key Created Successfully"}),e.jsx(Ke,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(js,{apiKey:n||""}),e.jsx(Le,{children:e.jsx(Re,{asChild:!0,children:e.jsx(j,{children:"Close"})})})]})})]})]})},fs=({organization:s,currentSettings:t,onSettingsUpdate:a})=>{var o,h;const i=W(),[n,m]=N.useState({username:((o=t==null?void 0:t.sms_settings)==null?void 0:o.username)||"",apiKey:((h=t==null?void 0:t.sms_settings)==null?void 0:h.apiKey)||"",senderId:(t==null?void 0:t.sms_sender_id)||""}),c=q({mutationFn:async l=>{const{data:u,error:r}=await C.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:!0,senderId:l.senderId,username:l.username,apiKey:l.apiKey}});if(r)throw r;return u},onSuccess:()=>{x({title:"Success",description:"SMS settings updated successfully"}),i.invalidateQueries({queryKey:["organization-sms-settings"]}),a()},onError:l=>{x({title:"Error",description:l.message||"Failed to update SMS settings",variant:"destructive"})}}),d=l=>{if(l.preventDefault(),!n.username.trim()||!n.apiKey.trim()||!n.senderId.trim()){x({title:"Validation Error",description:"Please fill in all required fields",variant:"destructive"});return}c.mutate(n)};return e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Provider Settings"]})}),e.jsx(A,{children:e.jsxs("form",{onSubmit:d,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(K,{htmlFor:"username",children:"Username *"}),e.jsx(E,{id:"username",type:"text",value:n.username,onChange:l=>m(u=>({...u,username:l.target.value})),placeholder:"Enter your SMS provider username",required:!0})]}),e.jsxs("div",{children:[e.jsx(K,{htmlFor:"apiKey",children:"API Key *"}),e.jsx(E,{id:"apiKey",type:"password",value:n.apiKey,onChange:l=>m(u=>({...u,apiKey:l.target.value})),placeholder:"Enter your SMS provider API key",required:!0})]}),e.jsxs("div",{children:[e.jsx(K,{htmlFor:"senderId",children:"Sender ID *"}),e.jsx(E,{id:"senderId",type:"text",value:n.senderId,onChange:l=>m(u=>({...u,senderId:l.target.value})),placeholder:"Enter your sender ID (e.g., 12345)",required:!0}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"This is your SMS sender identifier that recipients will see"})]}),e.jsxs(j,{type:"submit",disabled:c.isPending,className:"w-full",children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),c.isPending?"Saving...":"Save Settings"]})]})})]})},ys=({enabled:s,onToggle:t,isLoading:a})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(ss,{checked:s,onCheckedChange:t,disabled:a})]}),vs=({webhookSecret:s,isVisible:t,isFlaskWrapper:a=!1})=>{const[i,n]=N.useState(!1),d=`${window.location.origin}${a?"/functions/v1/handle-flask-sms-callback":"/functions/v1/handle-sms-webhook"}`,o=h=>{navigator.clipboard.writeText(h),x({title:"Copied to clipboard",description:"Webhook URL has been copied to your clipboard"})};return t?e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-5 h-5"}),a?"Flask Webhook Configuration":"SMS Webhook Configuration"]})}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Webhook URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{value:d,readOnly:!0,className:"font-mono text-sm"}),e.jsx(j,{onClick:()=>o(d),variant:"outline",size:"icon",children:e.jsx(J,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a?"Configure your Flask wrapper to send callbacks to this URL":"Configure this URL in your Africa's Talking SMS callback settings"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(K,{children:"Webhook Secret"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(E,{type:i?"text":"password",value:s,readOnly:!0,className:"font-mono text-sm"}),e.jsx(j,{onClick:()=>n(!i),variant:"outline",size:"icon",type:"button",children:i?e.jsx(Oe,{className:"w-4 h-4"}):e.jsx(ve,{className:"w-4 h-4"})}),e.jsx(j,{onClick:()=>o(s),variant:"outline",size:"icon",children:e.jsx(J,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use this secret to verify webhook authenticity"})]}),a&&e.jsx("div",{className:"p-4 bg-muted rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx($e,{className:"w-5 h-5 text-blue-500 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:"Flask Integration Notes:"}),e.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"• Your Flask wrapper should forward SMS callbacks to the webhook URL above"}),e.jsx("li",{children:"• Include the webhook secret in your callback validation"}),e.jsxs("li",{children:["• Ensure the callback format matches: ","{linkId, text, to, id, date, from}"]}),e.jsx("li",{children:"• The 'to' field should contain your organization's sender ID"})]})]})]})})]})]}):null},Ns=({selectedProvider:s,onProviderSelect:t})=>{const a={id:"sms-provider",name:"SMS Provider (Flask Wrapper)",description:"SMS services via Flask wrapper integration",icon:I,status:"available"};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"SMS Integration"}),e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${s===a.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>t(s===a.id?null:a.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(a.icon,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:a.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(O,{variant:"default",children:"Available"}),s===a.id&&e.jsx(ye,{className:"w-4 h-4 text-blue-500"})]})]})})]})},G=(s,t)=>{if(!s||typeof s!="object")return"";const a=s[t];return typeof a=="string"?a:""},bs=s=>{if(!s||typeof s!="object")return!1;const t=G(s,"username"),a=G(s,"apiKey");return t.length>0&&a.length>0},ws=()=>e.jsxs(F,{children:[e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(de,{children:"Enable SMS feedback collection from your customers"})]}),Ss=({title:s="SMS Integrations"})=>e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),s]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}),Cs=({title:s="SMS Integrations",message:t,onRetry:a})=>e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(Ne,{className:"w-5 h-5 text-red-500"}),s]})}),e.jsx(A,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Organization not found or failed to load"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:t}),a&&e.jsx("button",{onClick:a,className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]}),ks=()=>e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(A,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]}),_s=({phoneNumber:s,name:t,onPhoneNumberChange:a,onNameChange:i,onSubmit:n,isLoading:m})=>e.jsx("form",{onSubmit:n,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(K,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(E,{id:"phone-number",value:s,onChange:c=>a(c.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(K,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(E,{id:"name",value:t,onChange:c=>i(c.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(j,{type:"submit",disabled:m,className:"w-full",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),Ms=({bulkNumbers:s,onBulkNumbersChange:t,onBulkAdd:a,onCancel:i,isLoading:n})=>e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(K,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(be,{id:"bulk-numbers",value:s,onChange:m=>t(m.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{onClick:a,disabled:n,children:"Add All Numbers"}),e.jsx(j,{variant:"outline",onClick:i,children:"Cancel"})]})]}),As=({phoneNumbers:s,onDelete:t,isDeleting:a})=>{const i=n=>n.startsWith("+")?n:`+${n}`;return s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:s.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:i(n.phone_number)}),n.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:n.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(O,{variant:n.status==="active"?"default":"secondary",children:n.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(n.created_at).toLocaleDateString()]})]})]}),e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>t(n.id),disabled:a,children:e.jsx(we,{className:"w-4 h-4"})})]},n.id))})]})},Ps=()=>{const{organization:s}=z(),t=W(),[a,i]=N.useState(""),[n,m]=N.useState(""),[c,d]=N.useState(""),[o,h]=N.useState(!1),{data:l,isLoading:u}=V({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:p,error:y}=await C.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(y)throw y;return p},enabled:!!(s!=null&&s.id)}),r=q({mutationFn:async({phoneNumber:p,name:y})=>{const{data:k,error:S}=await C.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:p.trim(),name:(y==null?void 0:y.trim())||null}).select().single();if(S)throw S;return k},onSuccess:()=>{x({title:"Phone number added successfully"}),i(""),m(""),t.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{x({title:"Error adding phone number",description:p.message,variant:"destructive"})}}),g=q({mutationFn:async p=>{const{data:y,error:k}=await C.from("sms_phone_numbers").insert(p.map(({phoneNumber:S,name:_})=>({organization_id:s.id,phone_number:S.trim(),name:(_==null?void 0:_.trim())||null})));if(k)throw k;return y},onSuccess:()=>{x({title:"Phone numbers added successfully"}),d(""),h(!1),t.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{x({title:"Error adding phone numbers",description:p.message,variant:"destructive"})}}),v=q({mutationFn:async p=>{const{error:y}=await C.from("sms_phone_numbers").delete().eq("id",p);if(y)throw y},onSuccess:()=>{x({title:"Phone number removed successfully"}),t.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{x({title:"Error removing phone number",description:p.message,variant:"destructive"})}}),b=p=>{p.preventDefault(),a.trim()&&r.mutate({phoneNumber:a,name:n})},w=()=>{const y=c.split(`
`).filter(k=>k.trim()).map(k=>{const S=k.split(",").map(_=>_.trim());return{phoneNumber:S[0],name:S[1]||void 0}}).filter(k=>k.phoneNumber);if(y.length===0){x({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}g.mutate(y)};return u?e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(M,{children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(Q,{className:"w-5 h-5"}),"Phone Numbers (",(l==null?void 0:l.length)||0,")"]})}),e.jsxs(A,{className:"space-y-6",children:[e.jsx(_s,{phoneNumber:a,name:n,onPhoneNumberChange:i,onNameChange:m,onSubmit:b,isLoading:r.isPending}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(j,{variant:"outline",onClick:()=>h(!o),children:[e.jsx(us,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),o&&e.jsx(Ms,{bulkNumbers:c,onBulkNumbersChange:d,onBulkAdd:w,onCancel:()=>h(!1),isLoading:g.isPending}),e.jsx(As,{phoneNumbers:l||[],onDelete:p=>v.mutate(p),isDeleting:v.isPending})]})]})},Fs=()=>{const{user:s}=Z(),{organization:t}=z(),a=W(),{data:i=[],isLoading:n,error:m}=V({queryKey:["sms-campaigns",t==null?void 0:t.id],queryFn:async()=>{if(!(t!=null&&t.id))return[];const{data:r,error:g}=await C.from("sms_campaigns").select("*").eq("organization_id",t.id).order("created_at",{ascending:!1});if(g)throw g;return r||[]},enabled:!!(t!=null&&t.id)}),{data:c=[],isLoading:d,error:o}=V({queryKey:["sms-phone-numbers",t==null?void 0:t.id],queryFn:async()=>{if(!(t!=null&&t.id))return[];const{data:r,error:g}=await C.from("sms_phone_numbers").select("*").eq("organization_id",t.id).eq("status","active").order("created_at",{ascending:!1});if(g)throw g;return r||[]},enabled:!!(t!=null&&t.id)}),h=q({mutationFn:async({name:r,template:g})=>{if(!(t!=null&&t.id)||!(s!=null&&s.id))throw new Error("Missing organization or user");const{data:v,error:b}=await C.from("sms_campaigns").insert({organization_id:t.id,name:r,message_template:g,created_by_user_id:s.id,status:"draft"}).select().single();if(b)throw b;return v},onSuccess:()=>{a.invalidateQueries({queryKey:["sms-campaigns"]}),x({title:"Success",description:"Campaign created successfully"})},onError:r=>{console.error("Error creating campaign:",r),x({title:"Error",description:"Failed to create campaign",variant:"destructive"})}}),l=q({mutationFn:async({campaignId:r,isResend:g=!1,isRetry:v=!1})=>{const{data:b,error:w}=await C.functions.invoke("send-sms-flask",{body:{campaignId:r,isResend:g,isRetry:v}});if(w)throw w;return b},onSuccess:r=>{a.invalidateQueries({queryKey:["sms-campaigns"]}),a.invalidateQueries({queryKey:["sms-sends"]}),x({title:"Success",description:`Campaign sent successfully! ${r.sentCount}/${r.sentCount+r.failedCount} messages delivered.`})},onError:r=>{console.error("Error sending campaign:",r),x({title:"Error",description:"Failed to send campaign",variant:"destructive"})}}),u=q({mutationFn:async({campaignId:r,action:g})=>{let v;switch(g){case"pause":v="paused";break;case"resume":v="sending";break;case"cancel":v="cancelled";break;default:throw new Error("Invalid action")}const{error:b}=await C.from("sms_campaigns").update({status:v}).eq("id",r);if(b)throw b},onSuccess:(r,{action:g})=>{a.invalidateQueries({queryKey:["sms-campaigns"]}),x({title:"Success",description:`Campaign ${g}d successfully`})},onError:r=>{console.error("Error controlling campaign:",r),x({title:"Error",description:"Failed to update campaign status",variant:"destructive"})}});return{campaigns:i,campaignsLoading:n,campaignsError:m,phoneNumbers:c,phoneNumbersLoading:d,phoneNumbersError:o,createCampaignMutation:h,sendCampaignMutation:l,campaignControlMutation:u,organization:t}},Ds=({onSubmit:s,onCancel:t,isLoading:a,phoneNumbersCount:i,organizationName:n})=>{const[m,c]=N.useState(""),[d,o]=N.useState(""),h=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${n||"Your Company"}`,l=u=>{u.preventDefault(),!(!m.trim()||!d.trim())&&(s(m,d),c(""),o(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(K,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(E,{id:"campaign-name",value:m,onChange:u=>c(u.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(K,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(be,{id:"message-template",value:d,onChange:u=>o(u.target.value),placeholder:h,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",i," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:a,children:"Create Campaign"}),e.jsx(j,{type:"button",variant:"outline",onClick:t,children:"Cancel"})]})]})]})},Ts=({campaign:s})=>{const t=s.sent_count>0?s.delivered_count/s.sent_count*100:0,a=s.sent_count>0?s.failed_count/s.sent_count*100:0,i=s.total_recipients>0?s.sent_count/s.total_recipients*100:0,n=()=>{if(!s.started_at)return null;const m=new Date(s.started_at),d=(s.completed_at?new Date(s.completed_at):new Date).getTime()-m.getTime(),o=Math.round(d/(1e3*60));return o<60?`${o}m`:`${Math.round(o/60)}h ${o%60}m`};return e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(Q,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:s.sent_count}),e.jsx("div",{className:"text-xs text-blue-600",children:"Sent"}),e.jsx(Se,{value:i,className:"h-1 mt-1"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 rounded-lg",children:[e.jsx(Ve,{className:"w-4 h-4 text-green-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-green-900",children:[t.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-green-600",children:"Delivered"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[s.delivered_count,"/",s.sent_count]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 rounded-lg",children:[e.jsx(Ce,{className:"w-4 h-4 text-red-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-red-900",children:[a.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-red-600",children:"Failed"}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:s.failed_count})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-purple-50 rounded-lg",children:[e.jsx(Qe,{className:"w-4 h-4 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-purple-900",children:n()||"N/A"}),e.jsx("div",{className:"text-xs text-purple-600",children:"Duration"}),e.jsx(O,{variant:"outline",className:"text-xs mt-1",children:s.status})]})]})]})},qs=({campaign:s,onSend:t,onResend:a,onRetry:i,onDuplicate:n,onSchedule:m,onDelete:c,onCancel:d,onPause:o,onResume:h,isLoading:l})=>{const[u,r]=N.useState(!1),g=p=>{switch(p){case"completed":return"default";case"sending":return"secondary";case"paused":return"outline";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}},v=p=>{switch(p){case"completed":return"text-green-600";case"sending":return"text-blue-600";case"paused":return"text-yellow-600";case"failed":return"text-red-600";case"draft":return"text-gray-600";default:return"text-gray-600"}},b=s.total_recipients>0?s.sent_count/s.total_recipients*100:0,w=s.status==="sending"&&s.started_at&&new Date().getTime()-new Date(s.started_at).getTime()>10*60*1e3;return e.jsx(M,{className:"transition-all duration-200 hover:shadow-md",children:e.jsxs(A,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h5",{className:"font-semibold text-lg",children:s.name}),e.jsx(O,{variant:g(s.status),className:v(s.status),children:s.status.charAt(0).toUpperCase()+s.status.slice(1)}),w&&e.jsxs(O,{variant:"destructive",className:"text-orange-700 bg-orange-100",children:[e.jsx(Ce,{className:"w-3 h-3 mr-1"}),"Stuck"]})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Created ",new Date(s.created_at).toLocaleDateString()," • ",s.total_recipients," recipients"]}),(s.status==="sending"||s.status==="paused")&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 mb-1",children:[e.jsx("span",{children:"Progress"}),e.jsxs("span",{children:[s.sent_count,"/",s.total_recipients]})]}),e.jsx(Se,{value:b,className:"h-2"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="draft"&&e.jsxs(j,{size:"sm",onClick:()=>t(s.id),disabled:l,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="sending"&&e.jsxs(e.Fragment,{children:[e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>o(s.id),disabled:l,children:[e.jsx(ze,{className:"w-4 h-4 mr-2"}),"Pause"]}),e.jsxs(j,{size:"sm",variant:"destructive",onClick:()=>d(s.id),disabled:l,children:[e.jsx(ms,{className:"w-4 h-4 mr-2"}),"Cancel"]})]}),s.status==="paused"&&e.jsxs(j,{size:"sm",onClick:()=>h(s.id),disabled:l,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Resume"]}),s.status==="failed"&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:l,children:[e.jsx(os,{className:"w-4 h-4 mr-2"}),"Retry"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>a(s.id),disabled:l,children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Resend Failed"]}),w&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:l,className:"border-orange-500 text-orange-700 hover:bg-orange-50",children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Force Retry"]}),e.jsxs(We,{children:[e.jsx(He,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"sm",children:e.jsx(ns,{className:"w-4 h-4"})})}),e.jsxs(Ye,{align:"end",children:[e.jsxs(Y,{onClick:()=>r(!u),children:[e.jsx(ve,{className:"w-4 h-4 mr-2"}),u?"Hide":"Show"," Analytics"]}),e.jsxs(Y,{onClick:()=>n(s.id),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),"Duplicate Campaign"]}),s.status==="draft"&&e.jsxs(Y,{onClick:()=>m(s.id),children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Schedule Campaign"]}),e.jsx(Ge,{}),e.jsxs(oe,{children:[e.jsx(me,{asChild:!0,children:e.jsxs(Y,{onSelect:p=>p.preventDefault(),className:"text-red-600",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Delete Campaign"]})}),e.jsxs(ue,{children:[e.jsxs(he,{children:[e.jsx(xe,{children:"Delete Campaign"}),e.jsxs(pe,{children:['Are you sure you want to delete "',s.name,'"? This action cannot be undone.']})]}),e.jsxs(je,{children:[e.jsx(ge,{children:"Cancel"}),e.jsx(fe,{onClick:()=>c(s.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 mb-1",children:"Message Preview:"}),e.jsx("p",{className:"text-sm text-blue-800 leading-relaxed",children:s.message_template.length>120?`${s.message_template.substring(0,120)}...`:s.message_template})]})}),u&&e.jsx(Ts,{campaign:s})]})})},Es=({searchTerm:s,onSearchChange:t,statusFilter:a,onStatusFilterChange:i,sortBy:n,onSortByChange:m,sortOrder:c,onSortOrderChange:d,totalCampaigns:o,filteredCount:h})=>{const l=()=>{t(""),i("all"),m("created_at"),d("desc")},u=s||a!=="all";return e.jsxs("div",{className:"w-full space-y-4 p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(is,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Filters"}),u&&e.jsxs(O,{variant:"secondary",className:"text-xs",children:[h," of ",o]})]}),u&&e.jsx(j,{variant:"ghost",size:"sm",onClick:l,children:"Clear All"})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-3",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(E,{placeholder:"Search campaigns...",value:s,onChange:r=>t(r.target.value),className:"pl-10 w-full"})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(te,{value:a,onValueChange:i,children:[e.jsx(ae,{className:"w-full sm:w-[150px]",children:e.jsx(re,{placeholder:"Status"})}),e.jsxs(ne,{children:[e.jsx(R,{value:"all",children:"All Status"}),e.jsx(R,{value:"draft",children:"Draft"}),e.jsx(R,{value:"sending",children:"Sending"}),e.jsx(R,{value:"completed",children:"Completed"}),e.jsx(R,{value:"failed",children:"Failed"})]})]}),e.jsxs(te,{value:n,onValueChange:m,children:[e.jsx(ae,{className:"w-full sm:w-[150px]",children:e.jsx(re,{placeholder:"Sort by"})}),e.jsxs(ne,{children:[e.jsx(R,{value:"created_at",children:"Created Date"}),e.jsx(R,{value:"name",children:"Name"}),e.jsx(R,{value:"total_recipients",children:"Recipients"}),e.jsx(R,{value:"delivered_count",children:"Delivery Rate"})]})]}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>d(c==="asc"?"desc":"asc"),className:"w-full sm:w-auto",children:c==="asc"?e.jsx(as,{className:"w-4 h-4"}):e.jsx(ts,{className:"w-4 h-4"})})]})]})]})},Is=({campaigns:s,onSend:t,onResend:a,onRetry:i,onCancel:n,onPause:m,onResume:c,onDuplicate:d,onSchedule:o,onDelete:h,onCreateNew:l,isLoading:u})=>{const[r,g]=N.useState(""),[v,b]=N.useState("all"),[w,p]=N.useState("created_at"),[y,k]=N.useState("desc"),S=N.useMemo(()=>{let _=s.filter(f=>{const L=f.name.toLowerCase().includes(r.toLowerCase())||f.message_template.toLowerCase().includes(r.toLowerCase()),T=v==="all"||f.status===v;return L&&T});return _.sort((f,L)=>{let T=f[w],B=L[w];if(w==="created_at"&&(T=new Date(T).getTime(),B=new Date(B).getTime()),typeof T=="number"&&typeof B=="number")return y==="asc"?T-B:B-T;if(typeof T=="string"&&typeof B=="string"){const ee=T.localeCompare(B);return y==="asc"?ee:-ee}return 0}),_},[s,r,v,w,y]);return s.length===0?e.jsxs("div",{className:"w-full text-center p-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200",children:[e.jsx(I,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No campaigns yet"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Create your first SMS campaign to start reaching your audience with targeted messages."}),e.jsxs(j,{onClick:l,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"Create Your First Campaign"]})]}):e.jsxs("div",{className:"w-full space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Campaign Management"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.length," campaign",s.length!==1?"s":""," total",S.length!==s.length&&` • ${S.length} shown`]})]}),e.jsxs(j,{onClick:l,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(X,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]}),e.jsx(Es,{searchTerm:r,onSearchChange:g,statusFilter:v,onStatusFilterChange:b,sortBy:w,onSortByChange:p,sortOrder:y,onSortOrderChange:k,totalCampaigns:s.length,filteredCount:S.length}),e.jsx("div",{className:"w-full space-y-4",children:S.length===0?e.jsxs("div",{className:"text-center p-8 bg-gray-50 rounded-lg",children:[e.jsx(I,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-gray-500",children:"No campaigns match your current filters."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Try adjusting your search or filter criteria."})]}):S.map(_=>e.jsx(qs,{campaign:_,onSend:t,onResend:a,onRetry:i,onCancel:n,onPause:m,onResume:c,onDuplicate:d,onSchedule:o,onDelete:h,isLoading:u},_.id))})]})},Ks=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Q,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),Ls=()=>{const[s,t]=N.useState(!1),{campaigns:a,campaignsLoading:i,campaignsError:n,phoneNumbers:m,phoneNumbersLoading:c,phoneNumbersError:d,createCampaignMutation:o,sendCampaignMutation:h,campaignControlMutation:l,organization:u}=Fs(),r=(f,L)=>{o.mutate({name:f,template:L},{onSuccess:()=>{t(!1)}})},g=f=>{h.mutate({campaignId:f})},v=f=>{h.mutate({campaignId:f,isResend:!0})},b=f=>{h.mutate({campaignId:f,isRetry:!0})},w=f=>{l.mutate({campaignId:f,action:"cancel"})},p=f=>{l.mutate({campaignId:f,action:"pause"})},y=f=>{l.mutate({campaignId:f,action:"resume"})},k=f=>{const L=a.find(T=>T.id===f);L&&(o.mutate({name:`${L.name} (Copy)`,template:L.message_template}),x({title:"Campaign duplicated successfully"}))},S=f=>{x({title:"Scheduling feature coming soon",description:"Campaign scheduling will be available in the next update."})},_=f=>{x({title:"Delete feature coming soon",description:"Campaign deletion will be available in the next update."})};return i||c?e.jsx("div",{className:"w-full",children:e.jsxs(M,{className:"w-full",children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]})}):n||d?e.jsx("div",{className:"w-full",children:e.jsxs(M,{className:"w-full",children:[e.jsx(F,{children:e.jsxs(D,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(Ne,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(n==null?void 0:n.message)||(d==null?void 0:d.message)||"An unexpected error occurred"})]})]})})]})}):e.jsx("div",{className:"w-full",children:e.jsxs(M,{className:"w-full",children:[e.jsx(F,{children:e.jsx(D,{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})})}),e.jsx(A,{className:"space-y-6 p-6",children:m.length===0?e.jsx(Ks,{}):e.jsxs("div",{className:"w-full space-y-6",children:[s&&e.jsx("div",{className:"w-full",children:e.jsx(Ds,{onSubmit:r,onCancel:()=>t(!1),isLoading:o.isPending,phoneNumbersCount:m.length,organizationName:u==null?void 0:u.name})}),e.jsx("div",{className:"w-full",children:e.jsx(Is,{campaigns:a,onSend:g,onResend:v,onRetry:b,onCancel:w,onPause:p,onResume:y,onDuplicate:k,onSchedule:S,onDelete:_,onCreateNew:()=>t(!0),isLoading:h.isPending||l.isPending})})]})})]})})},Rs=()=>e.jsx("div",{className:"w-full mt-6",children:e.jsxs(Ze,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(es,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(ie,{value:"phone-numbers",className:"flex-1",children:"Phone Numbers"}),e.jsx(ie,{value:"campaigns",className:"flex-1",children:"Campaigns"})]}),e.jsx(le,{value:"phone-numbers",className:"w-full mt-0",children:e.jsx("div",{className:"w-full",children:e.jsx(Ps,{})})}),e.jsx(le,{value:"campaigns",className:"w-full mt-0",children:e.jsx("div",{className:"w-full",children:e.jsx(Ls,{})})})]})}),Us=()=>{const{organization:s}=z(),t=W(),{data:a,isLoading:i,error:n}=V({queryKey:["organization-sms-settings",s==null?void 0:s.id],queryFn:async()=>{console.log("Fetching SMS settings for organization:",s==null?void 0:s.id);const{data:c,error:d}=await C.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(d)throw console.error("Error fetching organization SMS settings:",d),d;return console.log("Organization SMS settings fetched:",c),c},enabled:!!(s!=null&&s.id),retry:3,retryDelay:1e3}),m=q({mutationFn:async c=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:c,orgId:s.id});const{data:d,error:o}=await C.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:c,senderId:(a==null?void 0:a.sms_sender_id)||"",username:G(a==null?void 0:a.sms_settings,"username"),apiKey:G(a==null?void 0:a.sms_settings,"apiKey")}});if(o)throw console.error("SMS status update error:",o),new Error(o.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",d),d},onSuccess:()=>{x({title:"SMS status updated successfully"}),t.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})},onError:c=>{console.error("SMS toggle error:",c),x({title:"Error updating SMS status",description:c.message||"An unexpected error occurred",variant:"destructive"})}});return{orgData:a,isLoading:i,error:n,updateSmsStatus:m,organization:s}},Bs=()=>{const{isAdmin:s,isOrgAdmin:t}=Z(),[a,i]=N.useState(null),{orgData:n,isLoading:m,error:c,updateSmsStatus:d,organization:o}=Us(),h=s||t,l=r=>{if(!h){x({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}if(!(o!=null&&o.id)){x({title:"Error",description:"Organization not found",variant:"destructive"});return}d.mutate(r)};if(!h)return e.jsx(ks,{});if(m)return e.jsx(Ss,{});if(c){const r=typeof c=="string"?c:"Failed to load SMS settings";return e.jsx(Cs,{message:r})}const u=(n==null?void 0:n.sms_enabled)&&bs(n==null?void 0:n.sms_settings);return e.jsx("div",{className:"w-full",children:e.jsxs(M,{className:"w-full",children:[e.jsx(ws,{}),e.jsxs(A,{className:"space-y-6 p-6",children:[e.jsx(ys,{enabled:(n==null?void 0:n.sms_enabled)||!1,onToggle:l,isLoading:d.isPending}),(n==null?void 0:n.sms_enabled)&&e.jsx(vs,{webhookSecret:(n==null?void 0:n.webhook_secret)||"",isVisible:!0,isFlaskWrapper:!0}),e.jsx(Ns,{selectedProvider:a,onProviderSelect:i}),a==="sms-provider"&&e.jsx(fs,{organization:o,currentSettings:n,onSettingsUpdate:()=>{}}),u&&e.jsx("div",{className:"w-full",children:e.jsx(Rs,{})})]})]})})},Vs=()=>{const{isAdmin:s,isOrgAdmin:t}=Z();return z(),s||t?e.jsxs("div",{className:"w-full space-y-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."})]}),e.jsx("div",{className:"w-full",children:e.jsx(Bs,{})}),e.jsx("div",{className:"w-full",children:e.jsx(gs,{})})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{Vs as IntegrationsTab,Vs as default};
