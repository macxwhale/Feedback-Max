import{c as F,s as y,a4 as O,a5 as Q,r as v,u as D,a6 as A,j as e,C as S,a as C,b as k,d as W,e as _,a7 as T,g as f,a8 as G,w as se,x as ae,y as R,z as I,A as te,E as q,S as ne,B as U,f as re,a9 as ie,aa as le,ab as de,ac as ce,ad as oe,ae as me,af as ue,ag as he,ah as xe,ai as pe,aj as ge,ak as je,al as fe,am as ye,an as be,ao as ve,ap as Ne,aq as J,ar as u,as as E,I as H,at as we,au as Se,av as Ce,M as P,aw as z,ax as X,K as B,ay as ke,az as _e,aA as Me,p as Ae,q as Pe,t as $,v as V,aB as Z}from"./index-DgnxEeMf.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=F("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=F("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=F("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=F("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=F("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=F("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=F("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=F("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),De=async s=>{const{data:a,error:t}=await y.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(t)throw t;return a},Ue=async(s,a)=>{const{data:t,error:r}=await y.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(r)throw r;return t},Oe=async(s,a)=>{const{data:t,error:r}=await y.from("api_keys").update({status:a}).eq("id",s).select().single();if(r)throw r;return t},Re=({apiKey:s})=>{const[a,t]=v.useState(!1),r=()=>{navigator.clipboard.writeText(s),t(!0),u({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>t(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(f,{variant:"ghost",size:"icon",onClick:r,children:a?e.jsx(J,{className:"h-4 w-4 text-green-500"}):e.jsx(ee,{className:"h-4 w-4"})})]})},Be=()=>{const{organization:s}=O(),a=Q(),[t,r]=v.useState(""),[n,d]=v.useState(null),c=["apiKeys",s==null?void 0:s.id],{data:m,isLoading:h}=D({queryKey:c,queryFn:()=>De(s.id),enabled:!!s}),x=A({mutationFn:i=>Ue(s.id,i),onSuccess:i=>{u({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),d(i),r(""),a.invalidateQueries({queryKey:c})},onError:i=>{u({title:"Error",description:i.message,variant:"destructive"})}}),l=A({mutationFn:({keyId:i,status:j})=>Oe(i,j),onSuccess:()=>{u({title:"Status Updated"}),a.invalidateQueries({queryKey:c})},onError:i=>{u({title:"Error",description:i.message,variant:"destructive"})}}),o=i=>{i.preventDefault(),t.trim()&&s&&x.mutate(t.trim())};return e.jsxs(S,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Ee,{})," API Keys"]}),e.jsx(W,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(_,{children:[e.jsxs("form",{onSubmit:o,className:"flex items-center gap-2 mb-6",children:[e.jsx(T,{placeholder:"New key name (e.g., 'SMS Integration')",value:t,onChange:i=>r(i.target.value),disabled:x.isPending}),e.jsxs(f,{type:"submit",disabled:!t.trim()||x.isPending,children:[x.isPending?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(R,{children:[e.jsx(I,{children:"Name"}),e.jsx(I,{children:"Key Prefix"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Last Used"}),e.jsx(I,{children:"Created"}),e.jsx(I,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:h?Array.from({length:3}).map((i,j)=>e.jsx(R,{children:e.jsx(q,{colSpan:6,children:e.jsx(ne,{className:"h-8 w-full"})})},j)):m&&m.length>0?m.map(i=>e.jsxs(R,{children:[e.jsx(q,{className:"font-medium",children:i.key_name}),e.jsx(q,{children:e.jsxs("code",{children:[i.key_prefix,"..."]})}),e.jsx(q,{children:e.jsx(U,{variant:i.status==="active"?"default":"secondary",children:i.status})}),e.jsx(q,{children:i.last_used_at?`${re(new Date(i.last_used_at))} ago`:"Never"}),e.jsx(q,{children:ie(new Date(i.created_at),"MMM d, yyyy")}),e.jsx(q,{className:"text-right",children:e.jsxs(le,{children:[e.jsx(de,{asChild:!0,children:e.jsx(f,{variant:"ghost",size:"icon",disabled:l.isPending,children:i.status==="active"?e.jsx(Ke,{className:"h-4 w-4"}):e.jsx(Ie,{className:"h-4 w-4"})})}),e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(me,{children:"Are you sure?"}),e.jsxs(ue,{children:["This will ",i.status==="active"?"deactivate":"activate"," the API key.",i.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(he,{children:[e.jsx(xe,{children:"Cancel"}),e.jsx(pe,{onClick:()=>l.mutate({keyId:i.id,status:i.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},i.id)):e.jsx(R,{children:e.jsx(q,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(ge,{open:!!n,onOpenChange:i=>!i&&d(null),children:e.jsxs(je,{children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"API Key Created Successfully"}),e.jsx(be,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Re,{apiKey:n||""}),e.jsx(ve,{children:e.jsx(Ne,{asChild:!0,children:e.jsx(f,{children:"Close"})})})]})})]})]})},Ye=({organization:s,currentSettings:a,onSettingsUpdate:t})=>{var o,i,j,N;const[r,n]=v.useState(((o=a==null?void 0:a.sms_settings)==null?void 0:o.username)||""),[d,c]=v.useState(""),[m,h]=v.useState((a==null?void 0:a.sms_sender_id)||""),x=A({mutationFn:async()=>{const{data:g,error:b}=await y.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:m.trim(),username:r.trim(),apiKey:d.trim()}});if(b)throw b;return g},onSuccess:()=>{u({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),c(""),t()},onError:g=>{u({title:"Error saving settings",description:g.message,variant:"destructive"})}}),l=g=>{var b;if(g.preventDefault(),!r.trim()){u({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!d.trim()&&!((b=a==null?void 0:a.sms_settings)!=null&&b.apiKey)){u({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}x.mutate()};return e.jsxs(S,{className:"mt-4",children:[e.jsx(C,{children:e.jsx(k,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(_,{children:e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-username",children:"Username *"}),e.jsx(T,{id:"at-username",value:r,onChange:g=>n(g.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(T,{id:"at-sender-id",value:m,onChange:g=>h(g.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(T,{id:"at-api-key",type:"password",value:d,onChange:g=>c(g.target.value),placeholder:(i=a==null?void 0:a.sms_settings)!=null&&i.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((j=a==null?void 0:a.sms_settings)!=null&&j.apiKey)}),((N=a==null?void 0:a.sms_settings)==null?void 0:N.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(H,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(f,{type:"submit",disabled:x.isPending,className:"flex items-center gap-2",children:[x.isPending?e.jsx(G,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(f,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},Qe=({enabled:s,onToggle:a,isLoading:t})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(we,{checked:s,onCheckedChange:a,disabled:t})]}),He=({webhookSecret:s,isVisible:a})=>{const[t,r]=v.useState(!1),d=`https://rigurrwjiaucodxuuzeh.supabase.co/functions/v1/handle-sms-webhook?secret=${s}`,c=async()=>{try{await navigator.clipboard.writeText(d),u({title:"Webhook URL copied to clipboard"})}catch(m){console.error("Failed to copy webhook URL:",m),u({title:"Failed to copy URL",description:"Please copy the URL manually",variant:"destructive"})}};return!a||!s?null:e.jsxs(S,{children:[e.jsx(C,{children:e.jsx(k,{className:"text-sm font-medium",children:"SMS Webhook URL"})}),e.jsxs(_,{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use this URL in your SMS provider's webhook configuration to receive incoming SMS messages."}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{value:t?d:"•".repeat(50),readOnly:!0,className:"font-mono text-xs"}),e.jsx(f,{variant:"outline",size:"sm",onClick:()=>r(!t),children:t?e.jsx(Se,{className:"w-4 h-4"}):e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx(f,{variant:"outline",size:"sm",onClick:c,children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," POST"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Content-Type:"})," application/x-www-form-urlencoded or application/json"]})]})]})]})},$e=({providers:s,selectedProvider:a,onProviderSelect:t})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(r=>{const n=r.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===r.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>r.status==="available"&&t(a===r.id?null:r.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:r.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:r.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:r.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(U,{variant:"default",children:"Available"}),a===r.id&&e.jsx(J,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(U,{variant:"secondary",children:"Coming Soon"})})]})},r.id)})]}),Ve=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:P,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:P,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:P,status:"coming_soon"}],Y=(s,a)=>{if(!s||typeof s!="object")return"";const t=s[a];return typeof t=="string"?t:""},We=s=>{if(!s||typeof s!="object")return!1;const a=Y(s,"username"),t=Y(s,"apiKey");return a.length>0&&t.length>0},Ge=()=>e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(W,{children:"Enable SMS feedback collection from your customers"})]}),Je=({title:s="SMS Integrations"})=>e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),s]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}),ze=({title:s="SMS Integrations",message:a,onRetry:t})=>e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-red-500"}),s]})}),e.jsx(_,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Organization not found or failed to load"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:a}),t&&e.jsx("button",{onClick:t,className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]}),Xe=()=>e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]}),Ze=({phoneNumber:s,name:a,onPhoneNumberChange:t,onNameChange:r,onSubmit:n,isLoading:d})=>e.jsx("form",{onSubmit:n,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(T,{id:"phone-number",value:s,onChange:c=>t(c.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(T,{id:"name",value:a,onChange:c=>r(c.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(f,{type:"submit",disabled:d,className:"w-full",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),es=({bulkNumbers:s,onBulkNumbersChange:a,onBulkAdd:t,onCancel:r,isLoading:n})=>e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(X,{id:"bulk-numbers",value:s,onChange:d=>a(d.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{onClick:t,disabled:n,children:"Add All Numbers"}),e.jsx(f,{variant:"outline",onClick:r,children:"Cancel"})]})]}),ss=({phoneNumbers:s,onDelete:a,isDeleting:t})=>{const r=n=>n.startsWith("+")?n:`+${n}`;return s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:s.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:r(n.phone_number)}),n.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:n.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(U,{variant:n.status==="active"?"default":"secondary",children:n.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(n.created_at).toLocaleDateString()]})]})]}),e.jsx(f,{variant:"ghost",size:"sm",onClick:()=>a(n.id),disabled:t,children:e.jsx(ke,{className:"w-4 h-4"})})]},n.id))})]})},as=()=>{const{organization:s}=O(),a=Q(),[t,r]=v.useState(""),[n,d]=v.useState(""),[c,m]=v.useState(""),[h,x]=v.useState(!1),{data:l,isLoading:o}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:p,error:w}=await y.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(w)throw w;return p},enabled:!!(s!=null&&s.id)}),i=A({mutationFn:async({phoneNumber:p,name:w})=>{const{data:M,error:K}=await y.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:p.trim(),name:(w==null?void 0:w.trim())||null}).select().single();if(K)throw K;return M},onSuccess:()=>{u({title:"Phone number added successfully"}),r(""),d(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{u({title:"Error adding phone number",description:p.message,variant:"destructive"})}}),j=A({mutationFn:async p=>{const{data:w,error:M}=await y.from("sms_phone_numbers").insert(p.map(({phoneNumber:K,name:L})=>({organization_id:s.id,phone_number:K.trim(),name:(L==null?void 0:L.trim())||null})));if(M)throw M;return w},onSuccess:()=>{u({title:"Phone numbers added successfully"}),m(""),x(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{u({title:"Error adding phone numbers",description:p.message,variant:"destructive"})}}),N=A({mutationFn:async p=>{const{error:w}=await y.from("sms_phone_numbers").delete().eq("id",p);if(w)throw w},onSuccess:()=>{u({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:p=>{u({title:"Error removing phone number",description:p.message,variant:"destructive"})}}),g=p=>{p.preventDefault(),t.trim()&&i.mutate({phoneNumber:t,name:n})},b=()=>{const w=c.split(`
`).filter(M=>M.trim()).map(M=>{const K=M.split(",").map(L=>L.trim());return{phoneNumber:K[0],name:K[1]||void 0}}).filter(M=>M.phoneNumber);if(w.length===0){u({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}j.mutate(w)};return o?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers (",(l==null?void 0:l.length)||0,")"]})}),e.jsxs(_,{className:"space-y-6",children:[e.jsx(Ze,{phoneNumber:t,name:n,onPhoneNumberChange:r,onNameChange:d,onSubmit:g,isLoading:i.isPending}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(f,{variant:"outline",onClick:()=>x(!h),children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),h&&e.jsx(es,{bulkNumbers:c,onBulkNumbersChange:m,onBulkAdd:b,onCancel:()=>x(!1),isLoading:j.isPending}),e.jsx(ss,{phoneNumbers:l||[],onDelete:p=>N.mutate(p),isDeleting:N.isPending})]})]})},ts=()=>{const{organization:s}=O(),a=Q(),{data:t,isLoading:r,error:n}=D({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS campaigns for organization:",s.id);const{data:l,error:o}=await y.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(o)throw console.error("Error fetching SMS campaigns:",o),o;return console.log("SMS campaigns fetched:",(l==null?void 0:l.length)||0),l||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),{data:d,isLoading:c,error:m}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS phone numbers for organization:",s.id);const{data:l,error:o}=await y.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(o)throw console.error("Error fetching SMS phone numbers:",o),o;return console.log("SMS phone numbers fetched:",(l==null?void 0:l.length)||0),l||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),h=A({mutationFn:async({name:l,template:o})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!l.trim())throw new Error("Campaign name is required");if(!o.trim())throw new Error("Message template is required");console.log("Creating SMS campaign:",{name:l,template:o,orgId:s.id});const{data:i,error:j}=await y.from("sms_campaigns").insert({organization_id:s.id,name:l.trim(),message_template:o.trim(),total_recipients:(d==null?void 0:d.length)||0}).select().single();if(j)throw console.error("Error creating SMS campaign:",j),j;return console.log("SMS campaign created:",i),i},onSuccess:()=>{u({title:"Campaign created successfully"}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:l=>{console.error("Create campaign error:",l),u({title:"Error creating campaign",description:l.message||"An unexpected error occurred",variant:"destructive"})}}),x=A({mutationFn:async({campaignId:l,isResend:o=!1})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!d||d.length===0)throw new Error("No active phone numbers found");const i=t==null?void 0:t.find(b=>b.id===l);if(!i)throw new Error("Campaign not found");console.log("Sending SMS campaign:",{campaignId:l,isResend:o,recipientCount:d.length}),await y.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",l);let j=d.map(b=>b.phone_number);if(o){const{data:b}=await y.from("sms_sends").select("phone_number").eq("campaign_id",l).eq("status","failed");if(b&&b.length>0)j=b.map(p=>p.phone_number);else throw new Error("No failed sends to retry for this campaign")}const{data:N,error:g}=await y.functions.invoke("send-sms",{body:{phoneNumbers:j,message:i.message_template,organizationId:s.id,campaignId:l}});if(g)throw console.error("Error sending SMS campaign:",g),new Error(g.message||"Failed to send campaign");return console.log("SMS campaign sent successfully:",N),N},onSuccess:(l,o)=>{const i=o.isResend?"Resent":"Sent";u({title:`Campaign ${i.toLowerCase()} successfully`,description:`${i} to ${l.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:l=>{console.error("Send campaign error:",l),u({title:"Error sending campaign",description:l.message||"An unexpected error occurred",variant:"destructive"})}});return{campaigns:t||[],campaignsLoading:r,campaignsError:n,phoneNumbers:d||[],phoneNumbersLoading:c,phoneNumbersError:m,createCampaignMutation:h,sendCampaignMutation:x,organization:s}},ns=({onSubmit:s,onCancel:a,isLoading:t,phoneNumbersCount:r,organizationName:n})=>{const[d,c]=v.useState(""),[m,h]=v.useState(""),x=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${n||"Your Company"}`,l=o=>{o.preventDefault(),!(!d.trim()||!m.trim())&&(s(d,m),c(""),h(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(T,{id:"campaign-name",value:d,onChange:o=>c(o.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(X,{id:"message-template",value:m,onChange:o=>h(o.target.value),placeholder:x,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",r," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(f,{type:"submit",disabled:t,children:"Create Campaign"}),e.jsx(f,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},rs=({campaign:s,onSend:a,onResend:t,isLoading:r})=>{const n=d=>{switch(d){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{variant:n(s.status),children:s.status}),s.status==="draft"&&e.jsxs(f,{size:"sm",onClick:()=>a(s.id),disabled:r,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(f,{size:"sm",variant:"outline",onClick:()=>t(s.id),disabled:r,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:s.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:s.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:s.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]})},is=({campaigns:s,onSend:a,onResend:t,isLoading:r})=>s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Me,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),s.map(n=>e.jsx(rs,{campaign:n,onSend:a,onResend:t,isLoading:r},n.id))]}),ls=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),ds=()=>{const[s,a]=v.useState(!1),{campaigns:t,campaignsLoading:r,campaignsError:n,phoneNumbers:d,phoneNumbersLoading:c,phoneNumbersError:m,createCampaignMutation:h,sendCampaignMutation:x,organization:l}=ts(),o=(N,g)=>{h.mutate({name:N,template:g},{onSuccess:()=>{a(!1)}})},i=N=>{x.mutate({campaignId:N})},j=N=>{x.mutate({campaignId:N,isResend:!0})};return r||c?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):n||m?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(H,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(n==null?void 0:n.message)||(m==null?void 0:m.message)||"An unexpected error occurred"})]})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns (",t.length,")"]}),e.jsxs(f,{onClick:()=>a(!0),disabled:d.length===0,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(_,{className:"space-y-6",children:d.length===0?e.jsx(ls,{}):e.jsxs(e.Fragment,{children:[s&&e.jsx(ns,{onSubmit:o,onCancel:()=>a(!1),isLoading:h.isPending,phoneNumbersCount:d.length,organizationName:l==null?void 0:l.name}),e.jsx(is,{campaigns:t,onSend:i,onResend:j,isLoading:x.isPending})]})})]})},cs=()=>e.jsx("div",{className:"mt-6",children:e.jsxs(Ae,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(Pe,{className:"grid w-full grid-cols-2",children:[e.jsx($,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx($,{value:"campaigns",children:"Campaigns"})]}),e.jsx(V,{value:"phone-numbers",className:"mt-6",children:e.jsx(as,{})}),e.jsx(V,{value:"campaigns",className:"mt-6",children:e.jsx(ds,{})})]})}),os=()=>{const{organization:s}=O(),a=Q(),{data:t,isLoading:r,error:n}=D({queryKey:["organization-sms-settings",s==null?void 0:s.id],queryFn:async()=>{console.log("Fetching SMS settings for organization:",s==null?void 0:s.id);const{data:c,error:m}=await y.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(m)throw console.error("Error fetching organization SMS settings:",m),m;return console.log("Organization SMS settings fetched:",c),c},enabled:!!(s!=null&&s.id),retry:3,retryDelay:1e3}),d=A({mutationFn:async c=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:c,orgId:s.id});const{data:m,error:h}=await y.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:c,senderId:(t==null?void 0:t.sms_sender_id)||"",username:Y(t==null?void 0:t.sms_settings,"username"),apiKey:Y(t==null?void 0:t.sms_settings,"apiKey")}});if(h)throw console.error("SMS status update error:",h),new Error(h.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",m),m},onSuccess:()=>{u({title:"SMS status updated successfully"}),a.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})},onError:c=>{console.error("SMS toggle error:",c),u({title:"Error updating SMS status",description:c.message||"An unexpected error occurred",variant:"destructive"})}});return{orgData:t,isLoading:r,error:n,updateSmsStatus:d,organization:s}},ms=()=>{const{isAdmin:s,isOrgAdmin:a}=Z(),[t,r]=v.useState(null),{orgData:n,isLoading:d,error:c,updateSmsStatus:m,organization:h}=os(),x=s||a,l=i=>{if(!x){u({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}if(!(h!=null&&h.id)){u({title:"Error",description:"Organization not found",variant:"destructive"});return}m.mutate(i)};if(!x)return e.jsx(Xe,{});if(d)return e.jsx(Je,{});if(c){const i=typeof c=="string"?c:"Failed to load SMS settings";return e.jsx(ze,{message:i})}const o=(n==null?void 0:n.sms_enabled)&&We(n==null?void 0:n.sms_settings);return e.jsxs(S,{children:[e.jsx(Ge,{}),e.jsxs(_,{className:"space-y-6",children:[e.jsx(Qe,{enabled:(n==null?void 0:n.sms_enabled)||!1,onToggle:l,isLoading:m.isPending}),(n==null?void 0:n.sms_enabled)&&e.jsx(He,{webhookSecret:(n==null?void 0:n.webhook_secret)||"",isVisible:!0}),e.jsx($e,{providers:Ve,selectedProvider:t,onProviderSelect:r}),t==="africastalking"&&e.jsx(Ye,{organization:h,currentSettings:n,onSettingsUpdate:()=>{}}),o&&e.jsx(cs,{})]})]})},hs=()=>{const{isAdmin:s,isOrgAdmin:a}=Z();return O(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ms,{}),e.jsx(Be,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{hs as IntegrationsTab,hs as default};
