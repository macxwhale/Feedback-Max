var y=Object.defineProperty;var C=(t,e,s)=>e in t?y(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var f=(t,e,s)=>C(t,typeof e!="symbol"?e+"":e,s);import{s as N,h as _,c as q,u as b,r as d,a as v,j as a,g as R,C as P,b as A,d as M,L as E,e as k,T as B,B as p,U as T}from"./index-sLSzLl2y.js";class u{static async getUserRole(e,s){const n=`${e}-${s}`,r=this.roleCache.get(n);if(r&&Date.now()-r.timestamp<this.CACHE_TTL)return r.role;try{const{data:o,error:i}=await N.from("organization_users").select("enhanced_role").eq("user_id",e).eq("organization_id",s).single();if(i||!o)return null;const m=o.enhanced_role;return this.roleCache.set(n,{role:m,timestamp:Date.now()}),m}catch(o){return console.error("Error fetching user role:",o),null}}static async checkPermission(e,s,n){if(e.isAdmin)return{allowed:!0,reason:"System admin access"};let r=e.userRole;if(!r&&(r=await this.getUserRole(e.userId,e.organizationId),!r))return{allowed:!1,reason:"User role not found"};if(!_(r,s))return{allowed:!1,reason:`Role '${r}' lacks permission '${s}'`,requiredRole:this.getMinimumRoleForPermission(s)};if(s==="manage_users"&&n){const i=await this.getUserRole(n,e.organizationId);if(i&&!q(r,i))return{allowed:!1,reason:`Cannot manage user with role '${i}'`,requiredRole:i}}return{allowed:!0}}static async requirePermission(e,s,n){const r=await this.checkPermission(e,s,n);if(!r.allowed)throw new U(r.reason||"Access denied",r.requiredRole)}static getMinimumRoleForPermission(e){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[e]||"admin"}static clearCache(e,s){e&&s?this.roleCache.delete(`${e}-${s}`):this.roleCache.clear()}}f(u,"roleCache",new Map),f(u,"CACHE_TTL",5*60*1e3);class U extends Error{constructor(e,s){super(e),this.requiredRole=s,this.name="RBACError"}}const j=t=>{const{user:e,isAdmin:s}=b(),n=d.useMemo(()=>!(e!=null&&e.id)||!t?null:{userId:e.id,organizationId:t,isAdmin:s},[e==null?void 0:e.id,t,s]),{data:r,isLoading:o}=v({queryKey:["user-role-rbac",e==null?void 0:e.id,t],queryFn:()=>n?u.getUserRole(n.userId,n.organizationId):null,enabled:!!n,staleTime:5*60*1e3}),i=d.useCallback(async(l,c)=>n?u.checkPermission({...n,userRole:r||void 0},l,c):{allowed:!1,reason:"No valid context"},[n,r]),m=d.useCallback(async(l,c)=>{if(!n)throw new Error("No valid RBAC context");return u.requirePermission({...n,userRole:r||void 0},l,c)},[n,r]),g=d.useCallback(l=>!n||!r?!1:s?!0:require("@/utils/enhancedRoleUtils").hasPermission(r,l),[n,r,s]),x=d.useCallback(async l=>{if(!n||!r)return!1;if(s)return!0;const c=await u.getUserRole(l,n.organizationId);return c?require("@/utils/enhancedRoleUtils").canManageRole(r,c):!1},[n,r,s]);return{userRole:r,isLoading:o,checkPermission:i,requirePermission:m,hasPermission:g,canManageUser:x,isAdmin:s||!1}},F=({children:t,permission:e,organizationId:s,fallback:n,showRequiredRole:r=!0})=>{const{hasPermission:o,userRole:i,isLoading:m,isAdmin:g}=j(s);if(m)return a.jsx("div",{className:"flex items-center justify-center p-8",children:a.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(g)return a.jsx(a.Fragment,{children:t});if(o(e))return a.jsx(a.Fragment,{children:t});if(n)return a.jsx(a.Fragment,{children:n});const x=L(e),{icon:l,label:c,variant:w}=R(x),h=i?R(i):null;return a.jsxs(P,{className:"border-red-200",children:[a.jsx(A,{children:a.jsxs(M,{className:"flex items-center text-red-600",children:[a.jsx(E,{className:"w-5 h-5 mr-2"}),"Access Restricted"]})}),a.jsxs(k,{className:"space-y-4",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx(B,{className:"w-4 h-4 text-amber-500"}),a.jsx("span",{className:"text-sm text-gray-600",children:"You don't have permission to access this feature."})]}),r&&a.jsxs("div",{className:"space-y-2",children:[a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-sm font-medium",children:"Required role:"}),a.jsxs(p,{variant:w,className:"flex items-center gap-1",children:[a.jsx(l,{className:"w-3 h-3"}),c]})]}),h&&a.jsxs("div",{className:"flex items-center space-x-2",children:[a.jsx("span",{className:"text-sm font-medium",children:"Your role:"}),a.jsxs(p,{variant:h.variant,className:"flex items-center gap-1",children:[a.jsx(h.icon,{className:"w-3 h-3"}),h.label]})]})]}),a.jsx("p",{className:"text-xs text-gray-500",children:"Contact your organization administrator to request access."})]})]})};function L(t){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[t]||"admin"}const $=({organizationId:t,organizationName:e})=>{const{isAdmin:s}=j(t);return a.jsx(F,{permission:"manage_users",organizationId:t,showRequiredRole:!0,fallback:a.jsxs("div",{className:"text-center p-8",children:[a.jsx("p",{className:"text-gray-500",children:"You need manager-level access or higher to manage users."}),!s&&a.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]}),children:a.jsx(T,{organizationId:t,organizationName:e})})},Y=({organization:t})=>a.jsx($,{organizationId:t.id,organizationName:t.name});export{Y as default};
