var w=Object.defineProperty;var y=(t,e,a)=>e in t?w(t,e,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[e]=a;var R=(t,e,a)=>y(t,typeof e!="symbol"?e+"":e,a);import{s as C,h as N,c as _,u as q,r as d,a as b,j as s,g as p,C as v,b as P,d as M,L as A,e as E,T as k,B as j,U as B}from"./index-Bw7jE6Nw.js";class u{static async getUserRole(e,a){const n=`${e}-${a}`,r=this.roleCache.get(n);if(r&&Date.now()-r.timestamp<this.CACHE_TTL)return r.role;try{const{data:l,error:i}=await C.from("organization_users").select("enhanced_role").eq("user_id",e).eq("organization_id",a).single();if(i||!l)return null;const m=l.enhanced_role;return this.roleCache.set(n,{role:m,timestamp:Date.now()}),m}catch(l){return console.error("Error fetching user role:",l),null}}static async checkPermission(e,a,n){if(e.isAdmin)return{allowed:!0,reason:"System admin access"};let r=e.userRole;if(!r&&(r=await this.getUserRole(e.userId,e.organizationId),!r))return{allowed:!1,reason:"User role not found"};if(!N(r,a))return{allowed:!1,reason:`Role '${r}' lacks permission '${a}'`,requiredRole:this.getMinimumRoleForPermission(a)};if(a==="manage_users"&&n){const i=await this.getUserRole(n,e.organizationId);if(i&&!_(r,i))return{allowed:!1,reason:`Cannot manage user with role '${i}'`,requiredRole:i}}return{allowed:!0}}static async requirePermission(e,a,n){const r=await this.checkPermission(e,a,n);if(!r.allowed)throw new T(r.reason||"Access denied",r.requiredRole)}static getMinimumRoleForPermission(e){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[e]||"admin"}static clearCache(e,a){e&&a?this.roleCache.delete(`${e}-${a}`):this.roleCache.clear()}}R(u,"roleCache",new Map),R(u,"CACHE_TTL",5*60*1e3);class T extends Error{constructor(e,a){super(e),this.requiredRole=a,this.name="RBACError"}}const U=t=>{const{user:e,isAdmin:a}=q(),n=d.useMemo(()=>!(e!=null&&e.id)||!t?null:{userId:e.id,organizationId:t,isAdmin:a},[e==null?void 0:e.id,t,a]),{data:r,isLoading:l}=b({queryKey:["user-role-rbac",e==null?void 0:e.id,t],queryFn:()=>n?u.getUserRole(n.userId,n.organizationId):null,enabled:!!n,staleTime:5*60*1e3}),i=d.useCallback(async(c,o)=>n?u.checkPermission({...n,userRole:r||void 0},c,o):{allowed:!1,reason:"No valid context"},[n,r]),m=d.useCallback(async(c,o)=>{if(!n)throw new Error("No valid RBAC context");return u.requirePermission({...n,userRole:r||void 0},c,o)},[n,r]),g=d.useCallback(c=>{if(!n||!r)return!1;if(a)return!0;const{hasPermission:o}=require("@/utils/enhancedRoleUtils");return o(r,c)},[n,r,a]),x=d.useCallback(async c=>{if(!n||!r)return!1;if(a)return!0;const o=await u.getUserRole(c,n.organizationId);if(!o)return!1;const{canManageRole:f}=require("@/utils/enhancedRoleUtils");return f(r,o)},[n,r,a]);return{userRole:r,isLoading:l,checkPermission:i,requirePermission:m,hasPermission:g,canManageUser:x,isAdmin:a||!1}},F=({children:t,permission:e,organizationId:a,fallback:n,showRequiredRole:r=!0})=>{const{hasPermission:l,userRole:i,isLoading:m,isAdmin:g}=U(a);if(m)return s.jsx("div",{className:"flex items-center justify-center p-8",children:s.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(g)return s.jsx(s.Fragment,{children:t});if(l(e))return s.jsx(s.Fragment,{children:t});if(n)return s.jsx(s.Fragment,{children:n});const x=L(e),{icon:c,label:o,variant:f}=p(x),h=i?p(i):null;return s.jsxs(v,{className:"border-red-200",children:[s.jsx(P,{children:s.jsxs(M,{className:"flex items-center text-red-600",children:[s.jsx(A,{className:"w-5 h-5 mr-2"}),"Access Restricted"]})}),s.jsxs(E,{className:"space-y-4",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx(k,{className:"w-4 h-4 text-amber-500"}),s.jsx("span",{className:"text-sm text-gray-600",children:"You don't have permission to access this feature."})]}),r&&s.jsxs("div",{className:"space-y-2",children:[s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{className:"text-sm font-medium",children:"Required role:"}),s.jsxs(j,{variant:f,className:"flex items-center gap-1",children:[s.jsx(c,{className:"w-3 h-3"}),o]})]}),h&&s.jsxs("div",{className:"flex items-center space-x-2",children:[s.jsx("span",{className:"text-sm font-medium",children:"Your role:"}),s.jsxs(j,{variant:h.variant,className:"flex items-center gap-1",children:[s.jsx(h.icon,{className:"w-3 h-3"}),h.label]})]})]}),s.jsx("p",{className:"text-xs text-gray-500",children:"Contact your organization administrator to request access."})]})]})};function L(t){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[t]||"admin"}const $=({organizationId:t,organizationName:e})=>s.jsx(F,{permission:"manage_users",organizationId:t,showRequiredRole:!0,fallback:s.jsxs("div",{className:"text-center p-8",children:[s.jsx("p",{className:"text-gray-500",children:"You need manager-level access or higher to manage users."}),s.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]}),children:s.jsx(B,{organizationId:t,organizationName:e})}),Y=({organization:t})=>s.jsx($,{organizationId:t.id,organizationName:t.name});export{Y as default};
