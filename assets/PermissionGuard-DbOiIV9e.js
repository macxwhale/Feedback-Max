var C=Object.defineProperty;var _=(t,e,s)=>e in t?C(t,e,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[e]=s;var f=(t,e,s)=>_(t,typeof e!="symbol"?e+"":e,s);import{s as N,aJ as p,aK as j,ay as q,r as d,u as b,j as n,aL as R,C as P,a as v,b as A,aM as M,e as k,G as E,B as w}from"./index-D0sg9aXi.js";class u{static async getUserRole(e,s){const r=`${e}-${s}`,a=this.roleCache.get(r);if(a&&Date.now()-a.timestamp<this.CACHE_TTL)return a.role;try{const{data:o,error:i}=await N.from("organization_users").select("enhanced_role").eq("user_id",e).eq("organization_id",s).single();if(i||!o)return null;const m=o.enhanced_role;return this.roleCache.set(r,{role:m,timestamp:Date.now()}),m}catch(o){return console.error("Error fetching user role:",o),null}}static async checkPermission(e,s,r){if(e.isAdmin)return{allowed:!0,reason:"System admin access"};let a=e.userRole;if(!a&&(a=await this.getUserRole(e.userId,e.organizationId),!a))return{allowed:!1,reason:"User role not found"};if(!p(a,s))return{allowed:!1,reason:`Role '${a}' lacks permission '${s}'`,requiredRole:this.getMinimumRoleForPermission(s)};if(s==="manage_users"&&r){const i=await this.getUserRole(r,e.organizationId);if(i&&!j(a,i))return{allowed:!1,reason:`Cannot manage user with role '${i}'`,requiredRole:i}}return{allowed:!0}}static async requirePermission(e,s,r){const a=await this.checkPermission(e,s,r);if(!a.allowed)throw new B(a.reason||"Access denied",a.requiredRole)}static getMinimumRoleForPermission(e){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[e]||"admin"}static clearCache(e,s){e&&s?this.roleCache.delete(`${e}-${s}`):this.roleCache.clear()}}f(u,"roleCache",new Map),f(u,"CACHE_TTL",5*60*1e3);class B extends Error{constructor(e,s){super(e),this.requiredRole=s,this.name="RBACError"}}const F=t=>{const{user:e,isAdmin:s}=q(),r=d.useMemo(()=>!(e!=null&&e.id)||!t?null:{userId:e.id,organizationId:t,isAdmin:s},[e==null?void 0:e.id,t,s]),{data:a,isLoading:o}=b({queryKey:["user-role-rbac",e==null?void 0:e.id,t],queryFn:()=>r?u.getUserRole(r.userId,r.organizationId):null,enabled:!!r,staleTime:5*60*1e3}),i=d.useCallback(async(l,c)=>r?u.checkPermission({...r,userRole:a||void 0},l,c):{allowed:!1,reason:"No valid context"},[r,a]),m=d.useCallback(async(l,c)=>{if(!r)throw new Error("No valid RBAC context");return u.requirePermission({...r,userRole:a||void 0},l,c)},[r,a]),g=d.useCallback(l=>!r||!a?!1:s?!0:p(a,l),[r,a,s]),x=d.useCallback(async l=>{if(!r||!a)return!1;if(s)return!0;const c=await u.getUserRole(l,r.organizationId);return c?j(a,c):!1},[r,a,s]);return{userRole:a,isLoading:o,checkPermission:i,requirePermission:m,hasPermission:g,canManageUser:x,isAdmin:s||!1}},U=({children:t,permission:e,organizationId:s,fallback:r,showRequiredRole:a=!0})=>{const{hasPermission:o,userRole:i,isLoading:m,isAdmin:g}=F(s);if(m)return n.jsx("div",{className:"flex items-center justify-center p-8",children:n.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})});if(g)return n.jsx(n.Fragment,{children:t});if(o(e))return n.jsx(n.Fragment,{children:t});if(r)return n.jsx(n.Fragment,{children:r});const x=L(e),{icon:l,label:c,variant:y}=R(x),h=i?R(i):null;return n.jsxs(P,{className:"border-red-200",children:[n.jsx(v,{children:n.jsxs(A,{className:"flex items-center text-red-600",children:[n.jsx(M,{className:"w-5 h-5 mr-2"}),"Access Restricted"]})}),n.jsxs(k,{className:"space-y-4",children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx(E,{className:"w-4 h-4 text-amber-500"}),n.jsx("span",{className:"text-sm text-gray-600",children:"You don't have permission to access this feature."})]}),a&&n.jsxs("div",{className:"space-y-2",children:[n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx("span",{className:"text-sm font-medium",children:"Required role:"}),n.jsxs(w,{variant:y,className:"flex items-center gap-1",children:[n.jsx(l,{className:"w-3 h-3"}),c]})]}),h&&n.jsxs("div",{className:"flex items-center space-x-2",children:[n.jsx("span",{className:"text-sm font-medium",children:"Your role:"}),n.jsxs(w,{variant:h.variant,className:"flex items-center gap-1",children:[n.jsx(h.icon,{className:"w-3 h-3"}),h.label]})]})]}),n.jsx("p",{className:"text-xs text-gray-500",children:"Contact your organization administrator to request access."})]})]})};function L(t){return{view_analytics:"viewer",export_data:"analyst",manage_questions:"analyst",manage_users:"manager",manage_integrations:"admin",manage_organization:"admin",manage_billing:"owner"}[t]||"admin"}export{U as P};
