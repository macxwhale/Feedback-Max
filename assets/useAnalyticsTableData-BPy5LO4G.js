import{u as O,s as A}from"./index-BOg6IISU.js";const B=(s,o,c=100)=>{if(o===0||o===null||o===void 0)return s>0?c:0;if(s==null)return 0;const _=(s-o)/Math.abs(o)*100;return Math.max(-c,Math.min(c,Math.round(_)))},T=(s,o=5)=>s==null||isNaN(s)?0:s>=1&&s<=o?s:s>=0&&s<=100?Math.max(1,Math.min(5,s/100*4+1)):Math.max(1,Math.min(o,s)),J=(s,o,c=5)=>o<c?s>o?10:0:B(s,o,100),U=s=>Array.isArray(s)?s.filter(o=>!o||typeof o!="object"?!1:(o.total_score!==null&&o.total_score!==void 0&&(o.total_score=T(o.total_score)),!0)):[],V=(s,o)=>{const c=s.toLowerCase(),_=["good","great","excellent","amazing","love","fantastic","perfect","wonderful"],q=["bad","terrible","awful","hate","horrible","disappointing","poor","worst"],m=_.filter(d=>c.includes(d)).length,y=q.filter(d=>c.includes(d)).length;return o>=4?"positive":o<=2?"negative":m>y?"positive":y>m?"negative":"neutral"},$=s=>O({queryKey:["analytics-table-data",s],queryFn:async()=>{console.log("Fetching analytics data for organization:",s);const{data:o,error:c}=await A.from("questions").select(`
          id,
          question_text,
          question_type,
          category,
          is_active,
          created_at
        `).eq("organization_id",s).eq("is_active",!0).order("created_at",{ascending:!1});if(c)throw console.error("Error fetching questions:",c),c;const{data:_,error:q}=await A.from("feedback_responses").select(`
          id,
          question_id,
          score,
          response_time_ms,
          created_at,
          question_category,
          session_id,
          response_value
        `).eq("organization_id",s);if(q)throw console.error("Error fetching responses:",q),q;const{data:m,error:y}=await A.from("feedback_sessions").select(`
          id,
          status,
          total_score,
          created_at,
          completed_at,
          started_at,
          user_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(y)throw console.error("Error fetching sessions:",y),y;console.log("Raw data fetched:",{questions:(o==null?void 0:o.length)||0,responses:(_==null?void 0:_.length)||0,sessions:(m==null?void 0:m.length)||0});const d=U(m||[]),h=d.length,b=d.filter(e=>e.status==="completed").length,z=d.filter(e=>e.status==="in_progress").length,P=h-b-z,C=h>0?Math.round(b/h*100):0,w=d.filter(e=>e.status==="completed"&&e.total_score!==null).map(e=>T(e.total_score)),N=w.length>0?w.reduce((e,t)=>e+t,0)/w.length:0,G=w.filter(e=>e>=4).length,L=w.length>0?Math.round(G/w.length*100):0,M=new Date;M.setDate(M.getDate()-30);const x=new Date;x.setDate(x.getDate()-60);const k=d.filter(e=>new Date(e.created_at)>=M).length,F=d.filter(e=>new Date(e.created_at)>=x&&new Date(e.created_at)<M).length,j=J(k,F),f=(o||[]).map(e=>{const t=(_||[]).filter(l=>l.question_id===e.id),u=t.length,v=new Set(t.map(l=>l.session_id)),p=h>0?Math.round(v.size/h*100):0,S=t.filter(l=>l.score!==null),a=S.length>0?S.reduce((l,n)=>l+(n.score||0),0)/S.length:0,r=t.filter(l=>l.response_time_ms!==null),R=r.length>0?r.reduce((l,n)=>l+(n.response_time_ms||0),0)/r.length:0,i=[];if(e.question_type==="text"||e.question_type==="textarea"){const l=t.filter(n=>n.response_value&&typeof n.response_value=="string"&&n.response_value.trim().length>0).map(n=>({id:n.id,response_value:n.response_value,score:n.score||0,created_at:n.created_at,sentiment:V(n.response_value,n.score||0)})).sort((n,K)=>new Date(K.created_at).getTime()-new Date(n.created_at).getTime());i.push(...l)}const g=[];return p>90&&g.push("High engagement - users complete this question consistently"),p<70&&g.push("Low completion - consider simplifying or repositioning"),a>4&&g.push("Positive sentiment - high satisfaction scores"),a<2.5&&g.push("Negative sentiment - requires attention"),R>3e4&&g.push("Long response time - may indicate complexity"),{id:e.id,question_text:e.question_text,question_type:e.question_type||"text",category:e.category||"General",total_responses:u,completion_rate:p,avg_score:Math.round(a*100)/100,avg_response_time_ms:Math.round(R),response_distribution:{},insights:g,trend:a>3.5?"positive":a<2.5?"negative":"neutral",text_responses:i}}),D=new Map;f.forEach(e=>{const t=e.category||"General";D.has(t)||D.set(t,[]),D.get(t).push(e)});const H=Array.from(D.entries()).map(([e,t])=>{const u=t.reduce((a,r)=>a+r.total_responses,0),v=t.length>0?t.reduce((a,r)=>a+r.completion_rate,0)/t.length:0,p=t.length>0?t.reduce((a,r)=>a+r.avg_score,0)/t.length:0,S=t.length>0?t.reduce((a,r)=>a+(r.avg_response_time_ms||0),0)/t.length:0;return{category:e,total_questions:t.length,total_responses:u,completion_rate:Math.round(v),questions:t,avg_score:Math.round(p*100)/100,avg_response_time_ms:Math.round(S)}}),E=[];Array.from({length:30},(e,t)=>{const u=new Date;return u.setDate(u.getDate()-t),u}).reverse().forEach(e=>{const t=e.toISOString().split("T")[0],u=d.filter(i=>i.created_at.startsWith(t)),v=u.length,p=u.filter(i=>i.status==="completed").length,S=v>0?Math.round(p/v*100):0,r=u.filter(i=>i.status==="completed"&&i.total_score!==null).map(i=>T(i.total_score)),R=r.length>0?r.reduce((i,g)=>i+g,0)/r.length:0;E.push({date:t,total_sessions:v,completed_sessions:p,completion_rate:S,avg_score:Math.round(R*100)/100})});const W={questions:f,categories:H,summary:{total_questions:f.length,total_responses:f.reduce((e,t)=>e+t.total_responses,0),overall_completion_rate:C,total_sessions:h,completed_sessions:b,avg_score:Math.round(N*100)/100,user_satisfaction_rate:L,growth_rate:j,abandoned_sessions:P,response_rate:f.length>0&&h>0?Math.round(f.reduce((e,t)=>e+t.total_responses,0)/(f.length*h)*100):0},trendData:E};return console.log("Analytics result with text responses:",W),W},enabled:!!s,staleTime:5*60*1e3,refetchInterval:10*60*1e3});export{$ as u};
