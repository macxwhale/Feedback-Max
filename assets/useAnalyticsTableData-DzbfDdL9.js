import{u as O,s as A}from"./index-D7Vb9kJZ.js";const B=(s,o,d=100)=>{if(o===0||o===null||o===void 0)return s>0?d:0;if(s==null)return 0;const S=(s-o)/Math.abs(o)*100;return Math.max(-d,Math.min(d,Math.round(S)))},E=(s,o=5)=>s==null||isNaN(s)?0:s>=1&&s<=o?s:s>=0&&s<=100?Math.max(1,Math.min(5,s/100*4+1)):Math.max(1,Math.min(o,s)),J=(s,o,d=5)=>o<d?s>o?10:0:B(s,o,100),U=s=>Array.isArray(s)?s.filter(o=>!o||typeof o!="object"?!1:(o.total_score!==null&&o.total_score!==void 0&&(o.total_score=E(o.total_score)),!0)):[],Z=s=>O({queryKey:["analytics-table-data",s],queryFn:async()=>{console.log("Fetching analytics data for organization:",s);const{data:o,error:d}=await A.from("questions").select(`
          id,
          question_text,
          question_type,
          category,
          is_active,
          created_at
        `).eq("organization_id",s).eq("is_active",!0).order("created_at",{ascending:!1});if(d)throw console.error("Error fetching questions:",d),d;const{data:S,error:D}=await A.from("feedback_responses").select(`
          id,
          question_id,
          score,
          response_time_ms,
          created_at,
          question_category,
          session_id,
          response_value
        `).eq("organization_id",s);if(D)throw console.error("Error fetching responses:",D),D;const{data:v,error:R}=await A.from("feedback_sessions").select(`
          id,
          status,
          total_score,
          created_at,
          completed_at,
          started_at,
          user_id
        `).eq("organization_id",s).order("created_at",{ascending:!1});if(R)throw console.error("Error fetching sessions:",R),R;console.log("Raw data fetched:",{questions:(o==null?void 0:o.length)||0,responses:(S==null?void 0:S.length)||0,sessions:(v==null?void 0:v.length)||0});const p=U(v||[]),_=p.length,x=p.filter(e=>e.status==="completed").length,P=p.filter(e=>e.status==="in_progress").length,z=_-x-P,G=_>0?Math.round(x/_*100):0,y=p.filter(e=>e.status==="completed"&&e.total_score!==null).map(e=>E(e.total_score)),L=y.length>0?y.reduce((e,t)=>e+t,0)/y.length:0,N=y.filter(e=>e>=4).length,k=y.length>0?Math.round(N/y.length*100):0,w=new Date;w.setDate(w.getDate()-30);const b=new Date;b.setDate(b.getDate()-60);const F=p.filter(e=>new Date(e.created_at)>=w).length,H=p.filter(e=>new Date(e.created_at)>=b&&new Date(e.created_at)<w).length,j=J(F,H),g=(o||[]).map(e=>{const t=(S||[]).filter(c=>c.question_id===e.id),l=t.length,m=new Set(t.map(c=>c.session_id)),h=_>0?Math.round(m.size/_*100):0,f=t.filter(c=>c.score!==null),a=f.length>0?f.reduce((c,r)=>c+(r.score||0),0)/f.length:0,n=t.filter(c=>c.response_time_ms!==null),M=n.length>0?n.reduce((c,r)=>c+(r.response_time_ms||0),0)/n.length:0,i=[];if(e.question_type==="text"||e.question_type==="textarea"){const c=t.filter(r=>r.response_value&&typeof r.response_value=="string"&&r.response_value.trim().length>0).map(r=>({id:r.id,response_value:r.response_value,score:r.score||0,created_at:r.created_at})).sort((r,K)=>new Date(K.created_at).getTime()-new Date(r.created_at).getTime());i.push(...c)}const u=[];return h>90&&u.push("High engagement - users complete this question consistently"),h<70&&u.push("Low completion - consider simplifying or repositioning"),a>4&&u.push("High satisfaction scores"),a<2.5&&u.push("Low satisfaction scores - requires attention"),M>3e4&&u.push("Long response time - may indicate complexity"),{id:e.id,question_text:e.question_text,question_type:e.question_type||"text",category:e.category||"General",total_responses:l,completion_rate:h,avg_score:Math.round(a*100)/100,avg_response_time_ms:Math.round(M),response_distribution:{},insights:u,trend:a>3.5?"positive":a<2.5?"negative":"neutral",text_responses:i}}),q=new Map;g.forEach(e=>{const t=e.category||"General";q.has(t)||q.set(t,[]),q.get(t).push(e)});const C=Array.from(q.entries()).map(([e,t])=>{const l=t.reduce((a,n)=>a+n.total_responses,0),m=t.length>0?t.reduce((a,n)=>a+n.completion_rate,0)/t.length:0,h=t.length>0?t.reduce((a,n)=>a+n.avg_score,0)/t.length:0,f=t.length>0?t.reduce((a,n)=>a+(n.avg_response_time_ms||0),0)/t.length:0;return{category:e,total_questions:t.length,total_responses:l,completion_rate:Math.round(m),questions:t,avg_score:Math.round(h*100)/100,avg_response_time_ms:Math.round(f)}}),T=[];Array.from({length:30},(e,t)=>{const l=new Date;return l.setDate(l.getDate()-t),l}).reverse().forEach(e=>{const t=e.toISOString().split("T")[0],l=p.filter(i=>i.created_at.startsWith(t)),m=l.length,h=l.filter(i=>i.status==="completed").length,f=m>0?Math.round(h/m*100):0,n=l.filter(i=>i.status==="completed"&&i.total_score!==null).map(i=>E(i.total_score)),M=n.length>0?n.reduce((i,u)=>i+u,0)/n.length:0;T.push({date:t,total_sessions:m,completed_sessions:h,completion_rate:f,avg_score:Math.round(M*100)/100})});const W={questions:g,categories:C,summary:{total_questions:g.length,total_responses:g.reduce((e,t)=>e+t.total_responses,0),overall_completion_rate:G,total_sessions:_,completed_sessions:x,avg_score:Math.round(L*100)/100,user_satisfaction_rate:k,growth_rate:j,abandoned_sessions:z,response_rate:g.length>0&&_>0?Math.round(g.reduce((e,t)=>e+t.total_responses,0)/(g.length*_)*100):0},trendData:T};return console.log("Analytics result with text responses:",W),W},enabled:!!s,staleTime:5*60*1e3,refetchInterval:10*60*1e3});export{Z as u};
