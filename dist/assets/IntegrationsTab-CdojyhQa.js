import{c as K,s as b,a4 as U,a5 as Y,r as N,u as D,a6 as P,j as e,C as S,a as C,b as k,d as W,e as _,a7 as T,g as y,a8 as G,w as ae,x as te,y as O,z as I,A as ne,E as q,S as re,B as R,f as ie,a9 as le,aa as de,ab as ce,ac as oe,ad as me,ae as ue,af as he,ag as xe,ah as pe,ai as ge,aj as je,ak as fe,al as ye,am as be,an as ve,ao as Ne,ap as we,aq as J,ar as h,as as E,I as X,at as Se,au as Ce,av as ke,K as B,aw as Z,ax as z,ay as _e,az as Ae,aA as Me,M,aB as ee,p as Pe,q as qe,t as V,v as H}from"./index-DnvRJ4Yg.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=K("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const se=K("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=K("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=K("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=K("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=K("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=K("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=K("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Re=async s=>{const{data:a,error:t}=await b.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(t)throw t;return a},Ue=async(s,a)=>{const{data:t,error:l}=await b.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(l)throw l;return t},Oe=async(s,a)=>{const{data:t,error:l}=await b.from("api_keys").update({status:a}).eq("id",s).select().single();if(l)throw l;return t},Be=({apiKey:s})=>{const[a,t]=N.useState(!1),l=()=>{navigator.clipboard.writeText(s),t(!0),h({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>t(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(y,{variant:"ghost",size:"icon",onClick:l,children:a?e.jsx(J,{className:"h-4 w-4 text-green-500"}):e.jsx(se,{className:"h-4 w-4"})})]})},Qe=()=>{const{organization:s}=U(),a=Y(),[t,l]=N.useState(""),[u,c]=N.useState(null),p=["apiKeys",s==null?void 0:s.id],{data:n,isLoading:f}=D({queryKey:p,queryFn:()=>Re(s.id),enabled:!!s}),g=P({mutationFn:r=>Ue(s.id,r),onSuccess:r=>{h({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),c(r),l(""),a.invalidateQueries({queryKey:p})},onError:r=>{h({title:"Error",description:r.message,variant:"destructive"})}}),i=P({mutationFn:({keyId:r,status:m})=>Oe(r,m),onSuccess:()=>{h({title:"Status Updated"}),a.invalidateQueries({queryKey:p})},onError:r=>{h({title:"Error",description:r.message,variant:"destructive"})}}),o=r=>{r.preventDefault(),t.trim()&&s&&g.mutate(t.trim())};return e.jsxs(S,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(Ke,{})," API Keys"]}),e.jsx(W,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(_,{children:[e.jsxs("form",{onSubmit:o,className:"flex items-center gap-2 mb-6",children:[e.jsx(T,{placeholder:"New key name (e.g., 'SMS Integration')",value:t,onChange:r=>l(r.target.value),disabled:g.isPending}),e.jsxs(y,{type:"submit",disabled:!t.trim()||g.isPending,children:[g.isPending?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(Te,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(ae,{children:[e.jsx(te,{children:e.jsxs(O,{children:[e.jsx(I,{children:"Name"}),e.jsx(I,{children:"Key Prefix"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Last Used"}),e.jsx(I,{children:"Created"}),e.jsx(I,{className:"text-right",children:"Actions"})]})}),e.jsx(ne,{children:f?Array.from({length:3}).map((r,m)=>e.jsx(O,{children:e.jsx(q,{colSpan:6,children:e.jsx(re,{className:"h-8 w-full"})})},m)):n&&n.length>0?n.map(r=>e.jsxs(O,{children:[e.jsx(q,{className:"font-medium",children:r.key_name}),e.jsx(q,{children:e.jsxs("code",{children:[r.key_prefix,"..."]})}),e.jsx(q,{children:e.jsx(R,{variant:r.status==="active"?"default":"secondary",children:r.status})}),e.jsx(q,{children:r.last_used_at?`${ie(new Date(r.last_used_at))} ago`:"Never"}),e.jsx(q,{children:le(new Date(r.created_at),"MMM d, yyyy")}),e.jsx(q,{className:"text-right",children:e.jsxs(de,{children:[e.jsx(ce,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",disabled:i.isPending,children:r.status==="active"?e.jsx(Ie,{className:"h-4 w-4"}):e.jsx(Le,{className:"h-4 w-4"})})}),e.jsxs(oe,{children:[e.jsxs(me,{children:[e.jsx(ue,{children:"Are you sure?"}),e.jsxs(he,{children:["This will ",r.status==="active"?"deactivate":"activate"," the API key.",r.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(xe,{children:[e.jsx(pe,{children:"Cancel"}),e.jsx(ge,{onClick:()=>i.mutate({keyId:r.id,status:r.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},r.id)):e.jsx(O,{children:e.jsx(q,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(je,{open:!!u,onOpenChange:r=>!r&&c(null),children:e.jsxs(fe,{children:[e.jsxs(ye,{children:[e.jsx(be,{children:"API Key Created Successfully"}),e.jsx(ve,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Be,{apiKey:u||""}),e.jsx(Ne,{children:e.jsx(we,{asChild:!0,children:e.jsx(y,{children:"Close"})})})]})})]})]})},Ye=({organization:s,currentSettings:a,onSettingsUpdate:t})=>{var o,r,m,j;const[l,u]=N.useState(((o=a==null?void 0:a.sms_settings)==null?void 0:o.username)||""),[c,p]=N.useState(""),[n,f]=N.useState((a==null?void 0:a.sms_sender_id)||""),g=P({mutationFn:async()=>{const{data:x,error:v}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:n.trim(),username:l.trim(),apiKey:c.trim()}});if(v)throw v;return x},onSuccess:()=>{h({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),p(""),t()},onError:x=>{h({title:"Error saving settings",description:x.message,variant:"destructive"})}}),i=x=>{var v;if(x.preventDefault(),!l.trim()){h({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!c.trim()&&!((v=a==null?void 0:a.sms_settings)!=null&&v.apiKey)){h({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}g.mutate()};return e.jsxs(S,{className:"mt-4",children:[e.jsx(C,{children:e.jsx(k,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(_,{children:e.jsxs("form",{onSubmit:i,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-username",children:"Username *"}),e.jsx(T,{id:"at-username",value:l,onChange:x=>u(x.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(T,{id:"at-sender-id",value:n,onChange:x=>f(x.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(T,{id:"at-api-key",type:"password",value:c,onChange:x=>p(x.target.value),placeholder:(r=a==null?void 0:a.sms_settings)!=null&&r.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((m=a==null?void 0:a.sms_settings)!=null&&m.apiKey)}),((j=a==null?void 0:a.sms_settings)==null?void 0:j.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(X,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{type:"submit",disabled:g.isPending,className:"flex items-center gap-2",children:[g.isPending?e.jsx(G,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(y,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Ee,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},$e=({enabled:s,onToggle:a,isLoading:t})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(Se,{checked:s,onCheckedChange:a,disabled:t})]});var Ve={};const He=({webhookSecret:s,isVisible:a})=>{var n;const[t,l]=N.useState(!1);if(!a||!s)return null;const c=`${window.location.hostname==="localhost"?"http://localhost:54321":`https://${(n=Ve.VITE_SUPABASE_URL)==null?void 0:n.replace("https://","").replace(".supabase.co","")}.supabase.co`}/functions/v1/handle-sms-webhook?secret=${s}`,p=async()=>{try{await navigator.clipboard.writeText(c),h({title:"Webhook URL copied to clipboard"})}catch(f){console.error("Failed to copy:",f),h({title:"Failed to copy",description:"Please copy the URL manually",variant:"destructive"})}};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"SMS Webhook URL"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Configure this URL in your Africa's Talking SMS callback settings"}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(T,{type:t?"text":"password",value:c,readOnly:!0,className:"font-mono text-sm"}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>l(!t),children:t?e.jsx(Ce,{className:"w-4 h-4"}):e.jsx(ke,{className:"w-4 h-4"})}),e.jsx(y,{variant:"outline",size:"sm",onClick:p,children:e.jsx(se,{className:"w-4 h-4"})})]})]})},We=({providers:s,selectedProvider:a,onProviderSelect:t})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(l=>{const u=l.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===l.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>l.status==="available"&&t(a===l.id?null:l.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(u,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:l.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:l.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:l.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(R,{variant:"default",children:"Available"}),a===l.id&&e.jsx(J,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(R,{variant:"secondary",children:"Coming Soon"})})]})},l.id)})]}),Ge=()=>{const{organization:s}=U(),a=Y(),[t,l]=N.useState(""),[u,c]=N.useState(""),[p,n]=N.useState(""),[f,g]=N.useState(!1),{data:i,isLoading:o}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:d,error:w}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(w)throw w;return d},enabled:!!(s!=null&&s.id)}),r=P({mutationFn:async({phoneNumber:d,name:w})=>{const{data:A,error:F}=await b.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:d.trim(),name:(w==null?void 0:w.trim())||null}).select().single();if(F)throw F;return A},onSuccess:()=>{h({title:"Phone number added successfully"}),l(""),c(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:d=>{h({title:"Error adding phone number",description:d.message,variant:"destructive"})}}),m=P({mutationFn:async d=>{const{data:w,error:A}=await b.from("sms_phone_numbers").insert(d.map(({phoneNumber:F,name:L})=>({organization_id:s.id,phone_number:F.trim(),name:(L==null?void 0:L.trim())||null})));if(A)throw A;return w},onSuccess:()=>{h({title:"Phone numbers added successfully"}),n(""),g(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:d=>{h({title:"Error adding phone numbers",description:d.message,variant:"destructive"})}}),j=P({mutationFn:async d=>{const{error:w}=await b.from("sms_phone_numbers").delete().eq("id",d);if(w)throw w},onSuccess:()=>{h({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:d=>{h({title:"Error removing phone number",description:d.message,variant:"destructive"})}}),x=d=>{d.preventDefault(),t.trim()&&r.mutate({phoneNumber:t,name:u})},v=()=>{const w=p.split(`
`).filter(A=>A.trim()).map(A=>{const F=A.split(",").map(L=>L.trim());return{phoneNumber:F[0],name:F[1]||void 0}}).filter(A=>A.phoneNumber);if(w.length===0){h({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}m.mutate(w)},$=d=>d.startsWith("+")?d:`+${d}`;return o?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers (",(i==null?void 0:i.length)||0,")"]})}),e.jsxs(_,{className:"space-y-6",children:[e.jsx("form",{onSubmit:x,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(T,{id:"phone-number",value:t,onChange:d=>l(d.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(T,{id:"name",value:u,onChange:d=>c(d.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{type:"submit",disabled:r.isPending,className:"w-full",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{variant:"outline",onClick:()=>g(!f),children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),f&&e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(z,{id:"bulk-numbers",value:p,onChange:d=>n(d.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{onClick:v,disabled:m.isPending,children:"Add All Numbers"}),e.jsx(y,{variant:"outline",onClick:()=>g(!1),children:"Cancel"})]})]}),i&&i.length>0?e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:i.map(d=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:$(d.phone_number)}),d.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:d.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(R,{variant:d.status==="active"?"default":"secondary",children:d.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(d.created_at).toLocaleDateString()]})]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>j.mutate(d.id),disabled:j.isPending,children:e.jsx(_e,{className:"w-4 h-4"})})]},d.id))})]}):e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]})]})]})},Je=()=>{const{organization:s}=U(),a=Y(),{data:t,isLoading:l,error:u}=D({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS campaigns for organization:",s.id);const{data:i,error:o}=await b.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(o)throw console.error("Error fetching SMS campaigns:",o),o;return console.log("SMS campaigns fetched:",(i==null?void 0:i.length)||0),i||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),{data:c,isLoading:p,error:n}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS phone numbers for organization:",s.id);const{data:i,error:o}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(o)throw console.error("Error fetching SMS phone numbers:",o),o;return console.log("SMS phone numbers fetched:",(i==null?void 0:i.length)||0),i||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),f=P({mutationFn:async({name:i,template:o})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!i.trim())throw new Error("Campaign name is required");if(!o.trim())throw new Error("Message template is required");console.log("Creating SMS campaign:",{name:i,template:o,orgId:s.id});const{data:r,error:m}=await b.from("sms_campaigns").insert({organization_id:s.id,name:i.trim(),message_template:o.trim(),total_recipients:(c==null?void 0:c.length)||0}).select().single();if(m)throw console.error("Error creating SMS campaign:",m),m;return console.log("SMS campaign created:",r),r},onSuccess:()=>{h({title:"Campaign created successfully"}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:i=>{console.error("Create campaign error:",i),h({title:"Error creating campaign",description:i.message||"An unexpected error occurred",variant:"destructive"})}}),g=P({mutationFn:async({campaignId:i,isResend:o=!1})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!c||c.length===0)throw new Error("No active phone numbers found");const r=t==null?void 0:t.find(v=>v.id===i);if(!r)throw new Error("Campaign not found");console.log("Sending SMS campaign:",{campaignId:i,isResend:o,recipientCount:c.length}),await b.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",i);let m=c.map(v=>v.phone_number);if(o){const{data:v}=await b.from("sms_sends").select("phone_number").eq("campaign_id",i).eq("status","failed");if(v&&v.length>0)m=v.map($=>$.phone_number);else throw new Error("No failed sends to retry for this campaign")}const{data:j,error:x}=await b.functions.invoke("send-sms",{body:{phoneNumbers:m,message:r.message_template,organizationId:s.id,campaignId:i}});if(x)throw console.error("Error sending SMS campaign:",x),new Error(x.message||"Failed to send campaign");return console.log("SMS campaign sent successfully:",j),j},onSuccess:(i,o)=>{const r=o.isResend?"Resent":"Sent";h({title:`Campaign ${r.toLowerCase()} successfully`,description:`${r} to ${i.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:i=>{console.error("Send campaign error:",i),h({title:"Error sending campaign",description:i.message||"An unexpected error occurred",variant:"destructive"})}});return{campaigns:t||[],campaignsLoading:l,campaignsError:u,phoneNumbers:c||[],phoneNumbersLoading:p,phoneNumbersError:n,createCampaignMutation:f,sendCampaignMutation:g,organization:s}},Xe=({onSubmit:s,onCancel:a,isLoading:t,phoneNumbersCount:l,organizationName:u})=>{const[c,p]=N.useState(""),[n,f]=N.useState(""),g=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${u||"Your Company"}`,i=o=>{o.preventDefault(),!(!c.trim()||!n.trim())&&(s(c,n),p(""),f(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:i,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(E,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(T,{id:"campaign-name",value:c,onChange:o=>p(o.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(E,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(z,{id:"message-template",value:n,onChange:o=>f(o.target.value),placeholder:g,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",l," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:t,children:"Create Campaign"}),e.jsx(y,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},Ze=({campaign:s,onSend:a,onResend:t,isLoading:l})=>{const u=c=>{switch(c){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:u(s.status),children:s.status}),s.status==="draft"&&e.jsxs(y,{size:"sm",onClick:()=>a(s.id),disabled:l,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>t(s.id),disabled:l,children:[e.jsx(Ae,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:s.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:s.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:s.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]})},ze=({campaigns:s,onSend:a,onResend:t,isLoading:l})=>s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Me,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),s.map(u=>e.jsx(Ze,{campaign:u,onSend:a,onResend:t,isLoading:l},u.id))]}),es=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),ss=()=>{const[s,a]=N.useState(!1),{campaigns:t,campaignsLoading:l,campaignsError:u,phoneNumbers:c,phoneNumbersLoading:p,phoneNumbersError:n,createCampaignMutation:f,sendCampaignMutation:g,organization:i}=Je(),o=(j,x)=>{f.mutate({name:j,template:x},{onSuccess:()=>{a(!1)}})},r=j=>{g.mutate({campaignId:j})},m=j=>{g.mutate({campaignId:j,isResend:!0})};return l||p?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):u||n?e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(_,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(X,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(u==null?void 0:u.message)||(n==null?void 0:n.message)||"An unexpected error occurred"})]})]})})]}):e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Campaigns (",t.length,")"]}),e.jsxs(y,{onClick:()=>a(!0),disabled:c.length===0,children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(_,{className:"space-y-6",children:c.length===0?e.jsx(es,{}):e.jsxs(e.Fragment,{children:[s&&e.jsx(Xe,{onSubmit:o,onCancel:()=>a(!1),isLoading:f.isPending,phoneNumbersCount:c.length,organizationName:i==null?void 0:i.name}),e.jsx(ze,{campaigns:t,onSend:r,onResend:m,isLoading:g.isPending})]})})]})},as=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:M,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:M,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:M,status:"coming_soon"}],Q=(s,a)=>{if(!s||typeof s!="object")return"";const t=s[a];return typeof t=="string"?t:""},ts=s=>{if(!s||typeof s!="object")return!1;const a=Q(s,"username"),t=Q(s,"apiKey");return a.length>0&&t.length>0},ns=()=>{const{organization:s}=U(),{isAdmin:a,isOrgAdmin:t}=ee(),l=Y(),[u,c]=N.useState(null),p=a||t,{data:n,isLoading:f,error:g}=D({queryKey:["organization-sms-settings",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return null;console.log("Fetching SMS settings for organization:",s.id);const{data:m,error:j}=await b.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(j)throw console.error("Error fetching organization SMS settings:",j),j;return console.log("Organization SMS settings fetched:",m),m},enabled:!!(s!=null&&s.id)&&p,retry:3,retryDelay:1e3}),i=P({mutationFn:async m=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:m,orgId:s.id});const{data:j,error:x}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:m,senderId:(n==null?void 0:n.sms_sender_id)||"",username:Q(n==null?void 0:n.sms_settings,"username"),apiKey:Q(n==null?void 0:n.sms_settings,"apiKey")}});if(x)throw console.error("SMS status update error:",x),new Error(x.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",j),j},onSuccess:()=>{h({title:"SMS status updated successfully"}),l.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})},onError:m=>{console.error("SMS toggle error:",m),h({title:"Error updating SMS status",description:m.message||"An unexpected error occurred",variant:"destructive"})}}),o=m=>{if(!p){h({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}i.mutate(m)};if(!p)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]});if(f)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]});if(g)return e.jsxs(S,{children:[e.jsx(C,{children:e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(_,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Failed to load SMS settings"}),e.jsx("button",{onClick:()=>l.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]}),className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]});const r=(n==null?void 0:n.sms_enabled)&&ts(n==null?void 0:n.sms_settings);return e.jsxs(S,{children:[e.jsxs(C,{children:[e.jsxs(k,{className:"flex items-center gap-2",children:[e.jsx(M,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(W,{children:"Enable SMS feedback collection from your customers"})]}),e.jsxs(_,{className:"space-y-6",children:[e.jsx($e,{enabled:(n==null?void 0:n.sms_enabled)||!1,onToggle:o,isLoading:i.isPending}),(n==null?void 0:n.sms_enabled)&&e.jsx(He,{webhookSecret:(n==null?void 0:n.webhook_secret)||"",isVisible:!0}),e.jsx(We,{providers:as,selectedProvider:u,onProviderSelect:c}),u==="africastalking"&&e.jsx(Ye,{organization:s,currentSettings:n,onSettingsUpdate:()=>{l.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})}}),r&&e.jsx("div",{className:"mt-6",children:e.jsxs(Pe,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(qe,{className:"grid w-full grid-cols-2",children:[e.jsx(V,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx(V,{value:"campaigns",children:"Campaigns"})]}),e.jsx(H,{value:"phone-numbers",className:"mt-6",children:e.jsx(Ge,{})}),e.jsx(H,{value:"campaigns",className:"mt-6",children:e.jsx(ss,{})})]})})]})]})},is=()=>{const{isAdmin:s,isOrgAdmin:a}=ee();return U(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(ns,{}),e.jsx(Qe,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{is as IntegrationsTab,is as default};
