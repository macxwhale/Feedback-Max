import{c as M,s as C,Y,Z as Q,r as w,u as $,_ as E,j as e,C as _,a as F,b as T,d as X,e as A,$ as K,g as y,a0 as me,w as Me,x as Pe,y as z,z as V,A as Fe,E as U,S as Te,B as O,f as De,a1 as qe,a2 as ue,a3 as he,a4 as xe,a5 as pe,a6 as je,a7 as ge,a8 as fe,a9 as ye,aa as Ne,ab as Ee,ac as Ie,ad as Ke,ae as Le,af as Re,ag as Ue,ah as Oe,ai as ve,aj as u,ak as D,I as ee,al as be,am as Be,an as Ve,ao as $e,ap as we,M as I,aq as Z,ar as Ce,K as W,as as ke,at as se,T as We,G as Se,i as Ye,au as Qe,av as te,aw as ze,ax as He,ay as Ge,az as H,aA as Je,aB as Ze,aC as Xe,aD as ne,aE as re,aF as ie,aG as le,aH as R,p as es,q as ss,t as ce,v as de}from"./index-CZjWqr4R.js";import{S as _e}from"./switch-jcBRAiAn.js";import{P as Ae}from"./progress-BDJO-m-b.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const as=M("ArrowDownWideNarrow",[["path",{d:"m3 16 4 4 4-4",key:"1co6wj"}],["path",{d:"M7 20V4",key:"1yoxec"}],["path",{d:"M11 4h10",key:"1w87gc"}],["path",{d:"M11 8h7",key:"djye34"}],["path",{d:"M11 12h4",key:"q8tih4"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ts=M("ArrowUpNarrowWide",[["path",{d:"m3 8 4-4 4 4",key:"11wl7u"}],["path",{d:"M7 4v16",key:"1glfcx"}],["path",{d:"M11 12h4",key:"q8tih4"}],["path",{d:"M11 16h7",key:"uosisv"}],["path",{d:"M11 20h10",key:"jvxblo"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ns=M("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const G=M("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const rs=M("EllipsisVertical",[["circle",{cx:"12",cy:"12",r:"1",key:"41hilf"}],["circle",{cx:"12",cy:"5",r:"1",key:"gxeob9"}],["circle",{cx:"12",cy:"19",r:"1",key:"lyex9k"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const is=M("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ls=M("Filter",[["polygon",{points:"22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3",key:"1yg77f"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const cs=M("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=M("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ds=M("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const os=M("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ms=M("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const us=M("Square",[["rect",{width:"18",height:"18",x:"3",y:"3",rx:"2",key:"afitv7"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const hs=M("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),xs=async s=>{const{data:a,error:t}=await C.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(t)throw t;return a},ps=async(s,a)=>{const{data:t,error:i}=await C.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(i)throw i;return t},js=async(s,a)=>{const{data:t,error:i}=await C.from("api_keys").update({status:a}).eq("id",s).select().single();if(i)throw i;return t},gs=({apiKey:s})=>{const[a,t]=w.useState(!1),i=()=>{navigator.clipboard.writeText(s),t(!0),u({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>t(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(y,{variant:"ghost",size:"icon",onClick:i,children:a?e.jsx(ve,{className:"h-4 w-4 text-green-500"}):e.jsx(G,{className:"h-4 w-4"})})]})},fs=()=>{const{organization:s}=Y(),a=Q(),[t,i]=w.useState(""),[r,o]=w.useState(null),l=["apiKeys",s==null?void 0:s.id],{data:c,isLoading:d}=$({queryKey:l,queryFn:()=>xs(s.id),enabled:!!s}),h=E({mutationFn:n=>ps(s.id,n),onSuccess:n=>{u({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),o(n),i(""),a.invalidateQueries({queryKey:l})},onError:n=>{u({title:"Error",description:n.message,variant:"destructive"})}}),m=E({mutationFn:({keyId:n,status:x})=>js(n,x),onSuccess:()=>{u({title:"Status Updated"}),a.invalidateQueries({queryKey:l})},onError:n=>{u({title:"Error",description:n.message,variant:"destructive"})}}),g=n=>{n.preventDefault(),t.trim()&&s&&h.mutate(t.trim())};return e.jsxs(_,{className:"w-full",children:[e.jsxs(F,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(cs,{})," API Keys"]}),e.jsx(X,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(A,{children:[e.jsxs("form",{onSubmit:g,className:"flex items-center gap-2 mb-6",children:[e.jsx(K,{placeholder:"New key name (e.g., 'SMS Integration')",value:t,onChange:n=>i(n.target.value),disabled:h.isPending}),e.jsxs(y,{type:"submit",disabled:!t.trim()||h.isPending,children:[h.isPending?e.jsx(me,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(ns,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(Me,{children:[e.jsx(Pe,{children:e.jsxs(z,{children:[e.jsx(V,{children:"Name"}),e.jsx(V,{children:"Key Prefix"}),e.jsx(V,{children:"Status"}),e.jsx(V,{children:"Last Used"}),e.jsx(V,{children:"Created"}),e.jsx(V,{className:"text-right",children:"Actions"})]})}),e.jsx(Fe,{children:d?Array.from({length:3}).map((n,x)=>e.jsx(z,{children:e.jsx(U,{colSpan:6,children:e.jsx(Te,{className:"h-8 w-full"})})},x)):c&&c.length>0?c.map(n=>e.jsxs(z,{children:[e.jsx(U,{className:"font-medium",children:n.key_name}),e.jsx(U,{children:e.jsxs("code",{children:[n.key_prefix,"..."]})}),e.jsx(U,{children:e.jsx(O,{variant:n.status==="active"?"default":"secondary",children:n.status})}),e.jsx(U,{children:n.last_used_at?`${De(new Date(n.last_used_at))} ago`:"Never"}),e.jsx(U,{children:qe(new Date(n.created_at),"MMM d, yyyy")}),e.jsx(U,{className:"text-right",children:e.jsxs(ue,{children:[e.jsx(he,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"icon",disabled:m.isPending,children:n.status==="active"?e.jsx(ds,{className:"h-4 w-4"}):e.jsx(os,{className:"h-4 w-4"})})}),e.jsxs(xe,{children:[e.jsxs(pe,{children:[e.jsx(je,{children:"Are you sure?"}),e.jsxs(ge,{children:["This will ",n.status==="active"?"deactivate":"activate"," the API key.",n.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(fe,{children:[e.jsx(ye,{children:"Cancel"}),e.jsx(Ne,{onClick:()=>m.mutate({keyId:n.id,status:n.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},n.id)):e.jsx(z,{children:e.jsx(U,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(Ee,{open:!!r,onOpenChange:n=>!n&&o(null),children:e.jsxs(Ie,{children:[e.jsxs(Ke,{children:[e.jsx(Le,{children:"API Key Created Successfully"}),e.jsx(Re,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(gs,{apiKey:r||""}),e.jsx(Ue,{children:e.jsx(Oe,{asChild:!0,children:e.jsx(y,{children:"Close"})})})]})})]})]})},ys=({organization:s,currentSettings:a,onSettingsUpdate:t})=>{var g,n,x,N;const[i,r]=w.useState(((g=a==null?void 0:a.sms_settings)==null?void 0:g.username)||""),[o,l]=w.useState(""),[c,d]=w.useState((a==null?void 0:a.sms_sender_id)||""),h=E({mutationFn:async()=>{const{data:f,error:p}=await C.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:c.trim(),username:i.trim(),apiKey:o.trim()}});if(p)throw p;return f},onSuccess:()=>{u({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),l(""),t()},onError:f=>{u({title:"Error saving settings",description:f.message,variant:"destructive"})}}),m=f=>{var p;if(f.preventDefault(),!i.trim()){u({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!o.trim()&&!((p=a==null?void 0:a.sms_settings)!=null&&p.apiKey)){u({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}h.mutate()};return e.jsxs(_,{className:"mt-4",children:[e.jsx(F,{children:e.jsx(T,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(A,{children:e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"at-username",children:"Username *"}),e.jsx(K,{id:"at-username",value:i,onChange:f=>r(f.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(K,{id:"at-sender-id",value:c,onChange:f=>d(f.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(K,{id:"at-api-key",type:"password",value:o,onChange:f=>l(f.target.value),placeholder:(n=a==null?void 0:a.sms_settings)!=null&&n.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((x=a==null?void 0:a.sms_settings)!=null&&x.apiKey)}),((N=a==null?void 0:a.sms_settings)==null?void 0:N.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(ee,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(y,{type:"submit",disabled:h.isPending,className:"flex items-center gap-2",children:[h.isPending?e.jsx(me,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(y,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(is,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},Ns=({enabled:s,onToggle:a,isLoading:t})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(_e,{checked:s,onCheckedChange:a,disabled:t})]}),vs=({enabled:s,onToggle:a,isLoading:t=!1})=>e.jsxs(_,{children:[e.jsxs(F,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5"}),"SMS Integration Method"]}),e.jsx(X,{children:"Choose between direct Africa's Talking integration or Flask wrapper API"})]}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(D,{htmlFor:"flask-wrapper",className:"text-base",children:"Use Flask Wrapper API"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:s?"Using Flask wrapper for SMS delivery":"Using direct Africa's Talking integration"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(D,{htmlFor:"flask-wrapper",className:"text-sm text-muted-foreground",children:"Direct"}),e.jsx(_e,{id:"flask-wrapper",checked:s,onCheckedChange:a,disabled:t}),e.jsx(D,{htmlFor:"flask-wrapper",className:"text-sm text-muted-foreground",children:"Flask"}),s&&e.jsx(Be,{className:"w-4 h-4 text-orange-500"})]})]})})]}),bs=({webhookSecret:s,isVisible:a,isFlaskWrapper:t=!1})=>{const[i,r]=w.useState(!1),c=`${window.location.origin}${t?"/functions/v1/handle-flask-sms-callback":"/functions/v1/handle-sms-webhook"}`,d=h=>{navigator.clipboard.writeText(h),u({title:"Copied to clipboard",description:"Webhook URL has been copied to your clipboard"})};return a?e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(Ve,{className:"w-5 h-5"}),t?"Flask Webhook Configuration":"SMS Webhook Configuration"]})}),e.jsxs(A,{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Webhook URL"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{value:c,readOnly:!0,className:"font-mono text-sm"}),e.jsx(y,{onClick:()=>d(c),variant:"outline",size:"icon",children:e.jsx(G,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t?"Configure your Flask wrapper to send callbacks to this URL":"Configure this URL in your Africa's Talking SMS callback settings"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(D,{children:"Webhook Secret"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(K,{type:i?"text":"password",value:s,readOnly:!0,className:"font-mono text-sm"}),e.jsx(y,{onClick:()=>r(!i),variant:"outline",size:"icon",type:"button",children:i?e.jsx($e,{className:"w-4 h-4"}):e.jsx(we,{className:"w-4 h-4"})}),e.jsx(y,{onClick:()=>d(s),variant:"outline",size:"icon",children:e.jsx(G,{className:"w-4 h-4"})})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use this secret to verify webhook authenticity"})]}),t&&e.jsx("div",{className:"p-4 bg-muted rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-blue-500 mt-0.5"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"font-medium text-sm",children:"Flask Integration Notes:"}),e.jsxs("ul",{className:"text-sm text-muted-foreground space-y-1",children:[e.jsx("li",{children:"• Your Flask wrapper should forward SMS callbacks to the webhook URL above"}),e.jsx("li",{children:"• Include the webhook secret in your callback validation"}),e.jsxs("li",{children:["• Ensure the callback format matches: ","{linkId, text, to, id, date, from}"]}),e.jsx("li",{children:"• The 'to' field should contain your organization's sender ID"})]})]})]})})]})]}):null},ws=({providers:s,selectedProvider:a,onProviderSelect:t})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(i=>{const r=i.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===i.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>i.status==="available"&&t(a===i.id?null:i.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(r,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:i.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:i.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(O,{variant:"default",children:"Available"}),a===i.id&&e.jsx(ve,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(O,{variant:"secondary",children:"Coming Soon"})})]})},i.id)})]}),Cs=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:I,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:I,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:I,status:"coming_soon"}],J=(s,a)=>{if(!s||typeof s!="object")return"";const t=s[a];return typeof t=="string"?t:""},ks=s=>{if(!s||typeof s!="object")return!1;const a=J(s,"username"),t=J(s,"apiKey");return a.length>0&&t.length>0},Ss=()=>e.jsxs(F,{children:[e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(X,{children:"Enable SMS feedback collection from your customers"})]}),_s=({title:s="SMS Integrations"})=>e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),s]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}),As=({title:s="SMS Integrations",message:a,onRetry:t})=>e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(ee,{className:"w-5 h-5 text-red-500"}),s]})}),e.jsx(A,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Organization not found or failed to load"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:a}),t&&e.jsx("button",{onClick:t,className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]}),Ms=()=>e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(A,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]}),Ps=({phoneNumber:s,name:a,onPhoneNumberChange:t,onNameChange:i,onSubmit:r,isLoading:o})=>e.jsx("form",{onSubmit:r,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(K,{id:"phone-number",value:s,onChange:l=>t(l.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(K,{id:"name",value:a,onChange:l=>i(l.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(y,{type:"submit",disabled:o,className:"w-full",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),Fs=({bulkNumbers:s,onBulkNumbersChange:a,onBulkAdd:t,onCancel:i,isLoading:r})=>e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(Ce,{id:"bulk-numbers",value:s,onChange:o=>a(o.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{onClick:t,disabled:r,children:"Add All Numbers"}),e.jsx(y,{variant:"outline",onClick:i,children:"Cancel"})]})]}),Ts=({phoneNumbers:s,onDelete:a,isDeleting:t})=>{const i=r=>r.startsWith("+")?r:`+${r}`;return s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(W,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:s.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:i(r.phone_number)}),r.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:r.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(O,{variant:r.status==="active"?"default":"secondary",children:r.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(r.created_at).toLocaleDateString()]})]})]}),e.jsx(y,{variant:"ghost",size:"sm",onClick:()=>a(r.id),disabled:t,children:e.jsx(ke,{className:"w-4 h-4"})})]},r.id))})]})},Ds=()=>{const{organization:s}=Y(),a=Q(),[t,i]=w.useState(""),[r,o]=w.useState(""),[l,c]=w.useState(""),[d,h]=w.useState(!1),{data:m,isLoading:g}=$({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:j,error:b}=await C.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(b)throw b;return j},enabled:!!(s!=null&&s.id)}),n=E({mutationFn:async({phoneNumber:j,name:b})=>{const{data:S,error:k}=await C.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:j.trim(),name:(b==null?void 0:b.trim())||null}).select().single();if(k)throw k;return S},onSuccess:()=>{u({title:"Phone number added successfully"}),i(""),o(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:j=>{u({title:"Error adding phone number",description:j.message,variant:"destructive"})}}),x=E({mutationFn:async j=>{const{data:b,error:S}=await C.from("sms_phone_numbers").insert(j.map(({phoneNumber:k,name:P})=>({organization_id:s.id,phone_number:k.trim(),name:(P==null?void 0:P.trim())||null})));if(S)throw S;return b},onSuccess:()=>{u({title:"Phone numbers added successfully"}),c(""),h(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:j=>{u({title:"Error adding phone numbers",description:j.message,variant:"destructive"})}}),N=E({mutationFn:async j=>{const{error:b}=await C.from("sms_phone_numbers").delete().eq("id",j);if(b)throw b},onSuccess:()=>{u({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:j=>{u({title:"Error removing phone number",description:j.message,variant:"destructive"})}}),f=j=>{j.preventDefault(),t.trim()&&n.mutate({phoneNumber:t,name:r})},p=()=>{const b=l.split(`
`).filter(S=>S.trim()).map(S=>{const k=S.split(",").map(P=>P.trim());return{phoneNumber:k[0],name:k[1]||void 0}}).filter(S=>S.phoneNumber);if(b.length===0){u({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}x.mutate(b)};return g?e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(_,{children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(W,{className:"w-5 h-5"}),"Phone Numbers (",(m==null?void 0:m.length)||0,")"]})}),e.jsxs(A,{className:"space-y-6",children:[e.jsx(Ps,{phoneNumber:t,name:r,onPhoneNumberChange:i,onNameChange:o,onSubmit:f,isLoading:n.isPending}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(y,{variant:"outline",onClick:()=>h(!d),children:[e.jsx(hs,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),d&&e.jsx(Fs,{bulkNumbers:l,onBulkNumbersChange:c,onBulkAdd:p,onCancel:()=>h(!1),isLoading:x.isPending}),e.jsx(Ts,{phoneNumbers:m||[],onDelete:j=>N.mutate(j),isDeleting:N.isPending})]})]})},qs=()=>{const{user:s}=se(),{organization:a}=Y(),t=Q(),{data:i=[],isLoading:r,error:o}=$({queryKey:["sms-campaigns",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:n,error:x}=await C.from("sms_campaigns").select("*").eq("organization_id",a.id).order("created_at",{ascending:!1});if(x)throw x;return n||[]},enabled:!!(a!=null&&a.id)}),{data:l=[],isLoading:c,error:d}=$({queryKey:["sms-phone-numbers",a==null?void 0:a.id],queryFn:async()=>{if(!(a!=null&&a.id))return[];const{data:n,error:x}=await C.from("sms_phone_numbers").select("*").eq("organization_id",a.id).eq("status","active").order("created_at",{ascending:!1});if(x)throw x;return n||[]},enabled:!!(a!=null&&a.id)}),h=E({mutationFn:async({name:n,template:x})=>{if(!(a!=null&&a.id)||!(s!=null&&s.id))throw new Error("Missing organization or user");const{data:N,error:f}=await C.from("sms_campaigns").insert({organization_id:a.id,name:n,message_template:x,created_by_user_id:s.id,status:"draft"}).select().single();if(f)throw f;return N},onSuccess:()=>{t.invalidateQueries({queryKey:["sms-campaigns"]}),u({title:"Success",description:"Campaign created successfully"})},onError:n=>{console.error("Error creating campaign:",n),u({title:"Error",description:"Failed to create campaign",variant:"destructive"})}}),m=E({mutationFn:async({campaignId:n,isResend:x=!1,isRetry:N=!1})=>{const{data:f,error:p}=await C.functions.invoke("send-sms-flask",{body:{campaignId:n,isResend:x,isRetry:N}});if(p)throw p;return f},onSuccess:n=>{t.invalidateQueries({queryKey:["sms-campaigns"]}),t.invalidateQueries({queryKey:["sms-sends"]}),u({title:"Success",description:`Campaign sent successfully! ${n.sentCount}/${n.sentCount+n.failedCount} messages delivered.`})},onError:n=>{console.error("Error sending campaign:",n),u({title:"Error",description:"Failed to send campaign",variant:"destructive"})}}),g=E({mutationFn:async({campaignId:n,action:x})=>{let N;switch(x){case"pause":N="paused";break;case"resume":N="sending";break;case"cancel":N="cancelled";break;default:throw new Error("Invalid action")}const{error:f}=await C.from("sms_campaigns").update({status:N}).eq("id",n);if(f)throw f},onSuccess:(n,{action:x})=>{t.invalidateQueries({queryKey:["sms-campaigns"]}),u({title:"Success",description:`Campaign ${x}d successfully`})},onError:n=>{console.error("Error controlling campaign:",n),u({title:"Error",description:"Failed to update campaign status",variant:"destructive"})}});return{campaigns:i,campaignsLoading:r,campaignsError:o,phoneNumbers:l,phoneNumbersLoading:c,phoneNumbersError:d,createCampaignMutation:h,sendCampaignMutation:m,campaignControlMutation:g,organization:a}},Es=({onSubmit:s,onCancel:a,isLoading:t,phoneNumbersCount:i,organizationName:r})=>{const[o,l]=w.useState(""),[c,d]=w.useState(""),h=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${r||"Your Company"}`,m=g=>{g.preventDefault(),!(!o.trim()||!c.trim())&&(s(o,c),l(""),d(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:m,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(D,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(K,{id:"campaign-name",value:o,onChange:g=>l(g.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(D,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(Ce,{id:"message-template",value:c,onChange:g=>d(g.target.value),placeholder:h,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",i," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(y,{type:"submit",disabled:t,children:"Create Campaign"}),e.jsx(y,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},Is=({campaign:s})=>{const a=s.sent_count>0?s.delivered_count/s.sent_count*100:0,t=s.sent_count>0?s.failed_count/s.sent_count*100:0,i=s.total_recipients>0?s.sent_count/s.total_recipients*100:0,r=()=>{if(!s.started_at)return null;const o=new Date(s.started_at),c=(s.completed_at?new Date(s.completed_at):new Date).getTime()-o.getTime(),d=Math.round(c/(1e3*60));return d<60?`${d}m`:`${Math.round(d/60)}h ${d%60}m`};return e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3 mt-4",children:[e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(W,{className:"w-4 h-4 text-blue-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-blue-900",children:s.sent_count}),e.jsx("div",{className:"text-xs text-blue-600",children:"Sent"}),e.jsx(Ae,{value:i,className:"h-1 mt-1"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-green-50 rounded-lg",children:[e.jsx(We,{className:"w-4 h-4 text-green-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-green-900",children:[a.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-green-600",children:"Delivered"}),e.jsxs("div",{className:"text-xs text-gray-500 mt-1",children:[s.delivered_count,"/",s.sent_count]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-red-50 rounded-lg",children:[e.jsx(Se,{className:"w-4 h-4 text-red-600"}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-sm font-medium text-red-900",children:[t.toFixed(1),"%"]}),e.jsx("div",{className:"text-xs text-red-600",children:"Failed"}),e.jsx("div",{className:"text-xs text-gray-500 mt-1",children:s.failed_count})]})]}),e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-purple-50 rounded-lg",children:[e.jsx(Ye,{className:"w-4 h-4 text-purple-600"}),e.jsxs("div",{children:[e.jsx("div",{className:"text-sm font-medium text-purple-900",children:r()||"N/A"}),e.jsx("div",{className:"text-xs text-purple-600",children:"Duration"}),e.jsx(O,{variant:"outline",className:"text-xs mt-1",children:s.status})]})]})]})},Ks=({campaign:s,onSend:a,onResend:t,onRetry:i,onDuplicate:r,onSchedule:o,onDelete:l,onCancel:c,onPause:d,onResume:h,isLoading:m})=>{const[g,n]=w.useState(!1),x=j=>{switch(j){case"completed":return"default";case"sending":return"secondary";case"paused":return"outline";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}},N=j=>{switch(j){case"completed":return"text-green-600";case"sending":return"text-blue-600";case"paused":return"text-yellow-600";case"failed":return"text-red-600";case"draft":return"text-gray-600";default:return"text-gray-600"}},f=s.total_recipients>0?s.sent_count/s.total_recipients*100:0,p=s.status==="sending"&&s.started_at&&new Date().getTime()-new Date(s.started_at).getTime()>10*60*1e3;return e.jsx(_,{className:"transition-all duration-200 hover:shadow-md",children:e.jsxs(A,{className:"p-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("h5",{className:"font-semibold text-lg",children:s.name}),e.jsx(O,{variant:x(s.status),className:N(s.status),children:s.status.charAt(0).toUpperCase()+s.status.slice(1)}),p&&e.jsxs(O,{variant:"destructive",className:"text-orange-700 bg-orange-100",children:[e.jsx(Se,{className:"w-3 h-3 mr-1"}),"Stuck"]})]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Created ",new Date(s.created_at).toLocaleDateString()," • ",s.total_recipients," recipients"]}),(s.status==="sending"||s.status==="paused")&&e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex justify-between text-xs text-gray-600 mb-1",children:[e.jsx("span",{children:"Progress"}),e.jsxs("span",{children:[s.sent_count,"/",s.total_recipients]})]}),e.jsx(Ae,{value:f,className:"h-2"})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.status==="draft"&&e.jsxs(y,{size:"sm",onClick:()=>a(s.id),disabled:m,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="sending"&&e.jsxs(e.Fragment,{children:[e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>d(s.id),disabled:m,children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"Pause"]}),e.jsxs(y,{size:"sm",variant:"destructive",onClick:()=>c(s.id),disabled:m,children:[e.jsx(us,{className:"w-4 h-4 mr-2"}),"Cancel"]})]}),s.status==="paused"&&e.jsxs(y,{size:"sm",onClick:()=>h(s.id),disabled:m,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(oe,{className:"w-4 h-4 mr-2"}),"Resume"]}),s.status==="failed"&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:m,children:[e.jsx(ms,{className:"w-4 h-4 mr-2"}),"Retry"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>t(s.id),disabled:m,children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Resend Failed"]}),p&&e.jsxs(y,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:m,className:"border-orange-500 text-orange-700 hover:bg-orange-50",children:[e.jsx(te,{className:"w-4 h-4 mr-2"}),"Force Retry"]}),e.jsxs(ze,{children:[e.jsx(He,{asChild:!0,children:e.jsx(y,{variant:"ghost",size:"sm",children:e.jsx(rs,{className:"w-4 h-4"})})}),e.jsxs(Ge,{align:"end",children:[e.jsxs(H,{onClick:()=>n(!g),children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),g?"Hide":"Show"," Analytics"]}),e.jsxs(H,{onClick:()=>r(s.id),children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Duplicate Campaign"]}),s.status==="draft"&&e.jsxs(H,{onClick:()=>o(s.id),children:[e.jsx(Je,{className:"w-4 h-4 mr-2"}),"Schedule Campaign"]}),e.jsx(Ze,{}),e.jsxs(ue,{children:[e.jsx(he,{asChild:!0,children:e.jsxs(H,{onSelect:j=>j.preventDefault(),className:"text-red-600",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Delete Campaign"]})}),e.jsxs(xe,{children:[e.jsxs(pe,{children:[e.jsx(je,{children:"Delete Campaign"}),e.jsxs(ge,{children:['Are you sure you want to delete "',s.name,'"? This action cannot be undone.']})]}),e.jsxs(fe,{children:[e.jsx(ye,{children:"Cancel"}),e.jsx(Ne,{onClick:()=>l(s.id),className:"bg-red-600 hover:bg-red-700",children:"Delete"})]})]})]})]})]})]})]}),e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"p-3 bg-blue-50 rounded-lg border-l-4 border-blue-500",children:[e.jsx("p",{className:"text-sm font-medium text-blue-900 mb-1",children:"Message Preview:"}),e.jsx("p",{className:"text-sm text-blue-800 leading-relaxed",children:s.message_template.length>120?`${s.message_template.substring(0,120)}...`:s.message_template})]})}),g&&e.jsx(Is,{campaign:s})]})})},Ls=({searchTerm:s,onSearchChange:a,statusFilter:t,onStatusFilterChange:i,sortBy:r,onSortByChange:o,sortOrder:l,onSortOrderChange:c,totalCampaigns:d,filteredCount:h})=>{const m=()=>{a(""),i("all"),o("created_at"),c("desc")},g=s||t!=="all";return e.jsxs("div",{className:"w-full space-y-4 p-4 bg-gray-50 rounded-lg border",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ls,{className:"w-4 h-4 text-gray-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Filters"}),g&&e.jsxs(O,{variant:"secondary",className:"text-xs",children:[h," of ",d]})]}),g&&e.jsx(y,{variant:"ghost",size:"sm",onClick:m,children:"Clear All"})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-3",children:[e.jsx("div",{className:"flex-1 min-w-0",children:e.jsxs("div",{className:"relative",children:[e.jsx(Xe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx(K,{placeholder:"Search campaigns...",value:s,onChange:n=>a(n.target.value),className:"pl-10 w-full"})]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs(ne,{value:t,onValueChange:i,children:[e.jsx(re,{className:"w-full sm:w-[150px]",children:e.jsx(ie,{placeholder:"Status"})}),e.jsxs(le,{children:[e.jsx(R,{value:"all",children:"All Status"}),e.jsx(R,{value:"draft",children:"Draft"}),e.jsx(R,{value:"sending",children:"Sending"}),e.jsx(R,{value:"completed",children:"Completed"}),e.jsx(R,{value:"failed",children:"Failed"})]})]}),e.jsxs(ne,{value:r,onValueChange:o,children:[e.jsx(re,{className:"w-full sm:w-[150px]",children:e.jsx(ie,{placeholder:"Sort by"})}),e.jsxs(le,{children:[e.jsx(R,{value:"created_at",children:"Created Date"}),e.jsx(R,{value:"name",children:"Name"}),e.jsx(R,{value:"total_recipients",children:"Recipients"}),e.jsx(R,{value:"delivered_count",children:"Delivery Rate"})]})]}),e.jsx(y,{variant:"outline",size:"sm",onClick:()=>c(l==="asc"?"desc":"asc"),className:"w-full sm:w-auto",children:l==="asc"?e.jsx(ts,{className:"w-4 h-4"}):e.jsx(as,{className:"w-4 h-4"})})]})]})]})},Rs=({campaigns:s,onSend:a,onResend:t,onRetry:i,onCancel:r,onPause:o,onResume:l,onDuplicate:c,onSchedule:d,onDelete:h,onCreateNew:m,isLoading:g})=>{const[n,x]=w.useState(""),[N,f]=w.useState("all"),[p,j]=w.useState("created_at"),[b,S]=w.useState("desc"),k=w.useMemo(()=>{let P=s.filter(v=>{const L=v.name.toLowerCase().includes(n.toLowerCase())||v.message_template.toLowerCase().includes(n.toLowerCase()),q=N==="all"||v.status===N;return L&&q});return P.sort((v,L)=>{let q=v[p],B=L[p];if(p==="created_at"&&(q=new Date(q).getTime(),B=new Date(B).getTime()),typeof q=="number"&&typeof B=="number")return b==="asc"?q-B:B-q;if(typeof q=="string"&&typeof B=="string"){const ae=q.localeCompare(B);return b==="asc"?ae:-ae}return 0}),P},[s,n,N,p,b]);return s.length===0?e.jsxs("div",{className:"w-full text-center p-12 bg-gray-50 rounded-lg border-2 border-dashed border-gray-200",children:[e.jsx(I,{className:"w-16 h-16 mx-auto mb-4 text-gray-400"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"No campaigns yet"}),e.jsx("p",{className:"text-gray-500 mb-6 max-w-md mx-auto",children:"Create your first SMS campaign to start reaching your audience with targeted messages."}),e.jsxs(y,{onClick:m,className:"bg-blue-600 hover:bg-blue-700",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"Create Your First Campaign"]})]}):e.jsxs("div",{className:"w-full space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Campaign Management"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.length," campaign",s.length!==1?"s":""," total",k.length!==s.length&&` • ${k.length} shown`]})]}),e.jsxs(y,{onClick:m,className:"bg-green-600 hover:bg-green-700",children:[e.jsx(Z,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]}),e.jsx(Ls,{searchTerm:n,onSearchChange:x,statusFilter:N,onStatusFilterChange:f,sortBy:p,onSortByChange:j,sortOrder:b,onSortOrderChange:S,totalCampaigns:s.length,filteredCount:k.length}),e.jsx("div",{className:"w-full space-y-4",children:k.length===0?e.jsxs("div",{className:"text-center p-8 bg-gray-50 rounded-lg",children:[e.jsx(I,{className:"w-12 h-12 mx-auto mb-4 text-gray-400"}),e.jsx("p",{className:"text-gray-500",children:"No campaigns match your current filters."}),e.jsx("p",{className:"text-sm text-gray-400 mt-1",children:"Try adjusting your search or filter criteria."})]}):k.map(P=>e.jsx(Ks,{campaign:P,onSend:a,onResend:t,onRetry:i,onCancel:r,onPause:o,onResume:l,onDuplicate:c,onSchedule:d,onDelete:h,isLoading:g},P.id))})]})},Us=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(W,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),Os=()=>{const[s,a]=w.useState(!1),{campaigns:t,campaignsLoading:i,campaignsError:r,phoneNumbers:o,phoneNumbersLoading:l,phoneNumbersError:c,createCampaignMutation:d,sendCampaignMutation:h,campaignControlMutation:m,organization:g}=qs(),n=(v,L)=>{d.mutate({name:v,template:L},{onSuccess:()=>{a(!1)}})},x=v=>{h.mutate({campaignId:v})},N=v=>{h.mutate({campaignId:v,isResend:!0})},f=v=>{h.mutate({campaignId:v,isRetry:!0})},p=v=>{m.mutate({campaignId:v,action:"cancel"})},j=v=>{m.mutate({campaignId:v,action:"pause"})},b=v=>{m.mutate({campaignId:v,action:"resume"})},S=v=>{const L=t.find(q=>q.id===v);L&&(d.mutate({name:`${L.name} (Copy)`,template:L.message_template}),u({title:"Campaign duplicated successfully"}))},k=v=>{u({title:"Scheduling feature coming soon",description:"Campaign scheduling will be available in the next update."})},P=v=>{u({title:"Delete feature coming soon",description:"Campaign deletion will be available in the next update."})};return i||l?e.jsx("div",{className:"w-full",children:e.jsxs(_,{className:"w-full",children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(A,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]})}):r||c?e.jsx("div",{className:"w-full",children:e.jsxs(_,{className:"w-full",children:[e.jsx(F,{children:e.jsxs(T,{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(A,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(ee,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(r==null?void 0:r.message)||(c==null?void 0:c.message)||"An unexpected error occurred"})]})]})})]})}):e.jsx("div",{className:"w-full",children:e.jsxs(_,{className:"w-full",children:[e.jsx(F,{children:e.jsx(T,{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(I,{className:"w-5 h-5"}),"SMS Campaigns"]})})}),e.jsx(A,{className:"space-y-6 p-6",children:o.length===0?e.jsx(Us,{}):e.jsxs("div",{className:"w-full space-y-6",children:[s&&e.jsx("div",{className:"w-full",children:e.jsx(Es,{onSubmit:n,onCancel:()=>a(!1),isLoading:d.isPending,phoneNumbersCount:o.length,organizationName:g==null?void 0:g.name})}),e.jsx("div",{className:"w-full",children:e.jsx(Rs,{campaigns:t,onSend:x,onResend:N,onRetry:f,onCancel:p,onPause:j,onResume:b,onDuplicate:S,onSchedule:k,onDelete:P,onCreateNew:()=>a(!0),isLoading:h.isPending||m.isPending})})]})})]})})},Bs=()=>e.jsx("div",{className:"w-full mt-6",children:e.jsxs(es,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(ss,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsx(ce,{value:"phone-numbers",className:"flex-1",children:"Phone Numbers"}),e.jsx(ce,{value:"campaigns",className:"flex-1",children:"Campaigns"})]}),e.jsx(de,{value:"phone-numbers",className:"w-full mt-0",children:e.jsx("div",{className:"w-full",children:e.jsx(Ds,{})})}),e.jsx(de,{value:"campaigns",className:"w-full mt-0",children:e.jsx("div",{className:"w-full",children:e.jsx(Os,{})})})]})}),Vs=()=>{const{organization:s}=Y(),a=Q(),{data:t,isLoading:i,error:r}=$({queryKey:["organization-sms-settings",s==null?void 0:s.id],queryFn:async()=>{console.log("Fetching SMS settings for organization:",s==null?void 0:s.id);const{data:l,error:c}=await C.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(c)throw console.error("Error fetching organization SMS settings:",c),c;return console.log("Organization SMS settings fetched:",l),l},enabled:!!(s!=null&&s.id),retry:3,retryDelay:1e3}),o=E({mutationFn:async l=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:l,orgId:s.id});const{data:c,error:d}=await C.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:l,senderId:(t==null?void 0:t.sms_sender_id)||"",username:J(t==null?void 0:t.sms_settings,"username"),apiKey:J(t==null?void 0:t.sms_settings,"apiKey")}});if(d)throw console.error("SMS status update error:",d),new Error(d.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",c),c},onSuccess:()=>{u({title:"SMS status updated successfully"}),a.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})},onError:l=>{console.error("SMS toggle error:",l),u({title:"Error updating SMS status",description:l.message||"An unexpected error occurred",variant:"destructive"})}});return{orgData:t,isLoading:i,error:r,updateSmsStatus:o,organization:s}},$s=()=>{const{isAdmin:s,isOrgAdmin:a}=se(),[t,i]=w.useState(null),{orgData:r,isLoading:o,error:l,updateSmsStatus:c,organization:d}=Vs(),h=Q(),m=s||a,g=E({mutationFn:async p=>{if(!(d!=null&&d.id))throw new Error("Organization not found");const{error:j}=await C.from("organizations").update({sms_integration_type:p?"flask_wrapper":"direct"}).eq("id",d.id);if(j)throw j},onSuccess:()=>{h.invalidateQueries({queryKey:["sms-settings"]}),u({title:"Success",description:"SMS integration method updated successfully"})},onError:p=>{console.error("Error updating Flask wrapper setting:",p),u({title:"Error",description:"Failed to update SMS integration method",variant:"destructive"})}}),n=p=>{if(!m){u({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}if(!(d!=null&&d.id)){u({title:"Error",description:"Organization not found",variant:"destructive"});return}c.mutate(p)},x=p=>{if(!m){u({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}g.mutate(p)};if(!m)return e.jsx(Ms,{});if(o)return e.jsx(_s,{});if(l){const p=typeof l=="string"?l:"Failed to load SMS settings";return e.jsx(As,{message:p})}const N=(r==null?void 0:r.sms_enabled)&&ks(r==null?void 0:r.sms_settings),f=(r==null?void 0:r.sms_integration_type)==="flask_wrapper";return e.jsx("div",{className:"w-full",children:e.jsxs(_,{className:"w-full",children:[e.jsx(Ss,{}),e.jsxs(A,{className:"space-y-6 p-6",children:[e.jsx(Ns,{enabled:(r==null?void 0:r.sms_enabled)||!1,onToggle:n,isLoading:c.isPending}),(r==null?void 0:r.sms_enabled)&&e.jsxs(e.Fragment,{children:[e.jsx(vs,{enabled:f,onToggle:x,isLoading:g.isPending}),e.jsx(bs,{webhookSecret:(r==null?void 0:r.webhook_secret)||"",isVisible:!0,isFlaskWrapper:f})]}),e.jsx(ws,{providers:Cs,selectedProvider:t,onProviderSelect:i}),t==="africastalking"&&e.jsx(ys,{organization:d,currentSettings:r,onSettingsUpdate:()=>{}}),N&&e.jsx("div",{className:"w-full",children:e.jsx(Bs,{})})]})]})})},zs=()=>{const{isAdmin:s,isOrgAdmin:a}=se();return Y(),s||a?e.jsxs("div",{className:"w-full space-y-8",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."})]}),e.jsx("div",{className:"w-full",children:e.jsx($s,{})}),e.jsx("div",{className:"w-full",children:e.jsx(fs,{})})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{zs as IntegrationsTab,zs as default};
