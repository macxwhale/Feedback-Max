import{c as q,s as b,a4 as U,a5 as Q,r as v,u as D,a6 as A,j as e,C as w,a as S,b as C,d as W,e as k,a7 as E,g as j,a8 as G,w as se,x as ae,y as O,z as I,A as te,E as T,S as ne,B as R,f as re,a9 as ie,aa as le,ab as de,ac as ce,ad as oe,ae as me,af as ue,ag as he,ah as xe,ai as pe,aj as ge,ak as je,al as fe,am as ye,an as be,ao as ve,ap as Ne,aq as J,ar as h,as as F,I as H,at as we,au as Se,av as Ce,M as P,aw as z,ax as X,K as B,ay as ke,az as _e,aA as Me,p as Ae,q as Pe,t as $,v as V,aB as Z}from"./index-CbAbkCae.js";/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const qe=q("CirclePlus",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 12h8",key:"1wcyev"}],["path",{d:"M12 8v8",key:"napkw2"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ee=q("Copy",[["rect",{width:"14",height:"14",x:"8",y:"8",rx:"2",ry:"2",key:"17jyea"}],["path",{d:"M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2",key:"zix9uf"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Te=q("ExternalLink",[["path",{d:"M15 3h6v6",key:"1q9fwt"}],["path",{d:"M10 14 21 3",key:"gplh6r"}],["path",{d:"M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6",key:"a6xqqp"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ee=q("KeyRound",[["path",{d:"M2.586 17.414A2 2 0 0 0 2 18.828V21a1 1 0 0 0 1 1h3a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h1a1 1 0 0 0 1-1v-1a1 1 0 0 1 1-1h.172a2 2 0 0 0 1.414-.586l.814-.814a6.5 6.5 0 1 0-4-4z",key:"1s6t7t"}],["circle",{cx:"16.5",cy:"7.5",r:".5",fill:"currentColor",key:"w0ekpg"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Fe=q("Play",[["polygon",{points:"6 3 20 12 6 21 6 3",key:"1oa8hb"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ke=q("PowerOff",[["path",{d:"M18.36 6.64A9 9 0 0 1 20.77 15",key:"dxknvb"}],["path",{d:"M6.16 6.16a9 9 0 1 0 12.68 12.68",key:"1x7qb5"}],["path",{d:"M12 2v4",key:"3427ic"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Ie=q("Power",[["path",{d:"M12 2v10",key:"mnfbl"}],["path",{d:"M18.4 6.6a9 9 0 1 1-12.77.04",key:"obofu9"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const Le=q("RotateCcw",[["path",{d:"M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8",key:"1357e3"}],["path",{d:"M3 3v5h5",key:"1xhq8a"}]]);/**
 * @license lucide-react v0.462.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const De=q("Upload",[["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["polyline",{points:"17 8 12 3 7 8",key:"t8dd8p"}],["line",{x1:"12",x2:"12",y1:"3",y2:"15",key:"widbto"}]]),Re=async s=>{const{data:a,error:t}=await b.from("api_keys").select("id, key_name, key_prefix, status, last_used_at, expires_at, created_at").eq("organization_id",s).order("created_at",{ascending:!1});if(t)throw t;return a},Ue=async(s,a)=>{const{data:t,error:i}=await b.rpc("create_api_key",{p_organization_id:s,p_key_name:a});if(i)throw i;return t},Oe=async(s,a)=>{const{data:t,error:i}=await b.from("api_keys").update({status:a}).eq("id",s).select().single();if(i)throw i;return t},Be=({apiKey:s})=>{const[a,t]=v.useState(!1),i=()=>{navigator.clipboard.writeText(s),t(!0),h({title:"API Key Copied!",description:"The key has been copied to your clipboard."}),setTimeout(()=>t(!1),2e3)};return e.jsxs("div",{className:"flex items-center gap-2 p-3 bg-secondary rounded-md",children:[e.jsx("code",{className:"text-sm font-mono break-all",children:s}),e.jsx(j,{variant:"ghost",size:"icon",onClick:i,children:a?e.jsx(J,{className:"h-4 w-4 text-green-500"}):e.jsx(ee,{className:"h-4 w-4"})})]})},Ye=()=>{const{organization:s}=U(),a=Q(),[t,i]=v.useState(""),[n,d]=v.useState(null),c=["apiKeys",s==null?void 0:s.id],{data:m,isLoading:g}=D({queryKey:c,queryFn:()=>Re(s.id),enabled:!!s}),x=A({mutationFn:r=>Ue(s.id,r),onSuccess:r=>{h({title:"API Key Created",description:"Make sure to copy your key. You won't see it again."}),d(r),i(""),a.invalidateQueries({queryKey:c})},onError:r=>{h({title:"Error",description:r.message,variant:"destructive"})}}),l=A({mutationFn:({keyId:r,status:f})=>Oe(r,f),onSuccess:()=>{h({title:"Status Updated"}),a.invalidateQueries({queryKey:c})},onError:r=>{h({title:"Error",description:r.message,variant:"destructive"})}}),o=r=>{r.preventDefault(),t.trim()&&s&&x.mutate(t.trim())};return e.jsxs(w,{className:"col-span-1 lg:col-span-2",children:[e.jsxs(S,{children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(Ee,{})," API Keys"]}),e.jsx(W,{children:"Manage API keys for programmatic access to your organization's data."})]}),e.jsxs(k,{children:[e.jsxs("form",{onSubmit:o,className:"flex items-center gap-2 mb-6",children:[e.jsx(E,{placeholder:"New key name (e.g., 'SMS Integration')",value:t,onChange:r=>i(r.target.value),disabled:x.isPending}),e.jsxs(j,{type:"submit",disabled:!t.trim()||x.isPending,children:[x.isPending?e.jsx(G,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(qe,{className:"mr-2 h-4 w-4"}),"Create Key"]})]}),e.jsx("div",{className:"border rounded-md",children:e.jsxs(se,{children:[e.jsx(ae,{children:e.jsxs(O,{children:[e.jsx(I,{children:"Name"}),e.jsx(I,{children:"Key Prefix"}),e.jsx(I,{children:"Status"}),e.jsx(I,{children:"Last Used"}),e.jsx(I,{children:"Created"}),e.jsx(I,{className:"text-right",children:"Actions"})]})}),e.jsx(te,{children:g?Array.from({length:3}).map((r,f)=>e.jsx(O,{children:e.jsx(T,{colSpan:6,children:e.jsx(ne,{className:"h-8 w-full"})})},f)):m&&m.length>0?m.map(r=>e.jsxs(O,{children:[e.jsx(T,{className:"font-medium",children:r.key_name}),e.jsx(T,{children:e.jsxs("code",{children:[r.key_prefix,"..."]})}),e.jsx(T,{children:e.jsx(R,{variant:r.status==="active"?"default":"secondary",children:r.status})}),e.jsx(T,{children:r.last_used_at?`${re(new Date(r.last_used_at))} ago`:"Never"}),e.jsx(T,{children:ie(new Date(r.created_at),"MMM d, yyyy")}),e.jsx(T,{className:"text-right",children:e.jsxs(le,{children:[e.jsx(de,{asChild:!0,children:e.jsx(j,{variant:"ghost",size:"icon",disabled:l.isPending,children:r.status==="active"?e.jsx(Ke,{className:"h-4 w-4"}):e.jsx(Ie,{className:"h-4 w-4"})})}),e.jsxs(ce,{children:[e.jsxs(oe,{children:[e.jsx(me,{children:"Are you sure?"}),e.jsxs(ue,{children:["This will ",r.status==="active"?"deactivate":"activate"," the API key.",r.status==="active"?" Applications using it will lose access.":" Applications will regain access."]})]}),e.jsxs(he,{children:[e.jsx(xe,{children:"Cancel"}),e.jsx(pe,{onClick:()=>l.mutate({keyId:r.id,status:r.status==="active"?"inactive":"active"}),children:"Continue"})]})]})]})})]},r.id)):e.jsx(O,{children:e.jsx(T,{colSpan:6,className:"text-center text-muted-foreground py-8",children:"No API keys created yet."})})})]})}),e.jsx(ge,{open:!!n,onOpenChange:r=>!r&&d(null),children:e.jsxs(je,{children:[e.jsxs(fe,{children:[e.jsx(ye,{children:"API Key Created Successfully"}),e.jsx(be,{children:"Please copy this key and store it securely. You will not be able to see it again."})]}),e.jsx(Be,{apiKey:n||""}),e.jsx(ve,{children:e.jsx(Ne,{asChild:!0,children:e.jsx(j,{children:"Close"})})})]})})]})]})},Qe=({organization:s,currentSettings:a,onSettingsUpdate:t})=>{var o,r,f,_;const[i,n]=v.useState(((o=a==null?void 0:a.sms_settings)==null?void 0:o.username)||""),[d,c]=v.useState(""),[m,g]=v.useState((a==null?void 0:a.sms_sender_id)||""),x=A({mutationFn:async()=>{const{data:p,error:N}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:(a==null?void 0:a.sms_enabled)||!1,senderId:m.trim(),username:i.trim(),apiKey:d.trim()}});if(N)throw N;return p},onSuccess:()=>{h({title:"Africa's Talking settings saved successfully",description:"Your SMS integration is now configured"}),c(""),t()},onError:p=>{h({title:"Error saving settings",description:p.message,variant:"destructive"})}}),l=p=>{var N;if(p.preventDefault(),!i.trim()){h({title:"Username required",description:"Please enter your Africa's Talking username",variant:"destructive"});return}if(!d.trim()&&!((N=a==null?void 0:a.sms_settings)!=null&&N.apiKey)){h({title:"API Key required",description:"Please enter your Africa's Talking API key",variant:"destructive"});return}x.mutate()};return e.jsxs(w,{className:"mt-4",children:[e.jsx(S,{children:e.jsx(C,{className:"text-lg",children:"Africa's Talking Configuration"})}),e.jsx(k,{children:e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"at-username",children:"Username *"}),e.jsx(E,{id:"at-username",value:i,onChange:p=>n(p.target.value),placeholder:"Your Africa's Talking username",required:!0})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"at-sender-id",children:"Sender ID (Optional)"}),e.jsx(E,{id:"at-sender-id",value:m,onChange:p=>g(p.target.value),placeholder:"e.g., YourBrand",maxLength:11}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Max 11 characters. Leave blank to use default."})]})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"at-api-key",children:"API Key *"}),e.jsx(E,{id:"at-api-key",type:"password",value:d,onChange:p=>c(p.target.value),placeholder:(r=a==null?void 0:a.sms_settings)!=null&&r.apiKey?"Enter new API key (leave blank to keep current)":"Your Africa's Talking API key",required:!((f=a==null?void 0:a.sms_settings)!=null&&f.apiKey)}),((_=a==null?void 0:a.sms_settings)==null?void 0:_.apiKey)&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"API key is configured. Enter a new key only if you want to update it."})]}),e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-blue-50 rounded-lg",children:[e.jsx(H,{className:"w-4 h-4 text-blue-600 mt-0.5 flex-shrink-0"}),e.jsxs("div",{className:"text-sm",children:[e.jsx("p",{className:"font-medium text-blue-800",children:"Setup Instructions:"}),e.jsxs("ol",{className:"list-decimal list-inside text-blue-700 space-y-1 mt-1",children:[e.jsx("li",{children:"Get your credentials from Africa's Talking dashboard"}),e.jsx("li",{children:"Configure the webhook URL in your Africa's Talking app settings"}),e.jsx("li",{children:"Test the integration by sending an SMS to your shortcode"})]})]})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(j,{type:"submit",disabled:x.isPending,className:"flex items-center gap-2",children:[x.isPending?e.jsx(G,{className:"w-4 h-4 animate-spin"}):null,"Save Configuration"]}),e.jsxs(j,{type:"button",variant:"outline",onClick:()=>window.open("https://account.africastalking.com/","_blank"),className:"flex items-center gap-2",children:[e.jsx(Te,{className:"w-4 h-4"}),"Open Dashboard"]})]})]})})]})},He=({enabled:s,onToggle:a,isLoading:t})=>e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium",children:"SMS Feedback"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Allow customers to provide feedback via SMS"})]}),e.jsx(we,{checked:s,onCheckedChange:a,disabled:t})]}),$e=({webhookSecret:s,isVisible:a})=>{const[t,i]=v.useState(!1),d=`https://rigurrwjiaucodxuuzeh.supabase.co/functions/v1/handle-sms-webhook?secret=${s}`,c=async()=>{try{await navigator.clipboard.writeText(d),h({title:"Webhook URL copied to clipboard"})}catch(m){console.error("Failed to copy webhook URL:",m),h({title:"Failed to copy URL",description:"Please copy the URL manually",variant:"destructive"})}};return!a||!s?null:e.jsxs(w,{children:[e.jsx(S,{children:e.jsx(C,{className:"text-sm font-medium",children:"SMS Webhook URL"})}),e.jsxs(k,{className:"space-y-3",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:"Use this URL in your SMS provider's webhook configuration to receive incoming SMS messages."}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(E,{value:t?d:"â€¢".repeat(50),readOnly:!0,className:"font-mono text-xs"}),e.jsx(j,{variant:"outline",size:"sm",onClick:()=>i(!t),children:t?e.jsx(Se,{className:"w-4 h-4"}):e.jsx(Ce,{className:"w-4 h-4"})}),e.jsx(j,{variant:"outline",size:"sm",onClick:c,children:e.jsx(ee,{className:"w-4 h-4"})})]}),e.jsxs("div",{className:"text-xs text-muted-foreground space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Method:"})," POST"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Content-Type:"})," application/x-www-form-urlencoded or application/json"]})]})]})]})},Ve=({providers:s,selectedProvider:a,onProviderSelect:t})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-medium",children:"Available Providers"}),s.map(i=>{const n=i.icon;return e.jsx("div",{className:`border rounded-lg p-4 cursor-pointer transition-colors ${a===i.id?"border-blue-500 bg-blue-50":"border-gray-200 hover:border-gray-300"}`,onClick:()=>i.status==="available"&&t(a===i.id?null:i.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(n,{className:"w-6 h-6"}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:i.name}),e.jsx("p",{className:"text-sm text-muted-foreground",children:i.description})]})]}),e.jsx("div",{className:"flex items-center gap-2",children:i.status==="available"?e.jsxs(e.Fragment,{children:[e.jsx(R,{variant:"default",children:"Available"}),a===i.id&&e.jsx(J,{className:"w-4 h-4 text-blue-500"})]}):e.jsx(R,{variant:"secondary",children:"Coming Soon"})})]})},i.id)})]}),We=[{id:"africastalking",name:"Africa's Talking",description:"SMS services across Africa with reliable delivery",icon:P,status:"available"},{id:"twilio",name:"Twilio",description:"Global SMS and communication platform",icon:P,status:"coming_soon"},{id:"vonage",name:"Vonage",description:"SMS API for global messaging",icon:P,status:"coming_soon"}],Y=(s,a)=>{if(!s||typeof s!="object")return"";const t=s[a];return typeof t=="string"?t:""},Ge=s=>{if(!s||typeof s!="object")return!1;const a=Y(s,"username"),t=Y(s,"apiKey");return a.length>0&&t.length>0},Je=()=>e.jsxs(S,{children:[e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Integrations"]}),e.jsx(W,{children:"Enable SMS feedback collection from your customers"})]}),ze=({title:s="SMS Integrations"})=>e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),s]})}),e.jsx(k,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}),Xe=({title:s="SMS Integrations",message:a,onRetry:t})=>e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(H,{className:"w-5 h-5 text-red-500"}),s]})}),e.jsx(k,{children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-red-600 mb-2",children:"Organization not found or failed to load"}),e.jsx("p",{className:"text-xs text-gray-500 mb-4",children:a}),t&&e.jsx("button",{onClick:t,className:"text-sm text-blue-600 hover:underline",children:"Try again"})]})})]}),Ze=()=>e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Integrations"]})}),e.jsx(k,{children:e.jsx("p",{className:"text-sm text-muted-foreground",children:"You need admin access to manage SMS integrations."})})]}),es=({phoneNumber:s,name:a,onPhoneNumberChange:t,onNameChange:i,onSubmit:n,isLoading:d})=>e.jsx("form",{onSubmit:n,className:"space-y-4",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"phone-number",children:"Phone Number *"}),e.jsx(E,{id:"phone-number",value:s,onChange:c=>t(c.target.value),placeholder:"+1234567890",required:!0})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"name",children:"Name (Optional)"}),e.jsx(E,{id:"name",value:a,onChange:c=>i(c.target.value),placeholder:"John Doe"})]}),e.jsx("div",{className:"flex items-end",children:e.jsxs(j,{type:"submit",disabled:d,className:"w-full",children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"Add Number"]})})]})}),ss=({bulkNumbers:s,onBulkNumbersChange:a,onBulkAdd:t,onCancel:i,isLoading:n})=>e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"bulk-numbers",children:"Bulk Add Phone Numbers"}),e.jsx(X,{id:"bulk-numbers",value:s,onChange:d=>a(d.target.value),placeholder:"Enter phone numbers, one per line. Format: +1234567890 or +1234567890,John Doe",rows:6}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Format: One phone number per line. Optionally add name after comma."})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{onClick:t,disabled:n,children:"Add All Numbers"}),e.jsx(j,{variant:"outline",onClick:i,children:"Cancel"})]})]}),as=({phoneNumbers:s,onDelete:a,isDeleting:t})=>{const i=n=>n.startsWith("+")?n:`+${n}`;return s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No phone numbers added yet."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers to start sending SMS campaigns."})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-medium",children:"Registered Phone Numbers"}),e.jsx("div",{className:"space-y-2 max-h-64 overflow-y-auto",children:s.map(n=>e.jsxs("div",{className:"flex items-center justify-between p-3 border rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("div",{className:"font-medium",children:i(n.phone_number)}),n.name&&e.jsx("div",{className:"text-sm text-muted-foreground",children:n.name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[e.jsx(R,{variant:n.status==="active"?"default":"secondary",children:n.status}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Added ",new Date(n.created_at).toLocaleDateString()]})]})]}),e.jsx(j,{variant:"ghost",size:"sm",onClick:()=>a(n.id),disabled:t,children:e.jsx(ke,{className:"w-4 h-4"})})]},n.id))})]})},ts=()=>{const{organization:s}=U(),a=Q(),[t,i]=v.useState(""),[n,d]=v.useState(""),[c,m]=v.useState(""),[g,x]=v.useState(!1),{data:l,isLoading:o}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{const{data:u,error:y}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(y)throw y;return u},enabled:!!(s!=null&&s.id)}),r=A({mutationFn:async({phoneNumber:u,name:y})=>{const{data:M,error:K}=await b.from("sms_phone_numbers").insert({organization_id:s.id,phone_number:u.trim(),name:(y==null?void 0:y.trim())||null}).select().single();if(K)throw K;return M},onSuccess:()=>{h({title:"Phone number added successfully"}),i(""),d(""),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:u=>{h({title:"Error adding phone number",description:u.message,variant:"destructive"})}}),f=A({mutationFn:async u=>{const{data:y,error:M}=await b.from("sms_phone_numbers").insert(u.map(({phoneNumber:K,name:L})=>({organization_id:s.id,phone_number:K.trim(),name:(L==null?void 0:L.trim())||null})));if(M)throw M;return y},onSuccess:()=>{h({title:"Phone numbers added successfully"}),m(""),x(!1),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:u=>{h({title:"Error adding phone numbers",description:u.message,variant:"destructive"})}}),_=A({mutationFn:async u=>{const{error:y}=await b.from("sms_phone_numbers").delete().eq("id",u);if(y)throw y},onSuccess:()=>{h({title:"Phone number removed successfully"}),a.invalidateQueries({queryKey:["sms-phone-numbers",s==null?void 0:s.id]})},onError:u=>{h({title:"Error removing phone number",description:u.message,variant:"destructive"})}}),p=u=>{u.preventDefault(),t.trim()&&r.mutate({phoneNumber:t,name:n})},N=()=>{const y=c.split(`
`).filter(M=>M.trim()).map(M=>{const K=M.split(",").map(L=>L.trim());return{phoneNumber:K[0],name:K[1]||void 0}}).filter(M=>M.phoneNumber);if(y.length===0){h({title:"No valid phone numbers found",description:"Please enter at least one phone number",variant:"destructive"});return}f.mutate(y)};return o?e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers"]})}),e.jsx(k,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(B,{className:"w-5 h-5"}),"Phone Numbers (",(l==null?void 0:l.length)||0,")"]})}),e.jsxs(k,{className:"space-y-6",children:[e.jsx(es,{phoneNumber:t,name:n,onPhoneNumberChange:i,onNameChange:d,onSubmit:p,isLoading:r.isPending}),e.jsx("div",{className:"flex gap-2",children:e.jsxs(j,{variant:"outline",onClick:()=>x(!g),children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Bulk Add"]})}),g&&e.jsx(ss,{bulkNumbers:c,onBulkNumbersChange:m,onBulkAdd:N,onCancel:()=>x(!1),isLoading:f.isPending}),e.jsx(as,{phoneNumbers:l||[],onDelete:u=>_.mutate(u),isDeleting:_.isPending})]})]})},ns=()=>{const{organization:s}=U(),a=Q(),{data:t,isLoading:i,error:n}=D({queryKey:["sms-campaigns",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS campaigns for organization:",s.id);const{data:l,error:o}=await b.from("sms_campaigns").select("*").eq("organization_id",s.id).order("created_at",{ascending:!1});if(o)throw console.error("Error fetching SMS campaigns:",o),o;return console.log("SMS campaigns fetched:",(l==null?void 0:l.length)||0),l||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),{data:d,isLoading:c,error:m}=D({queryKey:["sms-phone-numbers",s==null?void 0:s.id],queryFn:async()=>{if(!(s!=null&&s.id))return[];console.log("Fetching SMS phone numbers for organization:",s.id);const{data:l,error:o}=await b.from("sms_phone_numbers").select("*").eq("organization_id",s.id).eq("status","active");if(o)throw console.error("Error fetching SMS phone numbers:",o),o;return console.log("SMS phone numbers fetched:",(l==null?void 0:l.length)||0),l||[]},enabled:!!(s!=null&&s.id),retry:2,retryDelay:1e3}),g=A({mutationFn:async({name:l,template:o})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!l.trim())throw new Error("Campaign name is required");if(!o.trim())throw new Error("Message template is required");console.log("Creating SMS campaign:",{name:l,template:o,orgId:s.id});const{data:r,error:f}=await b.from("sms_campaigns").insert({organization_id:s.id,name:l.trim(),message_template:o.trim(),total_recipients:(d==null?void 0:d.length)||0}).select().single();if(f)throw console.error("Error creating SMS campaign:",f),f;return console.log("SMS campaign created:",r),r},onSuccess:()=>{h({title:"Campaign created successfully"}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:l=>{console.error("Create campaign error:",l),h({title:"Error creating campaign",description:l.message||"An unexpected error occurred",variant:"destructive"})}}),x=A({mutationFn:async({campaignId:l,isResend:o=!1,isRetry:r=!1})=>{if(!(s!=null&&s.id))throw new Error("Organization not found");if(!d||d.length===0)throw new Error("No active phone numbers found");const f=t==null?void 0:t.find(u=>u.id===l);if(!f)throw new Error("Campaign not found");console.log("Sending SMS campaign:",{campaignId:l,isResend:o,isRetry:r,recipientCount:d.length}),await b.from("sms_campaigns").update({status:"sending",started_at:new Date().toISOString()}).eq("id",l);let _=d.map(u=>u.phone_number);if(o){const{data:u}=await b.from("sms_sends").select("phone_number").eq("campaign_id",l).eq("status","failed");if(u&&u.length>0)_=u.map(y=>y.phone_number);else throw new Error("No failed sends to retry for this campaign")}r&&(_=d.map(u=>u.phone_number));const{data:p,error:N}=await b.functions.invoke("send-sms",{body:{phoneNumbers:_,message:f.message_template,organizationId:s.id,campaignId:l}});if(N)throw console.error("Error sending SMS campaign:",N),new Error(N.message||"Failed to send campaign");return console.log("SMS campaign sent successfully:",p),p},onSuccess:(l,o)=>{let r="Sent";o.isResend&&(r="Resent"),o.isRetry&&(r="Retried"),h({title:`Campaign ${r.toLowerCase()} successfully`,description:`${r} to ${l.summary.sent} recipients`}),a.invalidateQueries({queryKey:["sms-campaigns",s==null?void 0:s.id]})},onError:l=>{console.error("Send campaign error:",l),h({title:"Error sending campaign",description:l.message||"An unexpected error occurred",variant:"destructive"})}});return{campaigns:t||[],campaignsLoading:i,campaignsError:n,phoneNumbers:d||[],phoneNumbersLoading:c,phoneNumbersError:m,createCampaignMutation:g,sendCampaignMutation:x,organization:s}},rs=({onSubmit:s,onCancel:a,isLoading:t,phoneNumbersCount:i,organizationName:n})=>{const[d,c]=v.useState(""),[m,g]=v.useState(""),x=`Hi! We'd love your feedback on our service. Please text back 'START' to begin a quick survey. Your input helps us improve. Thank you! - ${n||"Your Company"}`,l=o=>{o.preventDefault(),!(!d.trim()||!m.trim())&&(s(d,m),c(""),g(""))};return e.jsxs("div",{className:"space-y-4 p-4 border rounded-lg bg-gray-50",children:[e.jsx("h4",{className:"font-medium",children:"Create New Campaign"}),e.jsxs("form",{onSubmit:l,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx(F,{htmlFor:"campaign-name",children:"Campaign Name *"}),e.jsx(E,{id:"campaign-name",value:d,onChange:o=>c(o.target.value),placeholder:"Feedback Request Campaign",required:!0})]}),e.jsxs("div",{children:[e.jsx(F,{htmlFor:"message-template",children:"Message Template *"}),e.jsx(X,{id:"message-template",value:m,onChange:o=>g(o.target.value),placeholder:x,rows:4,required:!0}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-2",children:["Recipients: ",i," active phone numbers"]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(j,{type:"submit",disabled:t,children:"Create Campaign"}),e.jsx(j,{type:"button",variant:"outline",onClick:a,children:"Cancel"})]})]})]})},is=({campaign:s,onSend:a,onResend:t,onRetry:i,isLoading:n})=>{const d=c=>{switch(c){case"completed":return"default";case"sending":return"secondary";case"failed":return"destructive";case"draft":return"outline";default:return"secondary"}};return e.jsxs("div",{className:"p-4 border rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium",children:s.name}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Created ",new Date(s.created_at).toLocaleDateString()]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(R,{variant:d(s.status),children:s.status}),s.status==="draft"&&e.jsxs(j,{size:"sm",onClick:()=>a(s.id),disabled:n,children:[e.jsx(Fe,{className:"w-4 h-4 mr-2"}),"Send Now"]}),s.status==="failed"&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>i(s.id),disabled:n,children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Retry Campaign"]}),s.status==="completed"&&s.failed_count>0&&e.jsxs(j,{size:"sm",variant:"outline",onClick:()=>t(s.id),disabled:n,children:[e.jsx(_e,{className:"w-4 h-4 mr-2"}),"Resend Failed"]})]})]}),e.jsxs("div",{className:"text-sm space-y-2",children:[e.jsxs("div",{className:"p-3 bg-gray-50 rounded border-l-4 border-blue-500",children:[e.jsx("strong",{children:"Message:"}),e.jsx("p",{className:"mt-1",children:s.message_template})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4 mt-3",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.total_recipients}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Recipients"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-green-600",children:s.sent_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sent"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium",children:s.delivered_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Delivered"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"font-medium text-red-600",children:s.failed_count}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Failed"})]})]})]})]})},ls=({campaigns:s,onSend:a,onResend:t,onRetry:i,isLoading:n})=>s.length===0?e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(Me,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No campaigns created yet."}),e.jsx("p",{className:"text-sm",children:"Create your first SMS campaign to get started."})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h4",{className:"font-medium",children:"Your Campaigns"}),s.map(d=>e.jsx(is,{campaign:d,onSend:a,onResend:t,onRetry:i,isLoading:n},d.id))]}),ds=()=>e.jsxs("div",{className:"text-center p-8 text-muted-foreground",children:[e.jsx(B,{className:"w-12 h-12 mx-auto mb-4 opacity-50"}),e.jsx("p",{children:"No active phone numbers found."}),e.jsx("p",{className:"text-sm",children:"Add phone numbers before creating campaigns."})]}),cs=()=>{const[s,a]=v.useState(!1),{campaigns:t,campaignsLoading:i,campaignsError:n,phoneNumbers:d,phoneNumbersLoading:c,phoneNumbersError:m,createCampaignMutation:g,sendCampaignMutation:x,organization:l}=ns(),o=(p,N)=>{g.mutate({name:p,template:N},{onSuccess:()=>{a(!1)}})},r=p=>{x.mutate({campaignId:p})},f=p=>{x.mutate({campaignId:p,isResend:!0})},_=p=>{x.mutate({campaignId:p,isRetry:!0})};return i||c?e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(k,{children:e.jsxs("div",{className:"animate-pulse space-y-4",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-3/4"}),e.jsx("div",{className:"h-20 bg-gray-200 rounded"})]})})]}):n||m?e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns"]})}),e.jsx(k,{children:e.jsxs("div",{className:"flex items-center gap-2 p-4 bg-red-50 rounded-lg",children:[e.jsx(H,{className:"w-5 h-5 text-red-600"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-red-800",children:"Failed to load campaigns or phone numbers"}),e.jsx("p",{className:"text-xs text-red-600 mt-1",children:(n==null?void 0:n.message)||(m==null?void 0:m.message)||"An unexpected error occurred"})]})]})})]}):e.jsxs(w,{children:[e.jsx(S,{children:e.jsxs(C,{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5"}),"SMS Campaigns (",t.length,")"]}),e.jsxs(j,{onClick:()=>a(!0),disabled:d.length===0,children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),"New Campaign"]})]})}),e.jsx(k,{className:"space-y-6",children:d.length===0?e.jsx(ds,{}):e.jsxs(e.Fragment,{children:[s&&e.jsx(rs,{onSubmit:o,onCancel:()=>a(!1),isLoading:g.isPending,phoneNumbersCount:d.length,organizationName:l==null?void 0:l.name}),e.jsx(ls,{campaigns:t,onSend:r,onResend:f,onRetry:_,isLoading:x.isPending})]})})]})},os=()=>e.jsx("div",{className:"mt-6",children:e.jsxs(Ae,{defaultValue:"phone-numbers",className:"w-full",children:[e.jsxs(Pe,{className:"grid w-full grid-cols-2",children:[e.jsx($,{value:"phone-numbers",children:"Phone Numbers"}),e.jsx($,{value:"campaigns",children:"Campaigns"})]}),e.jsx(V,{value:"phone-numbers",className:"mt-6",children:e.jsx(ts,{})}),e.jsx(V,{value:"campaigns",className:"mt-6",children:e.jsx(cs,{})})]})}),ms=()=>{const{organization:s}=U(),a=Q(),{data:t,isLoading:i,error:n}=D({queryKey:["organization-sms-settings",s==null?void 0:s.id],queryFn:async()=>{console.log("Fetching SMS settings for organization:",s==null?void 0:s.id);const{data:c,error:m}=await b.from("organizations").select("sms_enabled, sms_sender_id, sms_settings, webhook_secret").eq("id",s.id).single();if(m)throw console.error("Error fetching organization SMS settings:",m),m;return console.log("Organization SMS settings fetched:",c),c},enabled:!!(s!=null&&s.id),retry:3,retryDelay:1e3}),d=A({mutationFn:async c=>{if(!(s!=null&&s.id))throw new Error("Organization not found");console.log("Updating SMS status:",{enabled:c,orgId:s.id});const{data:m,error:g}=await b.functions.invoke("update-sms-settings",{body:{orgId:s.id,enabled:c,senderId:(t==null?void 0:t.sms_sender_id)||"",username:Y(t==null?void 0:t.sms_settings,"username"),apiKey:Y(t==null?void 0:t.sms_settings,"apiKey")}});if(g)throw console.error("SMS status update error:",g),new Error(g.message||"Failed to update SMS settings");return console.log("SMS status updated successfully:",m),m},onSuccess:()=>{h({title:"SMS status updated successfully"}),a.invalidateQueries({queryKey:["organization-sms-settings",s==null?void 0:s.id]})},onError:c=>{console.error("SMS toggle error:",c),h({title:"Error updating SMS status",description:c.message||"An unexpected error occurred",variant:"destructive"})}});return{orgData:t,isLoading:i,error:n,updateSmsStatus:d,organization:s}},us=()=>{const{isAdmin:s,isOrgAdmin:a}=Z(),[t,i]=v.useState(null),{orgData:n,isLoading:d,error:c,updateSmsStatus:m,organization:g}=ms(),x=s||a,l=r=>{if(!x){h({title:"Access denied",description:"You need admin access to manage SMS settings",variant:"destructive"});return}if(!(g!=null&&g.id)){h({title:"Error",description:"Organization not found",variant:"destructive"});return}m.mutate(r)};if(!x)return e.jsx(Ze,{});if(d)return e.jsx(ze,{});if(c){const r=typeof c=="string"?c:"Failed to load SMS settings";return e.jsx(Xe,{message:r})}const o=(n==null?void 0:n.sms_enabled)&&Ge(n==null?void 0:n.sms_settings);return e.jsxs(w,{children:[e.jsx(Je,{}),e.jsxs(k,{className:"space-y-6",children:[e.jsx(He,{enabled:(n==null?void 0:n.sms_enabled)||!1,onToggle:l,isLoading:m.isPending}),(n==null?void 0:n.sms_enabled)&&e.jsx($e,{webhookSecret:(n==null?void 0:n.webhook_secret)||"",isVisible:!0}),e.jsx(Ve,{providers:We,selectedProvider:t,onProviderSelect:i}),t==="africastalking"&&e.jsx(Qe,{organization:g,currentSettings:n,onSettingsUpdate:()=>{}}),o&&e.jsx(os,{})]})]})},xs=()=>{const{isAdmin:s,isOrgAdmin:a}=Z();return U(),s||a?e.jsxs("div",{className:"space-y-6",children:[e.jsx("h2",{className:"text-2xl font-bold",children:"Integrations"}),e.jsx("p",{className:"text-muted-foreground",children:"Connect your organization to other services and automate your workflows."}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsx(us,{}),e.jsx(Ye,{})]})]}):e.jsxs("div",{className:"text-center p-8",children:[e.jsx("p",{className:"text-gray-500",children:"You need organization admin access to manage integrations."}),e.jsx("p",{className:"text-sm text-gray-400 mt-2",children:"Contact your organization administrator for access."})]})};export{xs as IntegrationsTab,xs as default};
